<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Vertriebspartner (Offline)</title>
  <style>
    :root{
      --bg:#f3f7ff;
      --panel:#ffffff;
      --text:#0b1b33;
      --muted:#51627a;
      --line:rgba(11,27,51,.14);
      --shadow:0 10px 28px rgba(11,27,51,.10);
      --radius:18px;
      --pad:18px;
      --sans: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji";
      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;

      /* default partner theme */
      --pf-main:#1d4ed8;
      --pf-soft:rgba(29,78,216,.12);
      --pf-soft2:rgba(29,78,216,.06);

      --ok:rgba(16,185,129,.18);
      --warn:rgba(245,158,11,.18);
      --bad:rgba(244,63,94,.18);
    }

    body[data-partner="fonds_finanz"]{ --pf-main:#2563eb; --pf-soft:rgba(37,99,235,.14); --pf-soft2:rgba(37,99,235,.08); }
    body[data-partner="demv"]{        --pf-main:#059669; --pf-soft:rgba(5,150,105,.14); --pf-soft2:rgba(5,150,105,.08); }
    body[data-partner="taures"]{      --pf-main:#7c3aed; --pf-soft:rgba(124,58,237,.14); --pf-soft2:rgba(124,58,237,.08); }
    body[data-partner="tvd"]{         --pf-main:#ea580c; --pf-soft:rgba(234,88,12,.14); --pf-soft2:rgba(234,88,12,.08); }
    body[data-partner="wir_finanz"]{  --pf-main:#0f766e; --pf-soft:rgba(15,118,110,.14); --pf-soft2:rgba(15,118,110,.08); }

    *{ box-sizing:border-box; }
    html,body{ height:100%; }
    body{
      margin:0;
      font-family:var(--sans);
      color:var(--text);
      background:
        radial-gradient(1200px 800px at 15% 10%, var(--pf-soft), transparent 55%),
        radial-gradient(1200px 800px at 85% 85%, var(--pf-soft2), transparent 55%),
        linear-gradient(180deg, #eef4ff, var(--bg));
    }

    header{
      position:sticky; top:0; z-index:10;
      background:rgba(243,247,255,.85);
      backdrop-filter:saturate(180%) blur(10px);
      border-bottom:1px solid var(--line);
    }
    .bar{
      max-width:1240px; margin:0 auto;
      padding:14px 18px;
      display:flex; align-items:center; gap:12px;
    }
    .brand{
      display:flex; align-items:baseline; gap:10px; flex:1;
      min-width:260px;
    }
    .brand b{ font-size:18px; }
    .pill{
      display:inline-flex; align-items:center; gap:8px;
      border:1px solid var(--line);
      background:rgba(255,255,255,.7);
      padding:6px 10px;
      border-radius:999px;
      font-size:12px;
      color:var(--muted);
      white-space:nowrap;
    }
    .pill.ok{ background:var(--ok); border-color:rgba(16,185,129,.25); color:#065f46; }
    .pill.warn{ background:var(--warn); border-color:rgba(245,158,11,.25); color:#7c5204; }
    .pill.bad{ background:var(--bad); border-color:rgba(244,63,94,.25); color:#7f1d1d; }

    .tabs{ display:flex; gap:8px; flex-wrap:wrap; }
    .tabBtn{
      border:1px solid var(--line);
      background:rgba(255,255,255,.75);
      padding:8px 12px;
      border-radius:999px;
      cursor:pointer;
      font-weight:600;
      font-size:13px;
    }
    .tabBtn.active{ background:var(--pf-soft); border-color:color-mix(in srgb, var(--pf-main) 30%, var(--line)); color:var(--pf-main); }

    .actions{
      display:flex; gap:8px; flex-wrap:wrap; justify-content:flex-end;
      align-items:center;
    }
    button, .btn{
      border:1px solid var(--line);
      background:rgba(255,255,255,.85);
      padding:9px 12px;
      border-radius:12px;
      cursor:pointer;
      font-weight:600;
      font-size:13px;
      box-shadow:0 1px 0 rgba(11,27,51,.04);
    }
    button.primary{ background:var(--pf-main); color:white; border-color:rgba(0,0,0,.0); }
    button.ghost{ background:rgba(255,255,255,.65); }
    button.danger{ border-color:rgba(244,63,94,.35); color:#b91c1c; background:rgba(255,255,255,.85); }
    button:disabled{ opacity:.55; cursor:not-allowed; }

    .wrap{
      max-width:1240px;
      margin:0 auto;
      padding:16px 18px 28px;
      display:grid;
      grid-template-columns: 380px 1fr; /* linke Seite gr√∂√üer */
      gap:16px;
    }
    @media (max-width: 1020px){
      .wrap{ grid-template-columns:1fr; }
    }

    .card{
      background:rgba(255,255,255,.78);
      border:1px solid var(--line);
      box-shadow:var(--shadow);
      border-radius:var(--radius);
      padding:var(--pad);
    }
    .h{
      font-size:16px;
      font-weight:800;
      margin:0 0 10px;
    }
    .muted{ color:var(--muted); font-size:12px; }
    .divider{ height:1px; background:var(--line); margin:14px 0; }

    .partnerTabs{ display:flex; gap:8px; flex-wrap:wrap; }
    .partnerChip{
      border:1px solid var(--line);
      padding:8px 10px;
      border-radius:999px;
      cursor:pointer;
      background:rgba(255,255,255,.8);
      font-weight:700;
      font-size:13px;
    }
    .partnerChip.active{
      background:var(--pf-soft);
      border-color:color-mix(in srgb, var(--pf-main) 30%, var(--line));
      color:var(--pf-main);
    }

    label{ display:block; font-size:12px; color:var(--muted); margin-bottom:6px; font-weight:700; }
    input, select, textarea{
      width:100%;
      padding:11px 12px;
      border-radius:12px;
      border:1px solid rgba(11,27,51,.18);
      background:rgba(255,255,255,.92);
      outline:none;
      font-size:14px;
      color:var(--text);
    }
    textarea{ min-height:86px; resize:vertical; }
    input:focus, select:focus, textarea:focus{
      border-color:color-mix(in srgb, var(--pf-main) 45%, rgba(11,27,51,.18));
      box-shadow:0 0 0 3px color-mix(in srgb, var(--pf-main) 20%, transparent);
    }

    .row{ display:grid; grid-template-columns: repeat(12, 1fr); gap:10px; }
    .field{ grid-column: span 4; }
    .w12{ grid-column: span 12; }
    .w6{ grid-column: span 6; }
    .w8{ grid-column: span 8; }
    .w4{ grid-column: span 4; }
    .w3{ grid-column: span 3; }
    .w2{ grid-column: span 2; }

    .mini{ font-size:12px; color:var(--muted); line-height:1.35; }
    .small{ font-size:12px; }
    .kpiRow{ display:flex; gap:10px; flex-wrap:wrap; align-items:center; }

    .listRow{
      display:flex; justify-content:space-between; align-items:center;
      gap:10px;
      padding:10px 12px;
      border:1px solid rgba(11,27,51,.12);
      border-radius:14px;
      background:rgba(255,255,255,.7);
      margin-top:8px;
    }
    .listRow b{ font-size:13px; }
    .listRow .meta{ font-size:12px; color:var(--muted); margin-top:3px; }
    .listRow .left{ min-width:0; }
    .listRow .right{ display:flex; gap:8px; flex-wrap:wrap; justify-content:flex-end; }

    .stammdatenBox{
      border:1px solid color-mix(in srgb, var(--pf-main) 28%, rgba(11,27,51,.12));
      background:linear-gradient(180deg, var(--pf-soft2), rgba(255,255,255,.92));
      border-radius:16px;
      padding:14px;
      margin:12px 0;
    }
    .stammdatenTitle{
      display:flex; align-items:center; justify-content:space-between; gap:10px;
      margin-bottom:10px;
    }
    .tag{
      font-size:11px; letter-spacing:.04em;
      text-transform:uppercase;
      padding:5px 10px;
      border-radius:999px;
      background:var(--pf-soft);
      color:var(--pf-main);
      border:1px solid color-mix(in srgb, var(--pf-main) 35%, transparent);
      font-weight:900;
    }

    .copyBtn{
      display:inline-flex; align-items:center; gap:8px;
      padding:8px 10px;
      border-radius:999px;
      border:1px solid rgba(11,27,51,.14);
      background:rgba(255,255,255,.8);
      cursor:pointer;
      font-weight:700;
      font-size:12px;
    }

    .table{
      width:100%;
      border-collapse:separate;
      border-spacing:0;
      overflow:hidden;
      border:1px solid rgba(11,27,51,.14);
      border-radius:14px;
      background:rgba(255,255,255,.78);
    }
    .table th,.table td{
      padding:10px 10px;
      font-size:12px;
      border-bottom:1px solid rgba(11,27,51,.10);
      white-space:nowrap;
    }
    .table th{ text-align:left; color:var(--muted); background:rgba(243,247,255,.8); font-weight:900; }
    .table tr:last-child td{ border-bottom:none; }

    .no-print{}
    @media print{
      header, .no-print{ display:none !important; }
      body{ background:#fff; }
      .wrap{ grid-template-columns:1fr; padding:0; }
      .card{ box-shadow:none; }
    }
  </style>
</head>

<body data-partner="fonds_finanz">
<header class="no-print">
  <div class="bar">
    <div class="brand">
      <b>Vertriebspartner (Offline)</b>
      <span id="statusPill" class="pill">bereit</span>
      <span id="who" class="pill">nicht eingeloggt</span>
    </div>

    <div class="tabs">
      <button class="tabBtn active" id="tabMain">Hauptansicht</button>
      <button class="tabBtn" id="tabStats">Auswertung</button>
    </div>

    <div class="actions">
      <span class="pill">localStorage ¬∑ offline</span>
      <button id="btnPrint">Drucken</button>
      <button id="btnNewField">Neue Felder erstellen</button>
      <button class="danger" id="btnDeleteField">Feld l√∂schen</button>
      <button id="btnExportDelta">Export (Delta heute)</button>
      <button id="btnExportFull">Export (Voll)</button>
      <button id="btnExportCSV">CSV Export</button>
      <button id="btnImport">Import / Merge</button>
      <input id="fileImport" type="file" accept="application/json" multiple style="display:none" />
      <button class="danger" id="btnLogout">Logout</button>
    </div>
  </div>
</header>

<div class="wrap">
  <!-- LEFT -->
  <aside class="card" id="loginCard">
    <div class="h">Login (offline)</div>
    <div class="muted">Diese App speichert lokal im Browser. F√ºr t√§gliches Zusammenf√ºhren bitte Export/Import nutzen.</div>

    <div class="row" style="margin-top:12px;">
      <div class="field w6">
        <label>Benutzer</label>
        <input id="loginUser" list="userList" placeholder="Benutzer eingeben‚Ä¶" autocomplete="username">
        <datalist id="userList">
          <option value="master"></option>
          <option value="user1"></option>
          <option value="user2"></option>
        </datalist>
      </div>
      <div class="field w6">
        <label>Passwort</label>
        <input id="loginPass" type="password" placeholder="Passwort" autocomplete="current-password">
      </div>
    </div>

    <div class="row" style="margin-top:12px;">
      <div class="field w6">
        <button class="primary" id="btnLogin" style="width:100%;">Login</button>
      </div>
      <div class="field w6">
        <button class="ghost" id="btnClearLocal" style="width:100%;">Lokale Daten l√∂schen</button>
      </div>
    </div>

    <div style="margin-top:10px;">
      <span id="loginHint" class="pill">‚Äî</span>
    </div>

    <div class="divider"></div>

    <div class="mini">
      <div><b>Hinweis:</b> Offline-‚ÄûZugriffsschutz‚Äú ist nur so sicher wie das Ger√§t selbst.</div>
      <div>Empfehlung: Ger√§te passwortgesch√ºtzt halten.</div>
      <div style="margin-top:8px;"><b>Passw√∂rter √§ndern:</b> Im Code unten bei <span style="font-family:var(--mono)">USERS</span>.</div>
    </div>
  </aside>

  <aside class="card" id="navCard" style="display:none;">
    <div class="h">Partner</div>
    <div class="partnerTabs" id="partnerTabs"></div>

    <div class="divider"></div>

    <div class="h">Reiter / Datensatz</div>
    <select id="recordSelect"></select>
    <div class="row" style="margin-top:10px;">
      <div class="field w6"><button id="btnNewTab" style="width:100%;">+ Neuer Reiter</button></div>
      <div class="field w6"><button class="danger" id="btnDeleteTab" style="width:100%;">Reiter l√∂schen</button></div>
    </div>

    <div class="divider"></div>

    <div class="h">Suche</div>
    <input id="q" placeholder="Name / Firma / E-Mail / Rolle / MAK / Anlass / Notiz ‚Ä¶"/>
    <div class="row" style="margin-top:10px;">
      <div class="field w6"><button id="btnFind" style="width:100%;">Trefferliste</button></div>
      <div class="field w6"><button class="ghost" id="btnCloseResults" style="width:100%;">Schlie√üen</button></div>
    </div>
    <div class="muted" style="margin-top:6px;">Suche innerhalb der lokal gespeicherten Daten.</div>

    <div class="divider"></div>

    <div class="mini">
      <div><b>Sync-Workflow t√§glich (2 Mitarbeiter):</b></div>
      <ol style="margin:8px 0 0 18px;padding:0;">
        <li>Mitarbeiter: ‚ÄûExport (Delta heute)‚Äú</li>
        <li>Du: ‚ÄûImport / Merge‚Äú (beide Dateien)</li>
        <li>Optional: Du sendest ‚ÄûExport (Voll)‚Äú zur√ºck</li>
      </ol>
    </div>
  </aside>

  <!-- RIGHT -->
  <main class="card" id="mainCard" style="display:none;">
    <div id="viewMain">
      <div class="h">Datensatz</div>
      <div class="muted">Autosave: √Ñnderungen werden sofort lokal gespeichert.</div>

      <div class="row" style="margin-top:12px;">
        <div class="field w6">
          <label>Rolle (frei)</label>
          <input id="rolle" placeholder="z. B. RDPartner / DirektPartner / Account / ‚Ä¶"/>
        </div>
        <div class="field w3" id="makWrap" style="display:none;">
          <label>MAK (nur Fonds/DEMV)</label>
          <input id="mak" placeholder="MAK-Nummer"/>
        </div>
        <div class="field w3">
          <label>Datum (Reiter)</label>
          <input id="datum" type="date"/>
        </div>
      </div>

      <div class="stammdatenBox">
        <div class="stammdatenTitle">
          <div class="tag">Stammdaten</div>
          <div class="small muted">Name ¬∑ Firma ¬∑ E-Mail ¬∑ Tel/Mobil ¬∑ Adresse</div>
        </div>

        <div class="row">
          <div class="field w6"><label>Name</label><input id="name"/></div>
          <div class="field w6"><label>Firma</label><input id="firma"/></div>
          <div class="field w12"><label>E-Mail</label><input id="email" type="email"/></div>
        </div>

        <div class="row" style="margin-top:10px;">
          <div class="field w6"><label>Mobil</label><input id="mobil" type="tel"/></div>
          <div class="field w6"><label>Telefon</label><input id="telefon" type="tel"/></div>
        </div>

        <div class="row" style="margin-top:10px;">
          <div class="field w6"><label>Stra√üe</label><input id="strasse"/></div>
          <div class="field w2"><label>PLZ</label><input id="plz"/></div>
          <div class="field w4"><label>Ort</label><input id="ort"/></div>
        </div>

        <div class="row" style="margin-top:10px;">
          <div class="field w3"><label>Land</label><input id="land"/></div>
          <div class="field w6">
            <label>Adresse kopieren</label>
            <button class="copyBtn" id="btnCopyAddr" type="button">üìç kopieren</button>
          </div>
          <div class="field w3">
            <label>Tel/Mobil kopieren</label>
            <button class="copyBtn" id="btnCopyPhone" type="button">üìû kopieren</button>
          </div>
        </div>

        <div class="row" style="margin-top:10px;">
          <div class="field w6">
            <label>E-Mail</label>
            <button class="copyBtn" id="btnMail" type="button">‚úâÔ∏è E-Mail</button>
          </div>
          <div class="field w6">
            <label>Anrufen</label>
            <button class="copyBtn" id="btnCall" type="button">üìû Anrufen</button>
          </div>
        </div>
      </div>

      <div class="row" style="margin-top:10px;">
        <div class="field w6">
          <label>Optin</label>
          <select id="optin">
            <option value="false">Nein</option>
            <option value="true">Ja</option>
          </select>
        </div>
        <div class="field w6">
          <label>Online Abschluss</label>
          <select id="online">
            <option value="false">Nein</option>
            <option value="true">Ja</option>
          </select>
        </div>
      </div>

      <div class="divider"></div>

      <div class="h">Produktion (Jahreswerte ‚Ç¨)</div>
      <div class="muted">Diese Werte sind pro Jahr. In der Auswertung werden sie (optional) auf Monate verteilt dargestellt.</div>

      <div class="row" style="margin-top:12px;">
        <div class="field w3"><label>Prod Voll</label><input id="prodVoll" inputmode="decimal" placeholder="‚Ç¨"/></div>
        <div class="field w3"><label>Ziel Voll</label><input id="zielVoll" inputmode="decimal" placeholder="‚Ç¨"/></div>
        <div class="field w3"><label>Prod Beihilfe</label><input id="prodBeihilfe" inputmode="decimal" placeholder="‚Ç¨"/></div>
        <div class="field w3"><label>Ziel Beihilfe</label><input id="zielBeihilfe" inputmode="decimal" placeholder="‚Ç¨"/></div>
      </div>

      <div class="row" style="margin-top:10px;">
        <div class="field w3"><label>Prod Zusatz</label><input id="prodZusatz" inputmode="decimal" placeholder="‚Ç¨"/></div>
        <div class="field w3"><label>Ziel Zusatz</label><input id="zielZusatz" inputmode="decimal" placeholder="‚Ç¨"/></div>
        <div class="field w3"><label>Prod bKV</label><input id="prodBkv" inputmode="decimal" placeholder="‚Ç¨"/></div>
        <div class="field w3"><label>Ziel bKV</label><input id="zielBkv" inputmode="decimal" placeholder="‚Ç¨"/></div>
      </div>

      <div class="divider"></div>

      <div class="h">Kontakt-Historie (Kontakt 1, 2, 3 ‚Ä¶ inkl. Wiedervorlage)</div>
      <div class="muted">Jeder Kontakt kann ein Follow-up (Wiedervorlage) haben. Diese erscheinen auch in der Gesamt-√úbersicht (Auswertung).</div>

      <div id="kontakteHost" style="margin-top:10px;"></div>
      <div class="row" style="margin-top:10px;">
        <div class="field w6"><button id="btnAddKontakt" class="ghost" style="width:100%;">+ Kontakt hinzuf√ºgen</button></div>
        <div class="field w6"><button id="btnMarkAllDone" class="ghost" style="width:100%;">Alle Wiedervorlagen erledigt</button></div>
      </div>

      <div class="divider"></div>

      <div class="h">Freies Feld</div>
      <textarea id="freiesFeld" placeholder="Notizen ‚Ä¶"></textarea>

      <div id="customFieldsHost"></div>
    </div>

    <div id="viewStats" style="display:none;">
      <div class="h">Auswertung</div>
      <div class="muted">Jahresauswertung (Monat) + Gesamtproduktion (Jahr) Ziel/Ist (‚Ç¨) + Gesamt-Wiedervorlagen √ºber alle Partner.</div>

      <div class="divider"></div>

      <div class="h">Wiedervorlagen ‚Äì alle Partner</div>
      <div class="muted">Offene Wiedervorlagen √ºber alle Partner & Reiter. Klick auf ‚Äû√ñffnen‚Äú springt in den Datensatz.</div>
      <div id="followUpAllHost" style="margin-top:10px;"></div>

      <div class="divider"></div>

      <div class="row">
        <div class="field w6">
          <label>Partner (Auswertung)</label>
          <select id="statsPartner"></select>
        </div>
        <div class="field w6">
          <label>Jahr</label>
          <select id="statsYear"></select>
        </div>
      </div>

      <div class="divider"></div>

      <div class="h">Gesamtproduktion (Jahr) ‚Äì manuell</div>
      <div class="muted">Diese Werte √ºberschreibst du manuell (Ziel/Ist). Pro Partner & Jahr gespeichert.</div>

      <div class="row" style="margin-top:10px;">
        <div class="field w6"><label>Gesamt Ziel</label><input id="gesamtZiel" inputmode="decimal" placeholder="‚Ç¨"/></div>
        <div class="field w6"><label>Gesamt Ist</label><input id="gesamtIst" inputmode="decimal" placeholder="‚Ç¨"/></div>
      </div>

      <div class="row" style="margin-top:10px;">
        <div class="field w3"><label>Voll Ziel</label><input id="vollZiel" inputmode="decimal" placeholder="‚Ç¨"/></div>
        <div class="field w3"><label>Voll Ist</label><input id="vollIst" inputmode="decimal" placeholder="‚Ç¨"/></div>
        <div class="field w3"><label>Beihilfe Ziel</label><input id="beihilfeZiel" inputmode="decimal" placeholder="‚Ç¨"/></div>
        <div class="field w3"><label>Beihilfe Ist</label><input id="beihilfeIst" inputmode="decimal" placeholder="‚Ç¨"/></div>
      </div>

      <div class="row" style="margin-top:10px;">
        <div class="field w3"><label>Zusatz Ziel</label><input id="zusatzZiel" inputmode="decimal" placeholder="‚Ç¨"/></div>
        <div class="field w3"><label>Zusatz Ist</label><input id="zusatzIst" inputmode="decimal" placeholder="‚Ç¨"/></div>
        <div class="field w3"><label>bKV Ziel</label><input id="bkvZiel" inputmode="decimal" placeholder="‚Ç¨"/></div>
        <div class="field w3"><label>bKV Ist</label><input id="bkvIst" inputmode="decimal" placeholder="‚Ç¨"/></div>
      </div>

      <div class="divider"></div>

      <div class="h">Jahresauswertung (Monat)</div>
      <div class="muted">Basis: Datens√§tze/Reiter des gew√§hlten Partners. Jahreswerte werden gleichm√§√üig auf 12 Monate verteilt (damit du eine Monats√ºbersicht bekommst).</div>

      <div style="overflow:auto;">
        <table class="table" id="monthTable">
          <thead>
            <tr>
              <th>Monat</th>
              <th>Prod Voll</th><th>Ziel Voll</th>
              <th>Prod Beihilfe</th><th>Ziel Beihilfe</th>
              <th>Prod Zusatz</th><th>Ziel Zusatz</th>
              <th>Prod bKV</th><th>Ziel bKV</th>
              <th>Gesamt Prod</th><th>Gesamt Ziel</th>
            </tr>
          </thead>
          <tbody id="monthTBody"></tbody>
        </table>
      </div>

      <div class="row no-print" style="margin-top:12px;">
        <div class="field w6"><button id="btnStatsCsv">CSV Export (Auswertung)</button></div>
        <div class="field w6"><button id="btnStatsPrint">Drucken (Auswertung)</button></div>
      </div>
    </div>
  </main>
</div>

<!-- Trefferliste -->
<div class="wrap no-print" id="resultsWrap" style="display:none;">
  <div class="card" style="grid-column: 1 / -1;">
    <div class="h">Trefferliste</div>
    <div class="muted">Klicke auf einen Treffer, um direkt zu Partner & Datensatz zu springen.</div>
    <div id="resultsHost" style="margin-top:10px;"></div>
  </div>
</div>

<script>
(() => {
  "use strict";

  // =======================
  // Konfiguration
  // =======================
  // √Ñndere hier Benutzer/Passw√∂rter:
  const USERS = [
    { user:"master", pass:"master123", role:"master" },
    { user:"user1",  pass:"user123",   role:"staff"  },
    { user:"user2",  pass:"user123",   role:"staff"  }
  ];

  const PARTNERS = [
    { key:"fonds_finanz", name:"Fonds Finanz", hasMak:true },
    { key:"demv",        name:"DEMV",         hasMak:true },
    { key:"taures",      name:"Taures",       hasMak:false },
    { key:"tvd",         name:"TVD",          hasMak:false },
    { key:"wir_finanz",  name:"WIR-Finanz",   hasMak:false }
  ];

  // Adresse Autofill: Firma -> Adresse
  const ADDRESS_BOOK = [
    {
      match: /fonds\s*finanz\s*maklerservice\s*gmbh/i,
      strasse:"Riesstra√üe 25",
      plz:"80992",
      ort:"M√ºnchen",
      land:"DE"
    }
  ];

  // Storage Keys
  const STORAGE_KEY = "vp_offline_db_v2";
  const SESSION_KEY = "vp_offline_user_v1";

  // =======================
  // Helpers
  // =======================
  const $ = (id) => document.getElementById(id);

  const nowISO = () => new Date().toISOString();
  const todayISO = () => new Date().toISOString().slice(0,10);
  const currentYear = () => new Date().getFullYear();

  function safeJSONParse(s){
    try { return JSON.parse(s); } catch(e){ return null; }
  }

  function escapeHtml(s){
    return String(s ?? "").replace(/[&<>"']/g, m => ({
      "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;"
    }[m]));
  }

  function moneyParse(v){
    if (v === null || v === undefined) return 0;
    const s = String(v).trim();
    if (!s) return 0;
    // allow "12.345,67" or "12345.67"
    const norm = s.replace(/\./g,"").replace(",",".").replace(/[^\d.-]/g,"");
    const n = Number(norm);
    return Number.isFinite(n) ? n : 0;
  }

  function moneyFormat(n){
    if (!Number.isFinite(n)) return "";
    return n.toLocaleString("de-DE", { minimumFractionDigits: 0, maximumFractionDigits: 0 });
  }

  function uid(){
    return Math.random().toString(36).slice(2,10) + "-" + Date.now().toString(36);
  }

  function setStatus(text, kind){
    const pill = $("statusPill");
    pill.textContent = text;
    pill.className = "pill" + (kind ? (" " + kind) : "");
  }

  // =======================
  // Session
  // =======================
  function getSession(){
    const raw = localStorage.getItem(SESSION_KEY);
    return raw ? safeJSONParse(raw) : null;
  }
  function setSession(session){
    if (!session) localStorage.removeItem(SESSION_KEY);
    else localStorage.setItem(SESSION_KEY, JSON.stringify(session));
    renderAll();
  }
  function sessionUserSafe(){
    const s = getSession();
    return (s && s.user) ? s.user : "unknown";
  }

  // =======================
  // DB
  // =======================
  function emptyPartnerState(){
    return {
      records: [],
      activeRecordId: null,
      customFields: [],     // {id,label,type}
      yearStats: {}         // { [year]: {gesamtZiel,gesamtIst, vollZiel,vollIst, ...} }
    };
  }

  function defaultDB(){
    const partners = {};
    PARTNERS.forEach(p => partners[p.key] = emptyPartnerState());
    return {
      version: 2,
      createdAt: nowISO(),
      updatedAt: nowISO(),
      activePartnerKey: PARTNERS[0].key,
      partners
    };
  }

  function loadDB(){
    const raw = localStorage.getItem(STORAGE_KEY);
    const parsed = raw ? safeJSONParse(raw) : null;
    if (!parsed || !parsed.partners) {
      const db = defaultDB();
      localStorage.setItem(STORAGE_KEY, JSON.stringify(db));
      return db;
    }

    // Migrations / Ensure keys
    PARTNERS.forEach(p => {
      if (!parsed.partners[p.key]) parsed.partners[p.key] = emptyPartnerState();
      const ps = parsed.partners[p.key];
      ps.records ||= [];
      ps.customFields ||= [];
      ps.yearStats ||= {};
      ps.activeRecordId ||= (ps.records[0]?.id || null);

      // Ensure record schema
      ps.records.forEach(r => {
        r.id ||= uid();
        r.createdAt ||= nowISO();
        r.updatedAt ||= r.createdAt;
        r.updatedBy ||= "unknown";
        r.partnerKey ||= p.key;

        r.rolle ||= "";
        r.makNummer ??= (p.hasMak ? "" : undefined);
        r.datum ||= todayISO();

        r.name ||= ""; r.firma ||= ""; r.email ||= "";
        r.mobil ||= ""; r.telefon ||= "";
        r.strasse ||= ""; r.plz ||= ""; r.ort ||= ""; r.land ||= "DE";

        r.optin ??= false;
        r.onlineAbschluss ??= false;

        r.prodVoll ??= ""; r.zielVoll ??= "";
        r.prodBeihilfe ??= ""; r.zielBeihilfe ??= "";
        r.prodZusatz ??= ""; r.zielZusatz ??= "";
        r.prodBkv ??= ""; r.zielBkv ??= "";

        r.freiesFeld ??= "";
        r.custom ||= {};

        if (!Array.isArray(r.kontakte)) r.kontakte = [];
        if (!r.kontakte.length){
          r.kontakte.push({
            id: uid(),
            datum: todayISO(),
            anlass: "",
            notiz: "",
            followUpDatum: "",
            followUpThema: "",
            followUpErledigt: false,
            createdAt: nowISO(),
            updatedAt: nowISO()
          });
        }
      });
    });

    parsed.activePartnerKey ||= PARTNERS[0].key;
    parsed.updatedAt ||= nowISO();
    return parsed;
  }

  let DB = loadDB();

  function saveDB(){
    DB.updatedAt = nowISO();
    localStorage.setItem(STORAGE_KEY, JSON.stringify(DB));
  }

  function partnerByKey(key){
    return PARTNERS.find(p => p.key === key) || PARTNERS[0];
  }

  function getPartnerState(key){
    return DB.partners[key];
  }

  function getActivePartner(){
    return partnerByKey(DB.activePartnerKey);
  }

  function getActivePartnerState(){
    return getPartnerState(DB.activePartnerKey);
  }

  function getActiveRecord(){
    const ps = getActivePartnerState();
    const id = ps.activeRecordId;
    if (!id) return null;
    return ps.records.find(r => r.id === id) || null;
  }

  function touchRecord(r){
    r.updatedAt = nowISO();
    r.updatedBy = sessionUserSafe();
    saveDB();
  }

  function ensureOneRecord(){
    const p = getActivePartner();
    const ps = getActivePartnerState();
    if (!ps.records.length){
      const r = baseRecord(p);
      ps.records.push(r);
      ps.activeRecordId = r.id;
      saveDB();
    }
    if (!ps.activeRecordId) ps.activeRecordId = ps.records[0].id;
  }

  function baseRecord(partner){
    return {
      id: uid(),
      createdAt: nowISO(),
      updatedAt: nowISO(),
      updatedBy: sessionUserSafe(),
      partnerKey: partner.key,

      rolle: "",
      makNummer: partner.hasMak ? "" : undefined,
      datum: todayISO(),

      name:"",
      firma:"",
      email:"",
      mobil:"",
      telefon:"",
      strasse:"",
      plz:"",
      ort:"",
      land:"DE",

      optin:false,
      onlineAbschluss:false,

      prodVoll:"", zielVoll:"",
      prodBeihilfe:"", zielBeihilfe:"",
      prodZusatz:"", zielZusatz:"",
      prodBkv:"", zielBkv:"",

      freiesFeld:"",
      kontakte: [{
        id: uid(),
        datum: todayISO(),
        anlass:"",
        notiz:"",
        followUpDatum:"",
        followUpThema:"",
        followUpErledigt:false,
        createdAt: nowISO(),
        updatedAt: nowISO()
      }],
      custom: {}
    };
  }

  // =======================
  // Address Autofill
  // =======================
  function applyAddressAutofillFromFirma(r){
    const firma = (r.firma || "").trim();
    if (!firma) return false;
    for (const a of ADDRESS_BOOK){
      if (a.match.test(firma)){
        if (!r.strasse) r.strasse = a.strasse;
        if (!r.plz) r.plz = a.plz;
        if (!r.ort) r.ort = a.ort;
        if (!r.land) r.land = a.land;
        return true;
      }
    }
    return false;
  }

  // =======================
  // Record label (Dropdown)
  // =======================
  function recordLabel(partnerKey, r, idx){
    const role = (r.rolle || "").trim() || "ohne Rolle";
    const p = partnerByKey(partnerKey);
    const mak = p.hasMak && r.makNummer ? ` ¬∑ MAK ${r.makNummer}` : "";
    return `Reiter ${idx+1} ¬∑ ${role}${mak}`;
  }

  // =======================
  // Login UI
  // =======================
  function initLoginUI(){
    $("btnLogin").onclick = () => {
      const user = ($("loginUser").value || "").trim();
      const pass = ($("loginPass").value || "");
      const found = USERS.find(u => u.user === user && u.pass === pass);
      if (!found){
        $("loginHint").textContent = "Login fehlgeschlagen";
        $("loginHint").className = "pill bad";
        return;
      }
      setSession({ user: found.user, role: found.role, loginAt: nowISO() });
      $("loginPass").value = "";
      $("loginHint").textContent = "OK";
      $("loginHint").className = "pill ok";
    };

    $("btnClearLocal").onclick = () => {
      if (!confirm("Wirklich ALLE lokalen Daten (inkl. Datens√§tze) l√∂schen?")) return;
      localStorage.removeItem(STORAGE_KEY);
      DB = defaultDB();
      saveDB();
      renderAll();
      alert("Lokale Daten gel√∂scht.");
    };
  }

  // =======================
  // Bindings
  // =======================
  function bindAllInputs(){
    $("btnPrint").onclick = () => window.print();

    $("btnLogout").onclick = () => setSession(null);

    $("btnNewTab").onclick = () => addRecord();
    $("btnDeleteTab").onclick = () => deleteRecord();

    $("recordSelect").onchange = (e) => {
      const ps = getActivePartnerState();
      ps.activeRecordId = e.target.value;
      saveDB();
      renderAll();
    };

    $("btnNewField").onclick = () => addCustomField();
    $("btnDeleteField").onclick = () => deleteCustomField();

    $("btnExportFull").onclick = () => exportFull();
    $("btnExportDelta").onclick = () => exportDelta();
    $("btnExportCSV").onclick = () => exportCSV();

    $("btnImport").onclick = () => $("fileImport").click();
    $("fileImport").onchange = (e) => {
      importFiles(e.target.files);
      e.target.value = "";
    };

    $("btnFind").onclick = () => showResults();
    $("btnCloseResults").onclick = () => { $("resultsWrap").style.display = "none"; };

    $("tabMain").onclick = () => showPage("main");
    $("tabStats").onclick = () => showPage("stats");

    $("btnStatsPrint").onclick = () => window.print();
    $("btnStatsCsv").onclick = () => exportStatsCSV();
  }

  // =======================
  // Pages
  // =======================
  let ACTIVE_PAGE = "main";
  function showPage(which){
    ACTIVE_PAGE = which;
    renderAll();
  }

  // =======================
  // Partner tabs
  // =======================
  function renderPartnerTabs(){
    const host = $("partnerTabs");
    host.innerHTML = "";
    PARTNERS.forEach(p => {
      const btn = document.createElement("button");
      btn.className = "partnerChip" + (p.key === DB.activePartnerKey ? " active" : "");
      btn.textContent = p.name;
      btn.onclick = () => {
        DB.activePartnerKey = p.key;
        document.body.setAttribute("data-partner", p.key);
        ensureOneRecord();
        saveDB();
        renderAll();
      };
      host.appendChild(btn);
    });

    document.body.setAttribute("data-partner", DB.activePartnerKey);
  }

  // =======================
  // Record dropdown
  // =======================
  function renderRecordSelect(){
    const ps = getActivePartnerState();
    const sel = $("recordSelect");
    sel.innerHTML = "";
    ps.records.forEach((r, idx) => {
      const opt = document.createElement("option");
      opt.value = r.id;
      opt.textContent = recordLabel(DB.activePartnerKey, r, idx);
      sel.appendChild(opt);
    });
    if (ps.activeRecordId) sel.value = ps.activeRecordId;
  }

  // =======================
  // Form render + autosave
  // =======================
  function setField(id, value){
    const el = $(id);
    if (!el) return;
    if (el.type === "checkbox") el.checked = !!value;
    else el.value = value ?? "";
  }

  function getFieldValue(el){
    if (!el) return "";
    if (el.type === "checkbox") return !!el.checked;
    return el.value;
  }

  function renderForm(){
    const p = getActivePartner();
    const r = getActiveRecord();
    if (!r) return;

    $("makWrap").style.display = p.hasMak ? "" : "none";

    setField("rolle", r.rolle);
    setField("mak", p.hasMak ? (r.makNummer || "") : "");
    setField("datum", r.datum || todayISO());

    setField("name", r.name);
    setField("firma", r.firma);
    setField("email", r.email);

    setField("mobil", r.mobil);
    setField("telefon", r.telefon);

    setField("strasse", r.strasse);
    setField("plz", r.plz);
    setField("ort", r.ort);
    setField("land", r.land);

    $("optin").value = String(!!r.optin);
    $("online").value = String(!!r.onlineAbschluss);

    setField("prodVoll", r.prodVoll);
    setField("zielVoll", r.zielVoll);
    setField("prodBeihilfe", r.prodBeihilfe);
    setField("zielBeihilfe", r.zielBeihilfe);
    setField("prodZusatz", r.prodZusatz);
    setField("zielZusatz", r.zielZusatz);
    setField("prodBkv", r.prodBkv);
    setField("zielBkv", r.zielBkv);

    setField("freiesFeld", r.freiesFeld);

    // Copy actions
    $("btnCopyAddr").onclick = async () => {
      const addr = [r.firma, r.strasse, (r.plz ? (r.plz + " ") : "") + r.ort, r.land].filter(Boolean).join("\n");
      await navigator.clipboard.writeText(addr);
      setStatus("Adresse kopiert", "ok");
      setTimeout(()=>setStatus("bereit",""), 900);
    };
    $("btnCopyPhone").onclick = async () => {
      const txt = ["Mobil: " + (r.mobil||""), "Telefon: " + (r.telefon||"")].join("\n");
      await navigator.clipboard.writeText(txt);
      setStatus("Telefon kopiert", "ok");
      setTimeout(()=>setStatus("bereit",""), 900);
    };
    $("btnMail").onclick = () => {
      const email = (r.email || "").trim();
      if (!email) return alert("Keine E-Mail eingetragen.");
      window.location.href = `mailto:${encodeURIComponent(email)}`;
    };
    $("btnCall").onclick = () => {
      const tel = (r.mobil || r.telefon || "").trim();
      if (!tel) return alert("Keine Telefonnummer eingetragen.");
      window.location.href = `tel:${encodeURIComponent(tel)}`;
    };

    // Wire autosave
    const wire = (id, setter) => {
      const el = $(id);
      if (!el) return;
      el.oninput = () => {
        setter(getFieldValue(el));
        touchRecord(r);
        if (id === "firma"){
          const filled = applyAddressAutofillFromFirma(r);
          touchRecord(r);
          if (filled) renderForm(); // refresh address fields
        }
        renderStats(); // keep stats in sync
      };
      el.onchange = el.oninput;
    };

    wire("rolle", v => r.rolle = v);
    if (p.hasMak) wire("mak", v => r.makNummer = v);
    wire("datum", v => r.datum = v);

    wire("name", v => r.name = v);
    wire("firma", v => r.firma = v);
    wire("email", v => r.email = v);

    wire("mobil", v => r.mobil = v);
    wire("telefon", v => r.telefon = v);

    wire("strasse", v => r.strasse = v);
    wire("plz", v => r.plz = v);
    wire("ort", v => r.ort = v);
    wire("land", v => r.land = v);

    $("optin").onchange = () => { r.optin = ($("optin").value === "true"); touchRecord(r); renderStats(); };
    $("online").onchange = () => { r.onlineAbschluss = ($("online").value === "true"); touchRecord(r); };

    wire("prodVoll", v => r.prodVoll = v);
    wire("zielVoll", v => r.zielVoll = v);
    wire("prodBeihilfe", v => r.prodBeihilfe = v);
    wire("zielBeihilfe", v => r.zielBeihilfe = v);
    wire("prodZusatz", v => r.prodZusatz = v);
    wire("zielZusatz", v => r.zielZusatz = v);
    wire("prodBkv", v => r.prodBkv = v);
    wire("zielBkv", v => r.zielBkv = v);

    wire("freiesFeld", v => r.freiesFeld = v);

    renderKontakte();
    renderCustomFields();
  }

  // =======================
  // Kontakte + Wiedervorlage
  // =======================
  function renderKontakte(){
    const r = getActiveRecord();
    if (!r) return;

    const host = $("kontakteHost");
    host.innerHTML = "";

    r.kontakte.forEach((k, idx) => {
      const row = document.createElement("div");
      row.className = "card";
      row.style.boxShadow = "none";
      row.style.background = "rgba(255,255,255,.72)";
      row.style.marginTop = "10px";
      row.style.borderRadius = "16px";
      row.style.padding = "14px";

      row.innerHTML = `
        <div class="kpiRow" style="justify-content:space-between;">
          <div><b>Kontakt ${idx+1}</b> <span class="muted">(${escapeHtml(k.datum || "")})</span></div>
          <div style="display:flex; gap:8px; flex-wrap:wrap;">
            <button class="ghost" data-act="addFollowUp">Wiedervorlage setzen</button>
            <button class="ghost" data-act="toggleDone">${k.followUpErledigt ? "Wiedervorlage √∂ffnen" : "Wiedervorlage erledigt"}</button>
            <button class="danger" data-act="delKontakt">Kontakt l√∂schen</button>
          </div>
        </div>

        <div class="row" style="margin-top:10px;">
          <div class="field w3">
            <label>Kontakt-Datum</label>
            <input type="date" data-k="datum" value="${escapeHtml(k.datum || todayISO())}">
          </div>
          <div class="field w9">
            <label>Anlass</label>
            <input data-k="anlass" value="${escapeHtml(k.anlass || "")}" placeholder="z. B. Abstimmung / Termin / Anfrage ‚Ä¶">
          </div>
        </div>

        <div class="row" style="margin-top:10px;">
          <div class="field w12">
            <label>Notiz</label>
            <textarea data-k="notiz" placeholder="Gespr√§chsnotiz ‚Ä¶">${escapeHtml(k.notiz || "")}</textarea>
          </div>
        </div>

        <div class="divider"></div>

        <div class="row">
          <div class="field w3">
            <label>Wiedervorlage Datum</label>
            <input type="date" data-k="followUpDatum" value="${escapeHtml(k.followUpDatum || "")}">
          </div>
          <div class="field w7">
            <label>Wiedervorlage Thema</label>
            <input data-k="followUpThema" value="${escapeHtml(k.followUpThema || "")}" placeholder="Worum geht‚Äôs?">
          </div>
          <div class="field w2">
            <label>Erledigt</label>
            <select data-k="followUpErledigt">
              <option value="false"${k.followUpErledigt ? "" : " selected"}>offen</option>
              <option value="true"${k.followUpErledigt ? " selected" : ""}>erledigt</option>
            </select>
          </div>
        </div>
      `;

      row.querySelectorAll("[data-k]").forEach(el => {
        const key = el.getAttribute("data-k");
        el.oninput = () => {
          if (key === "followUpErledigt"){
            k.followUpErledigt = (el.value === "true");
          } else {
            k[key] = el.value;
          }
          k.updatedAt = nowISO();
          touchRecord(r);
          renderStats();
          renderFollowUpOverviewAllPartners();
        };
        el.onchange = el.oninput;
      });

      row.querySelectorAll("button[data-act]").forEach(btn => {
        btn.onclick = () => {
          const act = btn.getAttribute("data-act");
          if (act === "delKontakt"){
            if (!confirm("Kontakt wirklich l√∂schen?")) return;
            r.kontakte.splice(idx, 1);
            if (!r.kontakte.length){
              r.kontakte.push({
                id: uid(), datum: todayISO(), anlass:"", notiz:"",
                followUpDatum:"", followUpThema:"", followUpErledigt:false,
                createdAt: nowISO(), updatedAt: nowISO()
              });
            }
            touchRecord(r);
            renderKontakte();
            renderStats();
            renderFollowUpOverviewAllPartners();
          }
          if (act === "toggleDone"){
            k.followUpErledigt = !k.followUpErledigt;
            k.updatedAt = nowISO();
            touchRecord(r);
            renderKontakte();
            renderStats();
            renderFollowUpOverviewAllPartners();
          }
          if (act === "addFollowUp"){
            if (!k.followUpDatum) k.followUpDatum = todayISO();
            if (!k.followUpThema) k.followUpThema = "Wiedervorlage";
            k.followUpErledigt = false;
            k.updatedAt = nowISO();
            touchRecord(r);
            renderKontakte();
            renderStats();
            renderFollowUpOverviewAllPartners();
          }
        };
      });

      host.appendChild(row);
    });

    $("btnAddKontakt").onclick = () => {
      r.kontakte.push({
        id: uid(),
        datum: todayISO(),
        anlass:"",
        notiz:"",
        followUpDatum:"",
        followUpThema:"",
        followUpErledigt:false,
        createdAt: nowISO(),
        updatedAt: nowISO()
      });
      touchRecord(r);
      renderKontakte();
      renderFollowUpOverviewAllPartners();
    };

    $("btnMarkAllDone").onclick = () => {
      r.kontakte.forEach(k => k.followUpErledigt = true);
      touchRecord(r);
      renderKontakte();
      renderFollowUpOverviewAllPartners();
    };
  }

  // =======================
  // Custom fields
  // =======================
  function renderCustomFields(){
    const ps = getActivePartnerState();
    const r = getActiveRecord();
    const host = $("customFieldsHost");
    host.innerHTML = "";

    if (!ps.customFields.length) return;

    const h = document.createElement("div");
    h.className = "divider";
    host.appendChild(h);

    const title = document.createElement("div");
    title.className = "h";
    title.textContent = "Zusatzfelder (Custom)";
    host.appendChild(title);

    ps.customFields.forEach(cf => {
      const wrap = document.createElement("div");
      wrap.className = "row";
      wrap.style.marginTop = "10px";

      const field = document.createElement("div");
      field.className = "field w12";

      const lab = document.createElement("label");
      lab.textContent = cf.label;
      field.appendChild(lab);

      let el;
      if (cf.type === "textarea"){
        el = document.createElement("textarea");
        el.value = r.custom[cf.id] ?? "";
      } else if (cf.type === "checkbox"){
        el = document.createElement("select");
        el.innerHTML = `<option value="false">Nein</option><option value="true">Ja</option>`;
        el.value = String(!!r.custom[cf.id]);
      } else {
        el = document.createElement("input");
        el.value = r.custom[cf.id] ?? "";
      }

      el.oninput = () => {
        r.custom[cf.id] = (cf.type === "checkbox") ? (el.value === "true") : el.value;
        touchRecord(r);
      };
      el.onchange = el.oninput;

      field.appendChild(el);
      wrap.appendChild(field);
      host.appendChild(wrap);
    });
  }

  function addCustomField(){
    const ps = getActivePartnerState();
    const label = prompt("Feldname (z. B. 'bKV Ansprechpartner'):");
    if (!label) return;
    const type = prompt("Feldtyp: text | textarea | checkbox", "text");
    const t = (type || "text").toLowerCase();
    if (!["text","textarea","checkbox"].includes(t)){
      alert("Ung√ºltiger Feldtyp.");
      return;
    }
    const id = "cf_" + uid();
    ps.customFields.push({ id, label, type: t });
    // initialize for existing records
    ps.records.forEach(r => { r.custom ||= {}; if (!(id in r.custom)) r.custom[id] = (t==="checkbox"?false:""); touchRecord(r); });
    saveDB();
    renderAll();
  }

  function deleteCustomField(){
    const ps = getActivePartnerState();
    if (!ps.customFields.length) return alert("Keine Zusatzfelder vorhanden.");
    const list = ps.customFields.map((f,i)=>`${i+1}: ${f.label} (${f.type})`).join("\n");
    const pick = prompt("Welches Feld l√∂schen? Nummer eingeben:\n\n" + list);
    const idx = Number(pick) - 1;
    if (!Number.isInteger(idx) || idx < 0 || idx >= ps.customFields.length) return;

    const cf = ps.customFields[idx];
    if (!confirm(`Feld "${cf.label}" wirklich l√∂schen? Werte in allen Datens√§tzen werden entfernt.`)) return;

    ps.customFields.splice(idx,1);
    ps.records.forEach(r => { if (r.custom) delete r.custom[cf.id]; touchRecord(r); });
    saveDB();
    renderAll();
  }

  // =======================
  // Records add/delete
  // =======================
  function addRecord(){
    const p = getActivePartner();
    const ps = getActivePartnerState();
    const r = baseRecord(p);
    ps.records.push(r);
    ps.activeRecordId = r.id;
    saveDB();
    renderAll();
  }

  function deleteRecord(){
    const ps = getActivePartnerState();
    if (ps.records.length <= 1) return alert("Mindestens 1 Reiter muss bestehen bleiben.");
    const r = getActiveRecord();
    if (!r) return;

    if (!confirm("Diesen Reiter/Datensatz wirklich l√∂schen?")) return;

    const idx = ps.records.findIndex(x => x.id === r.id);
    if (idx >= 0) ps.records.splice(idx,1);
    ps.activeRecordId = ps.records[Math.max(0, idx-1)].id;
    saveDB();
    renderAll();
  }

  // =======================
  // Search / results
  // =======================
  function recordSearchText(partnerName, r){
    const kparts = [];
    (r.kontakte || []).forEach(k => {
      kparts.push(k.datum, k.anlass, k.notiz, k.followUpDatum, k.followUpThema, k.followUpErledigt ? "erledigt" : "offen");
    });
    const parts = [
      partnerName,
      r.rolle, r.makNummer,
      r.name, r.firma, r.email, r.mobil, r.telefon,
      r.strasse, r.plz, r.ort, r.land,
      r.optin ? "optin" : "",
      r.onlineAbschluss ? "online" : "",
      ...kparts
    ];
    return parts.filter(Boolean).join(" ").toLowerCase();
  }

  function showResults(){
    const q = ($("q").value || "").trim().toLowerCase();
    if (!q) return alert("Bitte Suchbegriff eingeben.");
    const hits = [];

    PARTNERS.forEach(p => {
      const ps = DB.partners[p.key];
      ps.records.forEach(r => {
        const txt = recordSearchText(p.name, r);
        if (txt.includes(q)){
          hits.push({ partnerKey: p.key, partnerName: p.name, recordId: r.id, rolle: r.rolle, mak: r.makNummer, name: r.name, firma: r.firma });
        }
      });
    });

    const host = $("resultsHost");
    host.innerHTML = "";
    if (!hits.length){
      host.innerHTML = `<div class="muted">Keine Treffer.</div>`;
    } else {
      hits.slice(0,200).forEach(h => {
        const row = document.createElement("div");
        row.className = "listRow";
        row.innerHTML = `
          <div class="left">
            <b>${escapeHtml(h.partnerName)}</b>
            <div class="meta">${escapeHtml(h.rolle || "ohne Rolle")}${h.mak ? " ¬∑ MAK " + escapeHtml(h.mak) : ""} ¬∑ ${escapeHtml(h.name || h.firma || "‚Äî")}</div>
          </div>
          <div class="right">
            <button class="ghost">√ñffnen</button>
          </div>
        `;
        row.querySelector("button").onclick = () => {
          DB.activePartnerKey = h.partnerKey;
          DB.partners[h.partnerKey].activeRecordId = h.recordId;
          saveDB();
          ACTIVE_PAGE = "main";
          $("resultsWrap").style.display = "none";
          renderAll();
        };
        host.appendChild(row);
      });
    }

    $("resultsWrap").style.display = "";
    window.scrollTo({ top: document.body.scrollHeight, behavior:"smooth" });
  }

  // =======================
  // Follow-ups overview (ALL partners)
  // =======================
  function collectOpenFollowUpsAllPartners(){
    const items = [];
    PARTNERS.forEach(p => {
      const ps = DB.partners[p.key];
      ps.records.forEach(r => {
        (r.kontakte || []).forEach((k, idx) => {
          const due = (k.followUpDatum || "").trim();
          const thema = (k.followUpThema || "").trim();
          const done = !!k.followUpErledigt;
          const isCandidate = (!!due || !!thema) && !done;
          if (!isCandidate) return;

          items.push({
            partnerKey: p.key,
            partnerName: p.name,
            recordId: r.id,
            rolle: (r.rolle || "").trim(),
            mak: (r.makNummer || "").trim(),
            kontaktIndex: idx + 1,
            followUpDatum: due,
            followUpThema: thema,
            anlass: (k.anlass || "").trim(),
            notiz: (k.notiz || "").trim(),
            updatedAt: r.updatedAt || r.createdAt || ""
          });
        });
      });
    });

    items.sort((a,b)=>{
      const da = a.followUpDatum || "9999-12-31";
      const db = b.followUpDatum || "9999-12-31";
      if (da < db) return -1;
      if (da > db) return 1;
      return (b.updatedAt || "").localeCompare(a.updatedAt || "");
    });

    return items;
  }

  function gotoRecord(partnerKey, recordId){
    DB.activePartnerKey = partnerKey;
    DB.partners[partnerKey].activeRecordId = recordId;
    saveDB();
    ACTIVE_PAGE = "main";
    renderAll();
    window.scrollTo({ top: 0, behavior: "smooth" });
  }

  function renderFollowUpOverviewAllPartners(){
    const host = $("followUpAllHost");
    if (!host) return;

    const items = collectOpenFollowUpsAllPartners();
    if (!items.length){
      host.innerHTML = `<div class="muted">Keine offenen Wiedervorlagen gefunden üéâ</div>`;
      return;
    }

    host.innerHTML = items.slice(0, 300).map(it => {
      const due = it.followUpDatum ? escapeHtml(it.followUpDatum) : "‚Äî";
      const mk = it.mak ? ` ¬∑ MAK ${escapeHtml(it.mak)}` : "";
      const rl = it.rolle ? ` ¬∑ ${escapeHtml(it.rolle)}` : "";
      const thema = it.followUpThema ? escapeHtml(it.followUpThema) : "‚Äî";

      return `
        <div class="listRow">
          <div class="left">
            <b>${escapeHtml(it.partnerName)}</b>${rl}${mk}
            <div class="meta">Kontakt ${it.kontaktIndex} ¬∑ F√§llig: <b>${due}</b> ¬∑ Thema: ${thema}</div>
            <div class="meta">${it.anlass ? "Anlass: " + escapeHtml(it.anlass) + " ¬∑ " : ""}${it.notiz ? "Notiz: " + escapeHtml(it.notiz) : ""}</div>
          </div>
          <div class="right">
            <button class="ghost" data-p="${escapeHtml(it.partnerKey)}" data-r="${escapeHtml(it.recordId)}">√ñffnen</button>
          </div>
        </div>
      `;
    }).join("");

    host.querySelectorAll("button[data-p]").forEach(btn => {
      btn.onclick = () => gotoRecord(btn.getAttribute("data-p"), btn.getAttribute("data-r"));
    });
  }

  // =======================
  // Stats (Auswertung)
  // =======================
  function ensureYearStats(ps, year){
    ps.yearStats ||= {};
    ps.yearStats[year] ||= {
      gesamtZiel:"", gesamtIst:"",
      vollZiel:"", vollIst:"",
      beihilfeZiel:"", beihilfeIst:"",
      zusatzZiel:"", zusatzIst:"",
      bkvZiel:"", bkvIst:""
    };
    return ps.yearStats[year];
  }

  function initStatsSelectors(){
    const sp = $("statsPartner");
    const sy = $("statsYear");

    sp.innerHTML = "";
    PARTNERS.forEach(p => {
      const opt = document.createElement("option");
      opt.value = p.key;
      opt.textContent = p.name;
      sp.appendChild(opt);
    });

    const years = [];
    for (let y=currentYear()-2; y<=currentYear()+1; y++) years.push(y);
    sy.innerHTML = "";
    years.forEach(y => {
      const opt = document.createElement("option");
      opt.value = String(y);
      opt.textContent = String(y);
      sy.appendChild(opt);
    });

    sp.value = DB.activePartnerKey;
    sy.value = String(currentYear());

    sp.onchange = () => { renderStats(); renderFollowUpOverviewAllPartners(); };
    sy.onchange = () => { renderStats(); };
  }

  function monthlyBuckets(partnerKey, year){
    const ps = DB.partners[partnerKey];
    const buckets = Array.from({length:12}, () => ({
      prodVoll:0, zielVoll:0,
      prodBeihilfe:0, zielBeihilfe:0,
      prodZusatz:0, zielZusatz:0,
      prodBkv:0, zielBkv:0
    }));

    ps.records.forEach(r => {
      const y = Number((r.datum || "").slice(0,4));
      if (y !== year) return;

      // Jahreswerte gleichm√§√üig auf 12 Monate verteilen
      const mProdVoll = moneyParse(r.prodVoll)/12;
      const mZielVoll = moneyParse(r.zielVoll)/12;

      const mProdBeihilfe = moneyParse(r.prodBeihilfe)/12;
      const mZielBeihilfe = moneyParse(r.zielBeihilfe)/12;

      const mProdZusatz = moneyParse(r.prodZusatz)/12;
      const mZielZusatz = moneyParse(r.zielZusatz)/12;

      const mProdBkv = moneyParse(r.prodBkv)/12;
      const mZielBkv = moneyParse(r.zielBkv)/12;

      for (let i=0;i<12;i++){
        const b = buckets[i];
        b.prodVoll += mProdVoll; b.zielVoll += mZielVoll;
        b.prodBeihilfe += mProdBeihilfe; b.zielBeihilfe += mZielBeihilfe;
        b.prodZusatz += mProdZusatz; b.zielZusatz += mZielZusatz;
        b.prodBkv += mProdBkv; b.zielBkv += mZielBkv;
      }
    });

    return buckets;
  }

  function renderStats(){
    if (ACTIVE_PAGE !== "stats") return;

    const partnerKey = $("statsPartner").value;
    const year = Number($("statsYear").value);
    const ps = DB.partners[partnerKey];
    const ys = ensureYearStats(ps, year);

    // manual year stats bindings
    const bind = (id, key) => {
      const el = $(id);
      el.value = ys[key] ?? "";
      el.oninput = () => {
        ys[key] = el.value;
        saveDB();
      };
      el.onchange = el.oninput;
    };

    bind("gesamtZiel","gesamtZiel");
    bind("gesamtIst","gesamtIst");
    bind("vollZiel","vollZiel");
    bind("vollIst","vollIst");
    bind("beihilfeZiel","beihilfeZiel");
    bind("beihilfeIst","beihilfeIst");
    bind("zusatzZiel","zusatzZiel");
    bind("zusatzIst","zusatzIst");
    bind("bkvZiel","bkvZiel");
    bind("bkvIst","bkvIst");

    // monthly table
    const months = ["Jan","Feb","M√§r","Apr","Mai","Jun","Jul","Aug","Sep","Okt","Nov","Dez"];
    const buckets = monthlyBuckets(partnerKey, year);
    const tb = $("monthTBody");
    tb.innerHTML = "";

    buckets.forEach((b, i) => {
      const gp = b.prodVoll + b.prodBeihilfe + b.prodZusatz + b.prodBkv;
      const gz = b.zielVoll + b.zielBeihilfe + b.zielZusatz + b.zielBkv;
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td><b>${months[i]}</b></td>
        <td>${moneyFormat(Math.round(b.prodVoll))}</td><td>${moneyFormat(Math.round(b.zielVoll))}</td>
        <td>${moneyFormat(Math.round(b.prodBeihilfe))}</td><td>${moneyFormat(Math.round(b.zielBeihilfe))}</td>
        <td>${moneyFormat(Math.round(b.prodZusatz))}</td><td>${moneyFormat(Math.round(b.zielZusatz))}</td>
        <td>${moneyFormat(Math.round(b.prodBkv))}</td><td>${moneyFormat(Math.round(b.zielBkv))}</td>
        <td><b>${moneyFormat(Math.round(gp))}</b></td>
        <td><b>${moneyFormat(Math.round(gz))}</b></td>
      `;
      tb.appendChild(tr);
    });
  }

  function exportStatsCSV(){
    const partnerKey = $("statsPartner").value;
    const year = Number($("statsYear").value);
    const p = partnerByKey(partnerKey);
    const buckets = monthlyBuckets(partnerKey, year);
    const months = ["Jan","Feb","M√§r","Apr","Mai","Jun","Jul","Aug","Sep","Okt","Nov","Dez"];

    const lines = [];
    lines.push(["Partner","Jahr","Monat","ProdVoll","ZielVoll","ProdBeihilfe","ZielBeihilfe","ProdZusatz","ZielZusatz","ProdBkv","ZielBkv","GesamtProd","GesamtZiel"].join(";"));
    buckets.forEach((b,i)=>{
      const gp = b.prodVoll + b.prodBeihilfe + b.prodZusatz + b.prodBkv;
      const gz = b.zielVoll + b.zielBeihilfe + b.zielZusatz + b.zielBkv;
      lines.push([
        p.name, year, months[i],
        Math.round(b.prodVoll), Math.round(b.zielVoll),
        Math.round(b.prodBeihilfe), Math.round(b.zielBeihilfe),
        Math.round(b.prodZusatz), Math.round(b.zielZusatz),
        Math.round(b.prodBkv), Math.round(b.zielBkv),
        Math.round(gp), Math.round(gz)
      ].join(";"));
    });

    downloadText(`auswertung_${p.name.replaceAll(" ","_")}_${year}.csv`, lines.join("\n"), "text/csv;charset=utf-8");
  }

  // =======================
  // Export / Import / Merge
  // =======================
  function downloadText(filename, text, mime){
    const blob = new Blob([text], { type: mime || "text/plain;charset=utf-8" });
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;
    a.download = filename;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    setTimeout(()=>URL.revokeObjectURL(url), 1000);
  }

  function exportFull(){
    downloadText(`vertriebspartner_full_${todayISO()}.json`, JSON.stringify(DB, null, 2), "application/json");
  }

  function exportDelta(){
    const day = todayISO();
    const out = JSON.parse(JSON.stringify(DB));
    // reduce records to those updated today
    PARTNERS.forEach(p => {
      const ps = out.partners[p.key];
      ps.records = ps.records.filter(r => String(r.updatedAt || "").slice(0,10) === day);
      ps.activeRecordId = ps.records[0]?.id || null;
    });
    out.exportMeta = { type:"delta", day, by: sessionUserSafe(), at: nowISO() };
    downloadText(`vertriebspartner_delta_${day}.json`, JSON.stringify(out, null, 2), "application/json");
  }

  function exportCSV(){
    // one row per record + next open follow-up
    const lines = [];
    lines.push([
      "Partner","Reiter","Rolle","MAK","Datum",
      "Name","Firma","Email","Mobil","Telefon",
      "Strasse","PLZ","Ort","Land",
      "Optin","OnlineAbschluss",
      "ProdVoll","ZielVoll","ProdBeihilfe","ZielBeihilfe","ProdZusatz","ZielZusatz","ProdBkv","ZielBkv",
      "NextFollowUpDatum","NextFollowUpThema","NextFollowUpAnlass"
    ].join(";"));

    PARTNERS.forEach(p => {
      const ps = DB.partners[p.key];
      ps.records.forEach((r, idx) => {
        let next = null;
        (r.kontakte||[]).forEach(k => {
          if (k.followUpErledigt) return;
          if (!k.followUpDatum && !k.followUpThema) return;
          const d = k.followUpDatum || "9999-12-31";
          if (!next || d < (next.followUpDatum || "9999-12-31")) next = k;
        });

        const row = [
          p.name,
          idx+1,
          (r.rolle||""),
          (r.makNummer||""),
          (r.datum||""),
          (r.name||""),
          (r.firma||""),
          (r.email||""),
          (r.mobil||""),
          (r.telefon||""),
          (r.strasse||""),
          (r.plz||""),
          (r.ort||""),
          (r.land||""),
          r.optin ? "Ja" : "Nein",
          r.onlineAbschluss ? "Ja" : "Nein",
          r.prodVoll||"", r.zielVoll||"",
          r.prodBeihilfe||"", r.zielBeihilfe||"",
          r.prodZusatz||"", r.zielZusatz||"",
          r.prodBkv||"", r.zielBkv||"",
          next ? (next.followUpDatum||"") : "",
          next ? (next.followUpThema||"") : "",
          next ? (next.anlass||"") : ""
        ].map(v => String(v).replaceAll("\n"," ").replaceAll("; ",", "));

        lines.push(row.join(";"));
      });
    });

    downloadText(`vertriebspartner_${todayISO()}.csv`, lines.join("\n"), "text/csv;charset=utf-8");
  }

  async function importFiles(fileList){
    const files = Array.from(fileList || []);
    if (!files.length) return;

    const loaded = [];
    for (const f of files){
      const txt = await f.text();
      const obj = safeJSONParse(txt);
      if (!obj || !obj.partners){
        alert(`Datei "${f.name}" ist keine g√ºltige Export-Datei.`);
        return;
      }
      loaded.push(obj);
    }

    // merge in order
    loaded.forEach(obj => mergeDB(obj));
    saveDB();
    renderAll();
    alert(`Import/Merge abgeschlossen (${files.length} Datei(en)).`);
  }

  function mergeDB(incoming){
    // Merge: record by id -> keep newest updatedAt
    PARTNERS.forEach(p => {
      const psLocal = DB.partners[p.key];
      const psIn = incoming.partners[p.key];
      if (!psIn) return;

      // customFields union by id
      psLocal.customFields ||= [];
      (psIn.customFields || []).forEach(cf => {
        if (!psLocal.customFields.find(x => x.id === cf.id)){
          psLocal.customFields.push(cf);
        }
      });

      // yearStats merge (prefer incoming if non-empty strings)
      psLocal.yearStats ||= {};
      const ysIn = psIn.yearStats || {};
      Object.keys(ysIn).forEach(year => {
        const tgt = ensureYearStats(psLocal, year);
        const src = ysIn[year] || {};
        Object.keys(tgt).forEach(k => {
          if (String(src[k] ?? "").trim() !== "") tgt[k] = src[k];
        });
      });

      // records merge
      const byId = new Map(psLocal.records.map(r => [r.id, r]));
      (psIn.records || []).forEach(rIn => {
        const rLocal = byId.get(rIn.id);
        if (!rLocal){
          psLocal.records.push(rIn);
          byId.set(rIn.id, rIn);
          return;
        }
        const tLocal = String(rLocal.updatedAt || "");
        const tIn = String(rIn.updatedAt || "");
        if (tIn > tLocal){
          Object.keys(rLocal).forEach(k => delete rLocal[k]);
          Object.assign(rLocal, rIn);
        }
      });

      // ensure activeRecordId
      if (!psLocal.activeRecordId) psLocal.activeRecordId = psLocal.records[0]?.id || null;
    });

    // keep incoming activePartnerKey only if local missing
    if (!DB.activePartnerKey) DB.activePartnerKey = incoming.activePartnerKey || PARTNERS[0].key;

    // refresh/ensure schema
    DB = loadDB();
  }

  // =======================
  // Render All
  // =======================
  function renderAll(){
    const session = getSession();
    const loggedIn = !!session;

    $("who").textContent = loggedIn ? `${session.user} (${session.role})` : "nicht eingeloggt";
    $("who").className = "pill" + (loggedIn ? " ok" : "");

    $("loginCard").style.display = loggedIn ? "none" : "";
    $("navCard").style.display = loggedIn ? "" : "none";
    $("mainCard").style.display = loggedIn ? "" : "none";

    // lock controls when not logged in
    const lockIds = ["btnPrint","btnNewField","btnDeleteField","btnExportDelta","btnExportFull","btnExportCSV","btnImport","btnLogout","tabMain","tabStats"];
    lockIds.forEach(id => { const el = $(id); if (el) el.disabled = !loggedIn; });

    if (!loggedIn){
      setStatus("bereit","");
      return;
    }

    ensureOneRecord();
    setStatus("eingeloggt","ok");

    // tabs
    $("tabMain").classList.toggle("active", ACTIVE_PAGE === "main");
    $("tabStats").classList.toggle("active", ACTIVE_PAGE === "stats");
    $("viewMain").style.display = (ACTIVE_PAGE === "main") ? "" : "none";
    $("viewStats").style.display = (ACTIVE_PAGE === "stats") ? "" : "none";

    renderPartnerTabs();
    renderRecordSelect();
    renderForm();

    // stats page: set selector values and render
    if (ACTIVE_PAGE === "stats"){
      $("statsPartner").value = DB.activePartnerKey;
      renderStats();
      renderFollowUpOverviewAllPartners();
    } else {
      // still keep follow-up cache up to date
      renderFollowUpOverviewAllPartners();
    }
  }

  // =======================
  // Init
  // =======================
  initLoginUI();
  bindAllInputs();
  initStatsSelectors();
  renderAll();

})();
</script>
</body>
</html>
