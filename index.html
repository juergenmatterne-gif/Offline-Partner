<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Vertriebspartner (Offline)</title>
  <style>
    :root{
      --bg:#eef4ff;
      --panel:#ffffff;
      --text:#0b1b33;
      --muted:#51627a;
      --line:rgba(11,27,51,.12);
      --shadow:0 10px 28px rgba(11,27,51,.10);
      --radius:18px;

      --pf-main:#1d4ed8;
      --pf-soft:rgba(29,78,216,.14);
      --pf-soft2:rgba(29,78,216,.08);

      --green:rgba(16,185,129,.18);
      --amber:rgba(245,158,11,.18);
      --red:rgba(244,63,94,.18);
    }

    body[data-partner="fonds_finanz"]{ --pf-main:#2563eb; --pf-soft:rgba(37,99,235,.14); --pf-soft2:rgba(37,99,235,.08); }
    body[data-partner="demv"]{        --pf-main:#059669; --pf-soft:rgba(5,150,105,.14);  --pf-soft2:rgba(5,150,105,.08); }
    body[data-partner="taures"]{      --pf-main:#7c3aed; --pf-soft:rgba(124,58,237,.14); --pf-soft2:rgba(124,58,237,.08); }
    body[data-partner="tvd"]{         --pf-main:#ea580c; --pf-soft:rgba(234,88,12,.14);  --pf-soft2:rgba(234,88,12,.08); }
    body[data-partner="wir_finanz"]{  --pf-main:#0f766e; --pf-soft:rgba(15,118,110,.14); --pf-soft2:rgba(15,118,110,.08); }

    *{box-sizing:border-box}
    body{
      margin:0;
      font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;
      color:var(--text);
      background:
        radial-gradient(1200px 800px at 15% 12%, var(--pf-soft), transparent 55%),
        radial-gradient(1200px 800px at 85% 35%, var(--pf-soft2), transparent 55%),
        linear-gradient(180deg,#f7faff,var(--bg));
    }

    header{
      position:sticky; top:0; z-index:20;
      background:rgba(255,255,255,.75);
      backdrop-filter: blur(10px);
      border-bottom:1px solid var(--line);
    }
    .topbar{
      display:flex; align-items:center; gap:12px;
      padding:14px 16px;
      max-width:1280px; margin:0 auto;
    }
    .brand{display:flex; flex-direction:column; gap:4px; margin-right:8px}
    .brand b{font-size:18px}
    .mini{font-size:12px; color:var(--muted)}
    .pill{
      display:inline-flex; align-items:center; gap:8px;
      padding:6px 10px; border-radius:999px;
      border:1px solid var(--line);
      background:rgba(255,255,255,.8);
      font-size:12px; color:var(--muted);
      white-space:nowrap;
    }
    .pill.ok{border-color:rgba(16,185,129,.30); background:rgba(16,185,129,.10); color:#065f46}
    .pill.warn{border-color:rgba(245,158,11,.35); background:rgba(245,158,11,.12); color:#92400e}
    .pill.bad{border-color:rgba(244,63,94,.35); background:rgba(244,63,94,.12); color:#9f1239}

    .spacer{flex:1}

    .actions{display:flex; flex-wrap:wrap; gap:8px; justify-content:flex-end}
    button{
      appearance:none; border:1px solid var(--line);
      background:rgba(255,255,255,.9);
      padding:9px 12px; border-radius:12px;
      font-weight:700; cursor:pointer;
      box-shadow:0 1px 0 rgba(0,0,0,.03);
    }
    button:hover{border-color:rgba(29,78,216,.35)}
    button.primary{background:var(--pf-main); color:white; border-color:transparent}
    button.danger{background:rgba(244,63,94,.10); border-color:rgba(244,63,94,.35); color:#9f1239}
    button.ghost{background:transparent}
    button.tab{padding:8px 12px; border-radius:999px; background:transparent}
    button.tab.active{background:var(--pf-soft); border-color:transparent; color:var(--pf-main)}

    .wrap{
      max-width:1280px; margin:18px auto;
      padding:0 16px 26px;
      display:grid;
      grid-template-columns: 360px 1fr;
      gap:16px;
      align-items:start;
    }

    .card{
      background:rgba(255,255,255,.86);
      border:1px solid var(--line);
      border-radius:var(--radius);
      box-shadow:var(--shadow);
      padding:16px;
    }
    .h{font-size:18px; font-weight:900}
    .muted{color:var(--muted); font-size:13px}
    .divider{height:1px; background:var(--line); margin:14px 0}

    .partnerTabs{display:flex; gap:8px; flex-wrap:wrap; margin-top:10px}
    .partnerTabs button{padding:8px 12px; border-radius:999px; background:rgba(255,255,255,.85)}
    .partnerTabs button.active{background:var(--pf-soft); border-color:transparent; color:var(--pf-main)}

    .row{display:flex; gap:10px; flex-wrap:wrap}
    .field{display:flex; flex-direction:column; gap:6px; flex:1; min-width:160px}
    .field.w2{flex:0 0 calc(16.666% - 10px); min-width:160px}
    .field.w3{flex:0 0 calc(25% - 10px); min-width:180px}
    .field.w4{flex:0 0 calc(33.333% - 10px); min-width:180px}
    .field.w5{flex:0 0 calc(41.666% - 10px); min-width:180px}
    .field.w6{flex:0 0 calc(50% - 10px); min-width:220px}
    .field.w12{flex:0 0 100%}

    label{font-size:12px; color:var(--muted); font-weight:800}
    input, select, textarea{
      border:1px solid rgba(11,27,51,.16);
      border-radius:14px;
      padding:12px 12px;
      font-size:14px;
      background:rgba(255,255,255,.92);
      outline:none;
    }
    input:focus, select:focus, textarea:focus{
      border-color:rgba(29,78,216,.45);
      box-shadow:0 0 0 4px rgba(29,78,216,.12);
    }
    textarea{min-height:90px; resize:vertical}

    .stammBox{
      border:1px solid color-mix(in srgb, var(--pf-main) 28%, transparent);
      background: linear-gradient(180deg, var(--pf-soft2), rgba(255,255,255,.92));
      border-radius:16px;
      padding:14px;
    }
    .stammTitle{
      display:flex; align-items:center; justify-content:space-between; gap:10px;
      margin-bottom:12px;
    }
    .tag{
      display:inline-flex; align-items:center; gap:8px;
      padding:6px 10px; border-radius:999px;
      background:var(--pf-soft);
      border:1px solid color-mix(in srgb, var(--pf-main) 35%, transparent);
      color:var(--pf-main);
      font-size:12px;
      font-weight:900;
      letter-spacing:.03em;
      text-transform:uppercase;
    }

    .iconRow{display:flex; gap:8px; flex-wrap:wrap; margin-top:10px}
    .iconBtn{
      display:inline-flex; align-items:center; gap:8px;
      padding:8px 10px; border-radius:999px;
      border:1px solid var(--line);
      background:rgba(255,255,255,.85);
      font-weight:800;
      cursor:pointer;
      font-size:12px;
    }
    .iconBtn:hover{border-color:rgba(29,78,216,.35)}
    .iconBtn.primary{background:var(--pf-main); color:#fff; border-color:transparent}

    .hidden{display:none !important}

    table{width:100%; border-collapse:separate; border-spacing:0}
    th, td{font-size:12px; padding:10px 10px; border-bottom:1px solid var(--line); text-align:left; vertical-align:top}
    th{color:var(--muted); font-weight:900; background:rgba(255,255,255,.65); position:sticky; top:0}
    tbody tr:hover{background:rgba(29,78,216,.04)}
    .tblWrap{max-height:420px; overflow:auto; border:1px solid var(--line); border-radius:14px; background:rgba(255,255,255,.7)}

    .kpiGrid{
      display:grid;
      grid-template-columns: repeat(3, minmax(240px, 1fr));
      gap:10px;
    }
    @media (max-width: 1100px){ .kpiGrid{grid-template-columns:1fr} }

    .kpi{
      border:1px solid color-mix(in srgb, var(--pf-main) 22%, transparent);
      background:linear-gradient(180deg, rgba(255,255,255,.88), rgba(255,255,255,.78));
      border-radius:16px;
      padding:12px;
    }
    .kpi b{display:block; font-size:12px; color:var(--muted); letter-spacing:.02em; text-transform:uppercase}
    .kpi .big{font-size:18px; font-weight:900; margin-top:6px}
    .kpi .sub{font-size:12px; color:var(--muted); margin-top:4px}

    .partnerDot{
      width:10px; height:10px; border-radius:999px; display:inline-block;
      background:var(--pf-main);
      border:1px solid rgba(0,0,0,.08);
    }

    /* Freies Feld: volle Breite + "handschriftlich" + blau */
    #freiesFeld{
      width:100%;
      min-height:140px;
      font-family: "Segoe Print","Comic Sans MS", cursive;
      color:#2563eb;
      font-size:16px;
      line-height:1.35;
    }

    /* NEW: Partner-Ziele + Followup-Filter */
    .goalWrap{display:flex; flex-direction:column; gap:10px}
    .goalRow{
      display:grid;
      grid-template-columns: 220px 1fr 1fr 160px;
      gap:10px; align-items:center;
      padding:12px;
      border:1px solid color-mix(in srgb, var(--pf-main) 18%, var(--line));
      border-radius:16px;
      background:linear-gradient(180deg, rgba(255,255,255,.9), rgba(255,255,255,.78));
    }
    .goalRow .title{display:flex; align-items:center; gap:10px; font-weight:900}
    .goalRow .pct{font-weight:900; text-align:right}
    .progressBar{height:10px; background:rgba(11,27,51,.10); border-radius:999px; overflow:hidden}
    .progressBar > span{display:block; height:100%; width:0%; background:var(--pf-main)}
    .goalInputs{display:grid; grid-template-columns: 1fr 1fr; gap:10px}
    .goalInputs .field{min-width:auto}
    .goalRow input{padding:10px 12px; border-radius:12px}
    .goalTotal{
      border:1px solid color-mix(in srgb, var(--pf-main) 28%, transparent);
      background:linear-gradient(180deg, var(--pf-soft2), rgba(255,255,255,.92));
    }
    @media (max-width: 980px){
      .goalRow{grid-template-columns:1fr}
      .goalRow .pct{text-align:left}
      .goalInputs{grid-template-columns:1fr}
    }

    .filterBar{
      display:flex; gap:10px; align-items:center; flex-wrap:wrap;
      padding:10px; border-radius:16px;
      border:1px solid color-mix(in srgb, var(--pf-main) 16%, var(--line));
      background:linear-gradient(180deg, rgba(255,255,255,.85), rgba(255,255,255,.70));
    }
    .chipGroup{display:flex; gap:8px; flex-wrap:wrap}
    .chip{
      padding:8px 12px; border-radius:999px;
      border:1px solid var(--line);
      background:rgba(255,255,255,.86);
      font-weight:900; font-size:12px;
      cursor:pointer;
    }
    .chip.active{background:var(--pf-soft); border-color:transparent; color:var(--pf-main)}
    #fuQ{min-width:240px}

    @media (max-width: 1020px){ .wrap{grid-template-columns:1fr} }
    @media print{
      header, .no-print{display:none !important}
      body{background:#fff}
      .wrap{grid-template-columns:1fr; max-width:100%; padding:0}
      .card{box-shadow:none}
    }
  </style>
</head>

<body data-partner="fonds_finanz">
<header class="no-print">
  <div class="topbar">
    <div class="brand">
      <b>Vertriebspartner (Offline)</b>
      <div class="mini"><span id="who">nicht eingeloggt</span></div>
    </div>
    <span class="pill" id="statusPill">bereit</span>

    <div style="display:flex; gap:8px; align-items:center; flex-wrap:wrap; margin-left:8px;">
      <button class="tab active" id="tabMain">Hauptansicht</button>
      <button class="tab" id="tabStats">Auswertung</button>
      <button class="tab" id="tabFollowups">Wiedervorlagen</button>
    </div>

    <div class="spacer"></div>

    <div class="actions">
      <button id="btnPrint">Drucken</button>
      <button id="btnNewField">Neue Felder</button>
      <button class="danger" id="btnDeleteField">Feld l√∂schen</button>

      <button id="btnExportDelta">Export (Delta heute)</button>
      <button id="btnExportFull">Export (Voll)</button>
      <button class="primary" id="btnExportSafeFull">SAFE Export (Voll)</button>
      <button id="btnExportCSV">CSV Export</button>

      <button id="btnImportMerge">Import / Merge</button>
      <button class="danger" id="btnImportReplace">Import (Replace)</button>
      <input id="fileImport" type="file" accept="application/json" multiple class="hidden">

      <button class="danger" id="btnLogout">Logout</button>
    </div>
  </div>
</header>

<div class="wrap">
  <aside class="card" id="loginCard">
    <div class="h">Login (offline)</div>
    <div class="muted" style="margin-top:6px;">
      Daten werden lokal im Browser gespeichert. Restore nach ‚ÄûLokale Daten l√∂schen‚Äú: <b>Import (Replace)</b>.
    </div>

    <div class="row" style="margin-top:12px;">
      <div class="field w6">
        <label>Benutzer</label>
        <input id="loginUser" list="userList" placeholder="Benutzer eingeben‚Ä¶" autocomplete="username">
        <datalist id="userList"></datalist>
      </div>
      <div class="field w6">
        <label>Passwort</label>
        <input id="loginPass" type="password" placeholder="Passwort" autocomplete="current-password">
      </div>
    </div>

    <div class="row" style="margin-top:12px;">
      <button class="primary" id="btnLogin" style="width:180px">Login</button>
      <button class="ghost" id="btnClearLocal" title="L√∂scht DB+Session dieses Browsers">Lokale Daten l√∂schen</button>
      <span class="pill" id="loginHint">‚Äî</span>
    </div>

    <div class="divider"></div>
    <div class="mini">
      <div><b>Team-Workflow:</b> Mitarbeiter senden <b>Delta</b>, Master verteilt <b>SAFE Voll</b>.</div>
    </div>
  </aside>

  <aside class="card hidden" id="navCard">
    <div class="h">Partner</div>
    <div class="partnerTabs" id="partnerTabs"></div>

    <div class="divider"></div>

    <div class="h">Reiter / Datensatz</div>
    <select id="recordSelect" style="margin-top:10px;"></select>

    <div class="row" style="margin-top:10px;">
      <button id="btnNewTab">+ Neuer Reiter</button>
      <button class="danger" id="btnDeleteTab">Reiter l√∂schen</button>
    </div>

    <div class="divider"></div>

    <div class="h">Suche</div>
    <input id="q" placeholder="Name / Firma / E-Mail / Rolle / MAK / Anlass ‚Ä¶">
    <div class="row" style="margin-top:10px;">
      <button id="btnFind">Trefferliste</button>
      <button class="ghost" id="btnCloseResults">Schlie√üen</button>
    </div>
  </aside>

  <main class="card hidden" id="mainCard">
    <div style="display:flex; align-items:flex-start; gap:12px; justify-content:space-between;">
      <div>
        <div class="h">Datensatz</div>
        <div class="muted">Autosave: √Ñnderungen werden sofort lokal gespeichert.</div>
      </div>
      <div class="pill ok" id="autosavePill">ok</div>
    </div>

    <div class="row" style="margin-top:12px;">
      <div class="field w5">
        <label>Rolle (frei)</label>
        <input id="rolle" placeholder="z. B. RDPartner / DirektPartner / ‚Ä¶">
      </div>
      <div class="field w3">
        <label>Partnernummer</label>
        <input id="partnerNummer" placeholder="Partnernummer">
      </div>
      <div class="field w2" id="makWrap">
        <label>MAK (nur Fonds/DEMV)</label>
        <input id="mak" placeholder="MAK-Nummer">
      </div>
      <div class="field w2">
        <label>Datum (Reiter)</label>
        <input id="datum" type="date">
      </div>
    </div>

    <div class="stammBox" style="margin-top:14px;">
      <div class="stammTitle">
        <div class="tag">Stammdaten</div>
        <div class="mini">Vorname ¬∑ Nachname ¬∑ Firma ¬∑ E-Mail ¬∑ Tel/Mobil ¬∑ Adresse</div>
      </div>

      <div class="row">
        <div class="field w6"><label>Vorname</label><input id="vorname"></div>
        <div class="field w6"><label>Nachname</label><input id="nachname"></div>
      </div>

      <div class="row" style="margin-top:10px;">
        <div class="field w6"><label>Firma</label><input id="firma"></div>
        <div class="field w6"><label>E-Mail</label><input id="email"></div>
      </div>

      <div class="row" style="margin-top:10px;">
        <div class="field w6"><label>Mobil</label><input id="mobil" type="tel"></div>
        <div class="field w6"><label>Telefon</label><input id="telefon" type="tel"></div>
      </div>

      <div class="row" style="margin-top:10px;">
        <div class="field w6"><label>Stra√üe</label><input id="strasse"></div>
        <div class="field w2"><label>PLZ</label><input id="plz"></div>
        <div class="field w4"><label>Ort</label><input id="ort"></div>
        <div class="field w2"><label>Land</label><input id="land"></div>
      </div>

      <div class="row" style="margin-top:10px;">
        <div class="field w4">
          <label>Favorit</label>
          <div style="display:flex; align-items:center; gap:10px;">
            <input id="favorit" type="checkbox" style="width:auto; transform:scale(1.2);">
            <span class="muted">‚òÖ im Reiter</span>
          </div>
        </div>
        <div class="field w4">
          <label>Optin</label>
          <div style="display:flex; align-items:center; gap:10px;">
            <input id="optin" type="checkbox" style="width:auto; transform:scale(1.2);">
            <span class="muted">Einwilligung</span>
          </div>
        </div>
        <div class="field w4">
          <label>Online Abschluss</label>
          <div style="display:flex; align-items:center; gap:10px;">
            <input id="online" type="checkbox" style="width:auto; transform:scale(1.2);">
            <span class="muted">online</span>
          </div>
        </div>
      </div>

      <div class="iconRow">
        <button class="iconBtn" id="btnCopyAddress">üìç Adresse kopieren</button>
        <button class="iconBtn" id="btnCopyPhone">üìû Tel/Mobil kopieren</button>
        <button class="iconBtn" id="btnCall">üìû Anrufen</button>
        <button class="iconBtn primary" id="btnMail">‚úâÔ∏è E-Mail</button>
      </div>
    </div>

    <!-- Produktion direkt nach Stammdaten -->
    <div class="stammBox" style="margin-top:14px;">
      <div class="stammTitle">
        <div class="tag">Produktion je Reiter</div>
        <div class="mini">Ziel (‚Ç¨) ¬∑ Ist (‚Ç¨) ‚Äî manuell √ºberschreibbar</div>
      </div>

      <div class="row">
        <div class="field w6">
          <label>Voll ‚Äì Ziel (‚Ç¨)</label>
          <input id="pVollZiel" inputmode="decimal" placeholder="z. B. 12.500">
        </div>
        <div class="field w6">
          <label>Voll ‚Äì Ist (‚Ç¨)</label>
          <input id="pVollIst" inputmode="decimal" placeholder="z. B. 3.200">
        </div>
      </div>

      <div class="row" style="margin-top:10px;">
        <div class="field w6">
          <label>Beihilfe ‚Äì Ziel (‚Ç¨)</label>
          <input id="pBeihilfeZiel" inputmode="decimal">
        </div>
        <div class="field w6">
          <label>Beihilfe ‚Äì Ist (‚Ç¨)</label>
          <input id="pBeihilfeIst" inputmode="decimal">
        </div>
      </div>

      <div class="row" style="margin-top:10px;">
        <div class="field w6">
          <label>Zusatz ‚Äì Ziel (‚Ç¨)</label>
          <input id="pZusatzZiel" inputmode="decimal">
        </div>
        <div class="field w6">
          <label>Zusatz ‚Äì Ist (‚Ç¨)</label>
          <input id="pZusatzIst" inputmode="decimal">
        </div>
      </div>

      <div class="row" style="margin-top:10px;">
        <div class="field w6">
          <label>Pflege ‚Äì Ziel (‚Ç¨)</label>
          <input id="pPflegeZiel" inputmode="decimal">
        </div>
        <div class="field w6">
          <label>Pflege ‚Äì Ist (‚Ç¨)</label>
          <input id="pPflegeIst" inputmode="decimal">
        </div>
      </div>

      <div class="row" style="margin-top:10px;">
        <div class="field w6">
          <label>bKV ‚Äì Ziel (‚Ç¨)</label>
          <input id="pBkvZiel" inputmode="decimal">
        </div>
        <div class="field w6">
          <label>bKV ‚Äì Ist (‚Ç¨)</label>
          <input id="pBkvIst" inputmode="decimal">
        </div>
      </div>

      <div class="row" style="margin-top:10px;">
        <div class="field w6">
          <label>Reise ‚Äì Ziel (‚Ç¨)</label>
          <input id="pReiseZiel" inputmode="decimal">
        </div>
        <div class="field w6">
          <label>Reise ‚Äì Ist (‚Ç¨)</label>
          <input id="pReiseIst" inputmode="decimal">
        </div>
      </div>
    </div>

    <div class="divider"></div>

    <div class="h">Kontakt-Historie (inkl. Wiedervorlage)</div>
    <div id="contactsWrap" style="margin-top:12px;"></div>

    <div class="row" style="margin-top:10px;">
      <button id="btnAddContact">+ Kontakt hinzuf√ºgen</button>
    </div>

    <div class="divider"></div>

    <div class="h">Freies Feld</div>
    <textarea id="freiesFeld" placeholder="Notizen ‚Ä¶" style="margin-top:10px;"></textarea>

    <div class="divider"></div>

    <div class="h">Zusatzfelder (Custom)</div>
    <div id="customFieldsWrap" style="margin-top:12px;"></div>
  </main>

  <!-- Auswertung: Gesamt √ºber alle Datens√§tze -->
  <main class="card hidden" id="statsCard">
    <div class="h">Auswertung</div>
    <div class="muted" style="margin-top:6px;">Gesamtziele & Ist-Summen √ºber <b>alle Partner</b> und <b>alle Reiter</b>.</div>

    <div class="divider"></div>

    <!-- NEW: Hauptpartner-Ziele (manuell) -->
    <div class="h">Hauptpartner ‚Äì Gesamtziel (manuell)</div>
    <div class="muted" style="margin-top:6px;">
      Ziel &amp; Erreicht werden hier <b>manuell</b> gepflegt (separat von den Reiter-Produktionen).
    </div>
    <div style="margin-top:12px;" id="partnerGoalsWrap"></div>

    <div class="divider"></div>

    <div class="kpiGrid" id="kpiGrid"></div>

    <div class="divider"></div>

    <div class="h" style="display:flex; align-items:center; gap:10px;">
      <span>Details (Summe je Partner)</span>
      <span class="pill" id="sumHint">‚Äî</span>
    </div>

    <div class="tblWrap" style="margin-top:12px;">
      <table>
        <thead>
          <tr>
            <th>Partner</th>
            <th>Voll Ziel</th><th>Voll Ist</th>
            <th>Beihilfe Ziel</th><th>Beihilfe Ist</th>
            <th>Zusatz Ziel</th><th>Zusatz Ist</th>
            <th>Pflege Ziel</th><th>Pflege Ist</th>
            <th>bKV Ziel</th><th>bKV Ist</th>
            <th>Reise Ziel</th><th>Reise Ist</th>
            <th>Gesamt Ziel</th><th>Gesamt Ist</th>
          </tr>
        </thead>
        <tbody id="statsPartnerTbody"></tbody>
      </table>
    </div>
  </main>

  <!-- Wiedervorlagen: eigene Seite -->
  <main class="card hidden" id="followupsCard">
    <div class="h">Wiedervorlagen (√úbersicht)</div>
    <div class="muted" style="margin-top:6px;">Offene Wiedervorlagen √ºber <b>alle Partner</b> (farbig je Partner).</div>
    <div class="divider"></div>

    <!-- NEW: Filterleiste -->
    <div class="filterBar">
      <div class="chipGroup" id="fuTimeChips"></div>
      <select id="fuPartner" title="Partner-Filter"></select>
      <input id="fuQ" placeholder="Suche (Anlass / Thema / Notiz) ‚Ä¶">
      <button class="ghost" id="fuReset">Reset</button>
      <span class="pill" id="fuCount">‚Äî</span>
    </div>

    <div class="tblWrap" style="margin-top:12px;">
      <table>
        <thead>
          <tr>
            <th>F√§llig</th>
            <th>Partner</th>
            <th>Reiter</th>
            <th>Kontakt</th>
            <th>Anlass</th>
            <th>Thema</th>
            <th>Notiz</th>
          </tr>
        </thead>
        <tbody id="followupsTbody"></tbody>
      </table>
    </div>
  </main>

  <section class="card hidden" id="resultsCard" style="grid-column: 1 / -1;">
    <div style="display:flex; align-items:center; justify-content:space-between; gap:10px;">
      <div>
        <div class="h">Trefferliste</div>
        <div class="muted">Klicke einen Treffer, um den Datensatz zu √∂ffnen.</div>
      </div>
      <button class="ghost" id="btnCloseResults2">Schlie√üen</button>
    </div>
    <div class="tblWrap" style="margin-top:12px; max-height:420px;">
      <table>
        <thead>
          <tr>
            <th>Partner</th><th>Reiter</th><th>Rolle</th><th>MAK</th><th>Partnernr</th>
            <th>Name</th><th>Firma</th><th>E-Mail</th><th>Tel/Mobil</th><th>Ort</th>
          </tr>
        </thead>
        <tbody id="resultsTbody"></tbody>
      </table>
    </div>
  </section>
</div>

<script>
(() => {
  const APP_NAME = "Vertriebspartner Offline";
  const SAFE_FORMAT = "VP_SAFE_EXPORT_V1";
  const BUILD = "2026-01-19-v6-partner-goals-followup-filters";

  const PARTNERS = [
    { key:"fonds_finanz", name:"Fonds Finanz", hasMak:true },
    { key:"demv",        name:"DEMV",        hasMak:true },
    { key:"taures",      name:"Taures",      hasMak:false },
    { key:"tvd",         name:"TVD",         hasMak:false },
    { key:"wir_finanz",  name:"WIR-Finanz",  hasMak:false },
  ];

  // NEW storage keys
  const STORAGE_KEY = "vp_offline_db_v5";
  const SESSION_KEY = "vp_offline_session_v5";
  const USERS_KEY   = "vp_offline_users_v5";

  // OLD keys (auto-migration)
  const OLD_STORAGE_KEYS = [
    "vp_offline_db_v4","vp_offline_db_v3","vp_offline_db_v2","vp_offline_db_v1","vp_offline_db"
  ];

  const $ = (id) => document.getElementById(id);

  function todayISO(){ return new Date().toISOString().slice(0,10); }
  function nowISO(){ return new Date().toISOString(); }
  function uid(){ return Math.random().toString(36).slice(2,10)+"-"+Date.now().toString(36); }
  function safeJSONParse(s){ try{ return JSON.parse(s); }catch(e){ return null; } }

  function setStatus(text, kind=""){
    const p = $("statusPill");
    p.textContent = text;
    p.className = "pill " + (kind || "");
  }

  function escapeHTML(s){
    return (s||"").replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c]));
  }

  // money parse (accept "12.500", "12,500", "12 500", "‚Ç¨ 12.500,00")
  function moneyParse(v){
    if (v===null || v===undefined) return 0;
    let s = String(v).trim();
    if (!s) return 0;
    s = s.replace(/[‚Ç¨\s]/g,"");
    // if both , and . exist -> assume . thousands and , decimal
    if (s.includes(",") && s.includes(".")){
      s = s.replace(/\./g,"").replace(",",".");
    } else if (s.includes(",") && !s.includes(".")){
      // assume comma is decimal
      s = s.replace(",",".");
    }
    // remove thousands separators left
    s = s.replace(/(?!^)-/g,"").replace(/[^0-9.\-]/g,"");
    const n = parseFloat(s);
    return Number.isFinite(n) ? n : 0;
  }
  function moneyFmt(n){
    const x = Number(n||0);
    return x.toLocaleString("de-DE",{minimumFractionDigits:0, maximumFractionDigits:0});
  }

  // ========= Users / Session =========
  function loadUsers(){
    const raw = localStorage.getItem(USERS_KEY);
    const u = safeJSONParse(raw);
    if (u && Array.isArray(u.list)) return u;

    const seed = {
      list: [
        { user:"master", pass:"master", role:"master" },
        { user:"user1", pass:"user1", role:"staff" },
        { user:"user2", pass:"user2", role:"staff" },
      ],
      updatedAt: nowISO()
    };
    localStorage.setItem(USERS_KEY, JSON.stringify(seed));
    return seed;
  }

  function saveUsers(u){
    u.updatedAt = nowISO();
    localStorage.setItem(USERS_KEY, JSON.stringify(u));
  }

  function getSession(){
    const raw = localStorage.getItem(SESSION_KEY);
    return raw ? safeJSONParse(raw) : null;
  }

  function setSession(sess){
    if (!sess) localStorage.removeItem(SESSION_KEY);
    else localStorage.setItem(SESSION_KEY, JSON.stringify(sess));
    renderAll();
  }

  function sessionUserSafe(){
    const s = getSession();
    return (s && s.user) ? s.user : "unknown";
  }

  function initLoginUI(){
    const u = loadUsers();
    const dl = $("userList");
    dl.innerHTML = "";
    u.list.forEach(x => {
      const opt = document.createElement("option");
      opt.value = x.user;
      dl.appendChild(opt);
    });

    $("btnLogin").onclick = () => {
      const user = ($("loginUser").value || "").trim();
      const pass = ($("loginPass").value || "").trim();
      if (!user || !pass){
        $("loginHint").textContent = "Bitte Benutzer + Passwort eingeben";
        $("loginHint").className = "pill warn";
        return;
      }

      const users = loadUsers();
      const found = users.list.find(x => x.user === user);

      if (found){
        if (found.pass !== pass){
          $("loginHint").textContent = "Login fehlgeschlagen";
          $("loginHint").className = "pill bad";
          return;
        }
        setSession({ user: found.user, role: found.role, loginAt: nowISO() });
        $("loginHint").textContent = "OK";
        $("loginHint").className = "pill ok";
      } else {
        users.list.push({ user, pass, role:"staff" });
        saveUsers(users);
        initLoginUI();
        setSession({ user, role:"staff", loginAt: nowISO() });
        $("loginHint").textContent = "Neuer Benutzer angelegt";
        $("loginHint").className = "pill ok";
      }
    };

    $("btnClearLocal").onclick = () => {
      if (!confirm("Wirklich alle lokalen Daten (DB + Session) in diesem Browser l√∂schen?")) return;
      localStorage.removeItem(STORAGE_KEY);
      localStorage.removeItem(SESSION_KEY);
      renderAll();
    };
  }

  // ========= DB Model =========
  function baseRecord(partner){
    return {
      id: uid(),
      createdAt: nowISO(),
      updatedAt: nowISO(),
      updatedBy: sessionUserSafe(),
      partnerKey: partner.key,

      datum: todayISO(),
      rolle: "",
      partnerNummer: "",
      makNummer: partner.hasMak ? "" : undefined,

      favorit: false,
      vorname: "",
      nachname: "",
      name: "",
      firma: "",
      email: "",
      mobil: "",
      telefon: "",
      strasse: "",
      plz: "",
      ort: "",
      land: "DE",

      optin: false,
      onlineAbschluss: false,

      // Produktion je Reiter: Ziel + Ist je Sparte
      prod: {
        voll:    { ziel:"", ist:"" },
        beihilfe:{ ziel:"", ist:"" },
        zusatz:  { ziel:"", ist:"" },
        pflege:  { ziel:"", ist:"" },
        bkv:     { ziel:"", ist:"" },
        reise:   { ziel:"", ist:"" },
      },

      kontakte: [
        { id: uid(), datum: todayISO(), anlass:"", notiz:"", followUpDatum:"", followUpThema:"", followUpErledigt:false, createdAt: nowISO(), updatedAt: nowISO() }
      ],

      freiesFeld: "",
      custom: {}
    };
  }

  function defaultPartnerGoals(){
    const g = {};
    PARTNERS.forEach(p => g[p.key] = { ziel:"", erreicht:"" });
    return g;
  }

  function emptyDB(){
    const partners = {};
    PARTNERS.forEach(p => {
      const r = baseRecord(p);
      partners[p.key] = { key:p.key, customFields:[], records:[r], activeRecordId:r.id };
    });
    return {
      app: APP_NAME,
      format: "VP_DB",
      version: 6,
      createdAt: nowISO(),
      updatedAt: nowISO(),
      partnerGoals: defaultPartnerGoals(), // NEW
      partners
    };
  }

  function ensureSchema(db){
    if (!db || !db.partners) db = emptyDB();
    db.app ||= APP_NAME;
    db.format ||= "VP_DB";
    db.version = Math.max(Number(db.version||0), 6);

    // NEW: partner goals
    db.partnerGoals ||= {};
    PARTNERS.forEach(p=>{
      db.partnerGoals[p.key] ||= {};
      db.partnerGoals[p.key].ziel ??= "";
      db.partnerGoals[p.key].erreicht ??= "";
    });

    PARTNERS.forEach(p=>{
      if (!db.partners[p.key]) db.partners[p.key] = { key:p.key, customFields:[], records:[], activeRecordId:null };
      const ps = db.partners[p.key];
      ps.customFields ||= [];
      ps.records ||= [];
      if (ps.records.length === 0){
        const r = baseRecord(p);
        ps.records.push(r);
        ps.activeRecordId = r.id;
      }
      ps.activeRecordId ||= (ps.records[0] && ps.records[0].id);

      ps.records.forEach(r=>{
        r.custom ||= {};
        r.createdAt ||= nowISO();
        r.updatedAt ||= r.createdAt;
        r.updatedBy ||= "unknown";

        r.datum ||= todayISO();
        r.rolle ||= "";
        r.partnerNummer ||= "";
        r.makNummer ??= (p.hasMak ? "" : undefined);

        r.vorname ||= "";
        r.nachname ||= "";
        r.name ||= "";
        r.favorit ??= false;

        r.firma ||= "";
        r.email ||= "";
        r.mobil ||= "";
        r.telefon ||= "";
        r.strasse ||= "";
        r.plz ||= "";
        r.ort ||= "";
        r.land ||= "DE";

        r.optin ??= false;
        r.onlineAbschluss ??= false;

        // Production defaults + migrate old flat fields if any existed
        if (!r.prod || typeof r.prod !== "object") r.prod = {};
        const ensureBucket = (key) => {
          r.prod[key] ||= {};
          r.prod[key].ziel ??= "";
          r.prod[key].ist ??= "";
        };
        ["voll","beihilfe","zusatz","pflege","bkv","reise"].forEach(ensureBucket);

        if (!Array.isArray(r.kontakte)) r.kontakte = [];
        if (r.kontakte.length === 0){
          r.kontakte.push({ id: uid(), datum: todayISO(), anlass:"", notiz:"", followUpDatum:"", followUpThema:"", followUpErledigt:false, createdAt: nowISO(), updatedAt: nowISO() });
        }
        r.kontakte.forEach(k=>{
          k.id ||= uid();
          k.datum ||= "";
          k.anlass ||= "";
          k.notiz ||= "";
          k.followUpDatum ||= "";
          k.followUpThema ||= "";
          k.followUpErledigt ??= false;
          k.createdAt ||= nowISO();
          k.updatedAt ||= nowISO();
        });

        const full = `${(r.vorname||"").trim()} ${(r.nachname||"").trim()}`.trim();
        if (full) r.name = full;
      });
    });

    db.updatedAt = nowISO();
    return db;
  }

  function saveDB(db){
    db.updatedAt = nowISO();
    localStorage.setItem(STORAGE_KEY, JSON.stringify(db));
  }

  function migrateIfNeeded(){
    const hasNew = !!localStorage.getItem(STORAGE_KEY);
    if (hasNew) return;

    for (const k of OLD_STORAGE_KEYS){
      const raw = localStorage.getItem(k);
      const parsed = raw ? safeJSONParse(raw) : null;
      if (parsed && parsed.partners){
        localStorage.setItem(STORAGE_KEY, JSON.stringify(parsed));
        setStatus("Migration: alte Daten √ºbernommen", "ok");
        return;
      }
    }
  }

  // ========= Global state =========
  migrateIfNeeded();
  let DB = ensureSchema(safeJSONParse(localStorage.getItem(STORAGE_KEY))) || ensureSchema(emptyDB());
  saveDB(DB);

  let ACTIVE_PARTNER_KEY = PARTNERS[0].key;

  // Followup filters (NEW)
  let FOLLOW_FILTERS = { timeframe:"all", partner:"all", q:"" };

  function getPartnerState(key){ return DB.partners[key]; }
  function getActivePartner(){ return PARTNERS.find(p=>p.key===ACTIVE_PARTNER_KEY) || PARTNERS[0]; }
  function getActivePartnerState(){ return getPartnerState(ACTIVE_PARTNER_KEY); }
  function getActiveRecord(){
    const ps = getActivePartnerState();
    return ps.records.find(r=>r.id===ps.activeRecordId) || ps.records[0];
  }

  function touch(rec){
    rec.updatedAt = nowISO();
    rec.updatedBy = sessionUserSafe();
    saveDB(DB);
    $("autosavePill").textContent = "ok";
    $("autosavePill").className = "pill ok";
  }

  // ========= Labels / tabs =========
  function recordLabel(p, r, idx){
    const role = ((r.rolle || "").trim()) || "ohne Rolle";
    const fn = ((r.vorname||"").trim() + " " + (r.nachname||"").trim()).trim();
    const namePart = fn ? ` ¬∑ ${fn}` : "";
    const fav = r.favorit ? " ‚òÖ" : "";
    const mak = p.hasMak && (r.makNummer || "").trim() ? ` ¬∑ MAK ${r.makNummer.trim()}` : "";
    return `Reiter ${idx+1}${namePart} ¬∑ ${role}${mak}${fav}`;
  }

  function renderPartnerTabs(){
    const wrap = $("partnerTabs");
    wrap.innerHTML = "";
    PARTNERS.forEach(p=>{
      const b = document.createElement("button");
      b.textContent = p.name;
      b.className = p.key===ACTIVE_PARTNER_KEY ? "active" : "";
      b.onclick = () => {
        ACTIVE_PARTNER_KEY = p.key;
        document.body.setAttribute("data-partner", p.key);
        renderAll();
      };
      wrap.appendChild(b);
    });
  }

  function renderRecordSelect(){
    const p = getActivePartner();
    const ps = getActivePartnerState();
    const sel = $("recordSelect");
    sel.innerHTML = "";
    ps.records.forEach((r, idx)=>{
      const opt = document.createElement("option");
      opt.value = r.id;
      opt.textContent = recordLabel(p, r, idx);
      if (r.id===ps.activeRecordId) opt.selected = true;
      sel.appendChild(opt);
    });
  }

  function setFieldValue(id, value){
    const el = $(id);
    if (!el) return;
    el.value = value ?? "";
  }

  function renderForm(){
    const p = getActivePartner();
    const r = getActiveRecord();

    $("makWrap").style.display = p.hasMak ? "" : "none";

    setFieldValue("rolle", r.rolle);
    setFieldValue("partnerNummer", r.partnerNummer);
    setFieldValue("datum", r.datum || todayISO());
    if (p.hasMak) setFieldValue("mak", r.makNummer ?? "");

    setFieldValue("vorname", r.vorname);
    setFieldValue("nachname", r.nachname);
    setFieldValue("firma", r.firma);
    setFieldValue("email", r.email);
    setFieldValue("mobil", r.mobil);
    setFieldValue("telefon", r.telefon);
    setFieldValue("strasse", r.strasse);
    setFieldValue("plz", r.plz);
    setFieldValue("ort", r.ort);
    setFieldValue("land", r.land || "DE");

    $("favorit").checked = !!r.favorit;
    $("optin").checked = !!r.optin;
    $("online").checked = !!r.onlineAbschluss;

    // Produktion
    setFieldValue("pVollZiel", r.prod.voll.ziel);
    setFieldValue("pVollIst", r.prod.voll.ist);
    setFieldValue("pBeihilfeZiel", r.prod.beihilfe.ziel);
    setFieldValue("pBeihilfeIst", r.prod.beihilfe.ist);
    setFieldValue("pZusatzZiel", r.prod.zusatz.ziel);
    setFieldValue("pZusatzIst", r.prod.zusatz.ist);
    setFieldValue("pPflegeZiel", r.prod.pflege.ziel);
    setFieldValue("pPflegeIst", r.prod.pflege.ist);
    setFieldValue("pBkvZiel", r.prod.bkv.ziel);
    setFieldValue("pBkvIst", r.prod.bkv.ist);
    setFieldValue("pReiseZiel", r.prod.reise.ziel);
    setFieldValue("pReiseIst", r.prod.reise.ist);

    $("freiesFeld").value = r.freiesFeld || "";

    renderContacts();
    renderCustomFields();
  }

  function renderContacts(){
    const r = getActiveRecord();
    const wrap = $("contactsWrap");
    wrap.innerHTML = "";

    r.kontakte.forEach((k, idx)=>{
      const box = document.createElement("div");
      box.className = "card";
      box.style.padding = "12px";
      box.style.marginBottom = "10px";

      const head = document.createElement("div");
      head.style.display="flex";
      head.style.justifyContent="space-between";
      head.style.alignItems="center";
      head.style.gap="10px";
      head.innerHTML = `<div style="font-weight:900;">Kontakt ${idx+1}</div>
                        <div class="pill ${k.followUpDatum && !k.followUpErledigt ? "warn" : ""}">
                          ${k.followUpDatum && !k.followUpErledigt ? "Wiedervorlage offen" : "‚Äî"}
                        </div>`;
      box.appendChild(head);

      const row1 = document.createElement("div");
      row1.className="row";
      row1.style.marginTop="10px";
      row1.innerHTML = `
        <div class="field w3"><label>Kontakt-Datum</label><input type="date" data-k="${k.id}" data-f="datum"></div>
        <div class="field w3"><label>Anlass</label><input data-k="${k.id}" data-f="anlass"></div>
        <div class="field w6"><label>Notiz</label><input data-k="${k.id}" data-f="notiz"></div>`;
      box.appendChild(row1);

      const row2 = document.createElement("div");
      row2.className="row";
      row2.style.marginTop="10px";
      row2.innerHTML = `
        <div class="field w3"><label>Wiedervorlage-Datum</label><input type="date" data-k="${k.id}" data-f="followUpDatum"></div>
        <div class="field w6"><label>Thema</label><input data-k="${k.id}" data-f="followUpThema"></div>
        <div class="field w3"><label>Erledigt</label>
          <div style="display:flex; align-items:center; gap:10px; padding:10px 12px; border:1px solid rgba(11,27,51,.16); border-radius:14px; background:rgba(255,255,255,.92);">
            <input type="checkbox" data-k="${k.id}" data-f="followUpErledigt" style="width:auto; transform:scale(1.2);">
            <span class="muted">erledigt</span>
          </div>
        </div>`;
      box.appendChild(row2);

      const row3 = document.createElement("div");
      row3.className="row";
      row3.style.marginTop="10px";
      row3.innerHTML = `<button class="danger" data-del-k="${k.id}">Kontakt l√∂schen</button>`;
      box.appendChild(row3);

      wrap.appendChild(box);

      box.querySelectorAll("input[data-k]").forEach(inp=>{
        const fid = inp.getAttribute("data-f");
        if (inp.type==="checkbox") inp.checked = !!k[fid];
        else inp.value = k[fid] || "";

        const handler = () => {
          const kk = r.kontakte.find(x=>x.id===inp.getAttribute("data-k"));
          if (!kk) return;
          if (inp.type==="checkbox") kk[fid] = !!inp.checked;
          else kk[fid] = inp.value;
          kk.updatedAt = nowISO();
          touch(r);
          renderFollowupsGlobal();
        };
        inp.oninput = handler;
        inp.onchange = handler;
      });

      box.querySelectorAll("button[data-del-k]").forEach(btn=>{
        btn.onclick = () => {
          if (!confirm("Kontakt wirklich l√∂schen?")) return;
          r.kontakte = r.kontakte.filter(x=>x.id!==btn.getAttribute("data-del-k"));
          if (r.kontakte.length===0){
            r.kontakte.push({ id: uid(), datum: todayISO(), anlass:"", notiz:"", followUpDatum:"", followUpThema:"", followUpErledigt:false, createdAt: nowISO(), updatedAt: nowISO() });
          }
          touch(r);
          renderForm();
          renderFollowupsGlobal();
        };
      });
    });
  }

  function renderCustomFields(){
    const ps = getActivePartnerState();
    const r = getActiveRecord();
    const wrap = $("customFieldsWrap");
    wrap.innerHTML = "";

    if (!ps.customFields.length){
      wrap.innerHTML = `<div class="muted">Keine Zusatzfelder.</div>`;
      return;
    }

    const row = document.createElement("div");
    row.className = "row";

    ps.customFields.forEach(cf=>{
      const f = document.createElement("div");
      f.className = "field w6";
      f.innerHTML = `<label>${escapeHTML(cf.label)}</label>`;
      const id = "cf_"+cf.id;

      if (cf.type==="checkbox"){
        const container = document.createElement("div");
        container.style.display="flex";
        container.style.alignItems="center";
        container.style.gap="10px";
        container.style.padding="10px 12px";
        container.style.border="1px solid rgba(11,27,51,.16)";
        container.style.borderRadius="14px";
        container.style.background="rgba(255,255,255,.92)";
        container.innerHTML = `<input type="checkbox" id="${id}" style="width:auto; transform:scale(1.2);"><span class="muted">Ja/Nein</span>`;
        f.appendChild(container);
        const el = container.querySelector("input");
        el.checked = !!r.custom[cf.id];
        el.onchange = () => { r.custom[cf.id] = !!el.checked; touch(r); };
      } else if (cf.type==="textarea"){
        const el = document.createElement("textarea");
        el.id = id;
        el.value = r.custom[cf.id] || "";
        el.oninput = () => { r.custom[cf.id] = el.value; touch(r); };
        f.appendChild(el);
      } else {
        const el = document.createElement("input");
        el.id = id;
        el.value = r.custom[cf.id] || "";
        el.oninput = () => { r.custom[cf.id] = el.value; touch(r); };
        f.appendChild(el);
      }

      row.appendChild(f);
    });

    wrap.appendChild(row);
  }

  // ========= Followups global + Filters =========
  const DAY_MS = 24*60*60*1000;

  function parseISODateLocal(s){
    const m = /^([0-9]{4})-([0-9]{2})-([0-9]{2})$/.exec(String(s||"").trim());
    if (!m) return null;
    const y = parseInt(m[1],10), mo = parseInt(m[2],10), d = parseInt(m[3],10);
    const dt = new Date(y, mo-1, d);
    dt.setHours(0,0,0,0);
    return dt.getTime();
  }

  function todayStartMs(){
    const d = new Date();
    d.setHours(0,0,0,0);
    return d.getTime();
  }

  function startOfWeekMs(baseMs){
    const d = new Date(baseMs);
    const day = (d.getDay()+6)%7; // Monday=0
    d.setDate(d.getDate() - day);
    d.setHours(0,0,0,0);
    return d.getTime();
  }

  function initFollowupFiltersUI(){
    const chipWrap = $("fuTimeChips");
    const sel = $("fuPartner");

    if (!chipWrap || !sel) return;

    const chips = [
      { key:"all", label:"Alle" },
      { key:"today", label:"Heute" },
      { key:"week", label:"Diese Woche" },
      { key:"overdue", label:"√úberf√§llig" },
    ];

    chipWrap.innerHTML = "";
    chips.forEach(c=>{
      const b = document.createElement("button");
      b.className = "chip" + (FOLLOW_FILTERS.timeframe===c.key ? " active" : "");
      b.textContent = c.label;
      b.dataset.key = c.key;
      b.onclick = () => {
        FOLLOW_FILTERS.timeframe = c.key;
        applyFollowupFilterUI();
        renderFollowupsGlobal();
      };
      chipWrap.appendChild(b);
    });

    sel.innerHTML = "";
    const optAll = document.createElement("option");
    optAll.value = "all";
    optAll.textContent = "Alle Partner";
    sel.appendChild(optAll);

    PARTNERS.forEach(p=>{
      const o = document.createElement("option");
      o.value = p.key;
      o.textContent = p.name;
      sel.appendChild(o);
    });

    sel.value = FOLLOW_FILTERS.partner;
    sel.onchange = () => {
      FOLLOW_FILTERS.partner = sel.value;
      renderFollowupsGlobal();
    };

    const q = $("fuQ");
    if (q){
      q.value = FOLLOW_FILTERS.q || "";
      q.oninput = () => {
        FOLLOW_FILTERS.q = (q.value||"").toLowerCase().trim();
        renderFollowupsGlobal();
      };
    }

    const reset = $("fuReset");
    if (reset){
      reset.onclick = () => {
        FOLLOW_FILTERS = { timeframe:"all", partner:"all", q:"" };
        if ($("fuQ")) $("fuQ").value = "";
        if ($("fuPartner")) $("fuPartner").value = "all";
        applyFollowupFilterUI();
        renderFollowupsGlobal();
      };
    }

    applyFollowupFilterUI();
  }

  function applyFollowupFilterUI(){
    const chipWrap = $("fuTimeChips");
    if (!chipWrap) return;
    Array.from(chipWrap.querySelectorAll("button.chip")).forEach(btn=>{
      btn.classList.toggle("active", btn.dataset.key === FOLLOW_FILTERS.timeframe);
    });
  }

  function renderFollowupsGlobal(){
    const tb = $("followupsTbody");
    if (!tb) return;
    tb.innerHTML = "";
    const items = [];

    PARTNERS.forEach(p=>{
      const ps = getPartnerState(p.key);
      ps.records.forEach((r, ridx)=>{
        (r.kontakte||[]).forEach((k, kidx)=>{
          if (k.followUpDatum && !k.followUpErledigt){
            const dueT = parseISODateLocal(k.followUpDatum) ?? 9e15;
            items.push({ p, r, ridx, k, kidx, dueT });
          }
        });
      });
    });

    items.sort((a,b)=>a.dueT-b.dueT);

    // apply filters (NEW)
    const t0 = todayStartMs();
    const w0 = startOfWeekMs(t0);
    const w1 = w0 + 7*DAY_MS;

    let filtered = items;

    if (FOLLOW_FILTERS.partner !== "all"){
      filtered = filtered.filter(it => it.p.key === FOLLOW_FILTERS.partner);
    }

    if (FOLLOW_FILTERS.timeframe === "today"){
      filtered = filtered.filter(it => it.dueT >= t0 && it.dueT < t0 + DAY_MS);
    } else if (FOLLOW_FILTERS.timeframe === "week"){
      filtered = filtered.filter(it => it.dueT >= w0 && it.dueT < w1);
    } else if (FOLLOW_FILTERS.timeframe === "overdue"){
      filtered = filtered.filter(it => it.dueT < t0);
    }

    if (FOLLOW_FILTERS.q){
      const q = FOLLOW_FILTERS.q;
      filtered = filtered.filter(it => {
        const s = normalize([
          it.p.name, recordLabel(it.p,it.r,it.ridx),
          `Kontakt ${it.kidx+1}`,
          it.k.anlass||"", it.k.followUpThema||"", it.k.notiz||""
        ].join(" | "));
        return s.includes(q);
      });
    }

    const cnt = $("fuCount");
    if (cnt){
      const label = filtered.length === 1 ? "1 offen" : `${filtered.length} offen`;
      cnt.textContent = label;
      cnt.className = "pill " + (filtered.length ? "ok" : "warn");
    }

    if (!filtered.length){
      const tr=document.createElement("tr");
      tr.innerHTML = `<td colspan="7" class="muted">Keine offenen Wiedervorlagen (f√ºr diesen Filter).</td>`;
      tb.appendChild(tr);
      return;
    }

    filtered.slice(0,500).forEach(it=>{
      const tr=document.createElement("tr");
      tr.innerHTML = `
        <td><b>${escapeHTML(it.k.followUpDatum)}</b></td>
        <td>
          <span class="partnerDot" style="background:${partnerColor(it.p.key)}"></span>
          <span style="margin-left:8px; font-weight:900;">${escapeHTML(it.p.name)}</span>
        </td>
        <td><a href="#" data-open="1">${escapeHTML(recordLabel(it.p,it.r,it.ridx))}</a></td>
        <td>Kontakt ${it.kidx+1}</td>
        <td>${escapeHTML(it.k.anlass||"")}</td>
        <td>${escapeHTML(it.k.followUpThema||"")}</td>
        <td>${escapeHTML(it.k.notiz||"")}</td>`;
      tr.querySelector('a[data-open="1"]').onclick = (e)=>{
        e.preventDefault();
        ACTIVE_PARTNER_KEY = it.p.key;
        document.body.setAttribute("data-partner", it.p.key);
        const ps = getPartnerState(it.p.key);
        ps.activeRecordId = it.r.id;
        saveDB(DB);
        showPage("main");
        renderAll();
      };
      tb.appendChild(tr);
    });
  }

  function partnerColor(key){
    // match CSS palette
    if (key==="fonds_finanz") return "#2563eb";
    if (key==="demv") return "#059669";
    if (key==="taures") return "#7c3aed";
    if (key==="tvd") return "#ea580c";
    if (key==="wir_finanz") return "#0f766e";
    return "#1d4ed8";
  }

  // ========= Partner Goals (NEW) =========
  function goalKind(pct){
    if (pct >= 1) return "ok";
    if (pct >= 0.7) return "warn";
    return "bad";
  }

  function renderPartnerGoals(){
    const wrap = $("partnerGoalsWrap");
    if (!wrap) return;

    wrap.innerHTML = "";

    const outer = document.createElement("div");
    outer.className = "goalWrap";

    // Total row
    const totalRow = document.createElement("div");
    totalRow.className = "goalRow goalTotal";
    totalRow.innerHTML = `
      <div class="title"><span class="partnerDot"></span> <span>Gesamt Hauptpartner</span></div>
      <div class="goalInputs">
        <div class="field"><label>Ziel (‚Ç¨)</label><input data-goal="total" data-f="ziel" inputmode="decimal" placeholder="z. B. 100.000"></div>
        <div class="field"><label>Erreicht (‚Ç¨)</label><input data-goal="total" data-f="erreicht" inputmode="decimal" placeholder="z. B. 55.000"></div>
      </div>
      <div>
        <div class="progressBar" style="margin-top:6px;"><span data-bar="total"></span></div>
        <div class="muted" style="margin-top:6px;" data-sub="total"></div>
      </div>
      <div class="pct"><span class="pill" data-pill="total">‚Äî</span></div>
    `;
    outer.appendChild(totalRow);

    // Partner rows
    PARTNERS.forEach(p=>{
      const row = document.createElement("div");
      row.className = "goalRow";
      row.innerHTML = `
        <div class="title">
          <span class="partnerDot" style="background:${partnerColor(p.key)}"></span>
          <span>${escapeHTML(p.name)}</span>
        </div>
        <div class="goalInputs">
          <div class="field"><label>Ziel (‚Ç¨)</label><input data-goal="${p.key}" data-f="ziel" inputmode="decimal" placeholder="Ziel"></div>
          <div class="field"><label>Erreicht (‚Ç¨)</label><input data-goal="${p.key}" data-f="erreicht" inputmode="decimal" placeholder="Erreicht"></div>
        </div>
        <div>
          <div class="progressBar" style="margin-top:6px;"><span data-bar="${p.key}"></span></div>
          <div class="muted" style="margin-top:6px;" data-sub="${p.key}"></div>
        </div>
        <div class="pct"><span class="pill" data-pill="${p.key}">‚Äî</span></div>
      `;
      outer.appendChild(row);
    });

    wrap.appendChild(outer);

    // set values + bind
    wrap.querySelectorAll("input[data-goal]").forEach(inp=>{
      const key = inp.getAttribute("data-goal");
      const f = inp.getAttribute("data-f");
      if (key === "total"){
        // computed (read-only)
        inp.disabled = true;
        inp.title = "Wird automatisch aus den Partner-Zielen berechnet";
      } else {
        inp.value = DB.partnerGoals?.[key]?.[f] ?? "";
        inp.oninput = () => {
          DB.partnerGoals[key][f] = inp.value;
          saveDB(DB);
          updatePartnerGoalsComputed();
        };
      }
    });

    updatePartnerGoalsComputed();
  }

  function updatePartnerGoalsComputed(){
    const wrap = $("partnerGoalsWrap");
    if (!wrap) return;

    let totalZ = 0;
    let totalE = 0;

    PARTNERS.forEach(p=>{
      const g = DB.partnerGoals?.[p.key] || { ziel:"", erreicht:"" };
      const z = moneyParse(g.ziel);
      const e = moneyParse(g.erreicht);
      totalZ += z;
      totalE += e;

      const pct = z > 0 ? (e / z) : 0;
      const width = Math.max(0, Math.min(100, pct * 100));

      const bar = wrap.querySelector(`[data-bar="${p.key}"]`);
      if (bar) bar.style.width = width.toFixed(1) + "%";

      const sub = wrap.querySelector(`[data-sub="${p.key}"]`);
      if (sub) sub.textContent = `Ziel ${moneyFmt(z)} ‚Ç¨ ¬∑ Erreicht ${moneyFmt(e)} ‚Ç¨`;

      const pill = wrap.querySelector(`[data-pill="${p.key}"]`);
      if (pill){
        pill.textContent = z > 0 ? `${Math.round(width)}%` : "‚Äî";
        pill.className = "pill " + (z>0 ? goalKind(pct) : "");
      }
    });

    // Total (computed)
    const pctT = totalZ > 0 ? (totalE / totalZ) : 0;
    const widthT = Math.max(0, Math.min(100, pctT * 100));

    const inpZ = wrap.querySelector(`input[data-goal="total"][data-f="ziel"]`);
    const inpE = wrap.querySelector(`input[data-goal="total"][data-f="erreicht"]`);
    if (inpZ) inpZ.value = moneyFmt(totalZ);
    if (inpE) inpE.value = moneyFmt(totalE);

    const barT = wrap.querySelector(`[data-bar="total"]`);
    if (barT) barT.style.width = widthT.toFixed(1) + "%";

    const subT = wrap.querySelector(`[data-sub="total"]`);
    if (subT) subT.textContent = `Ziel ${moneyFmt(totalZ)} ‚Ç¨ ¬∑ Erreicht ${moneyFmt(totalE)} ‚Ç¨`;

    const pillT = wrap.querySelector(`[data-pill="total"]`);
    if (pillT){
      pillT.textContent = totalZ > 0 ? `${Math.round(widthT)}%` : "‚Äî";
      pillT.className = "pill " + (totalZ>0 ? goalKind(pctT) : "");
    }
  }

  // ========= Auswertung =========
  function sumAll(){
    const totals = {
      voll:{ziel:0, ist:0},
      beihilfe:{ziel:0, ist:0},
      zusatz:{ziel:0, ist:0},
      pflege:{ziel:0, ist:0},
      bkv:{ziel:0, ist:0},
      reise:{ziel:0, ist:0},
    };

    const byPartner = {};
    PARTNERS.forEach(p=>{
      byPartner[p.key] = {
        p,
        voll:{ziel:0, ist:0},
        beihilfe:{ziel:0, ist:0},
        zusatz:{ziel:0, ist:0},
        pflege:{ziel:0, ist:0},
        bkv:{ziel:0, ist:0},
        reise:{ziel:0, ist:0},
      };

      const ps = getPartnerState(p.key);
      ps.records.forEach(r=>{
        const add = (k) => {
          const z = moneyParse(r.prod?.[k]?.ziel);
          const i = moneyParse(r.prod?.[k]?.ist);
          totals[k].ziel += z; totals[k].ist += i;
          byPartner[p.key][k].ziel += z; byPartner[p.key][k].ist += i;
        };
        ["voll","beihilfe","zusatz","pflege","bkv","reise"].forEach(add);
      });
    });

    return { totals, byPartner };
  }

  function renderStats(){
    renderPartnerGoals(); // NEW

    const { totals, byPartner } = sumAll();

    const totalZiel =
      totals.voll.ziel + totals.beihilfe.ziel + totals.zusatz.ziel + totals.pflege.ziel + totals.bkv.ziel + totals.reise.ziel;
    const totalIst =
      totals.voll.ist + totals.beihilfe.ist + totals.zusatz.ist + totals.pflege.ist + totals.bkv.ist + totals.reise.ist;

    $("sumHint").textContent = `Gesamt: Ziel ${moneyFmt(totalZiel)} ‚Ç¨ ¬∑ Ist ${moneyFmt(totalIst)} ‚Ç¨`;
    $("sumHint").className = "pill ok";

    const kpi = (title, ziel, ist) => {
      const el = document.createElement("div");
      el.className = "kpi";
      el.innerHTML = `<b>${escapeHTML(title)}</b>
        <div class="big">Ziel ${moneyFmt(ziel)} ‚Ç¨</div>
        <div class="sub">Ist ${moneyFmt(ist)} ‚Ç¨</div>`;
      return el;
    };

    const g = $("kpiGrid");
    g.innerHTML = "";
    g.appendChild(kpi("Gesamt (alle Sparten)", totalZiel, totalIst));
    g.appendChild(kpi("Voll", totals.voll.ziel, totals.voll.ist));
    g.appendChild(kpi("Beihilfe", totals.beihilfe.ziel, totals.beihilfe.ist));
    g.appendChild(kpi("Zusatz", totals.zusatz.ziel, totals.zusatz.ist));
    g.appendChild(kpi("Pflege", totals.pflege.ziel, totals.pflege.ist));
    g.appendChild(kpi("bKV", totals.bkv.ziel, totals.bkv.ist));
    g.appendChild(kpi("Reise", totals.reise.ziel, totals.reise.ist));

    const tb = $("statsPartnerTbody");
    tb.innerHTML = "";

    PARTNERS.forEach(p=>{
      const s = byPartner[p.key];
      const zSum = s.voll.ziel+s.beihilfe.ziel+s.zusatz.ziel+s.pflege.ziel+s.bkv.ziel+s.reise.ziel;
      const iSum = s.voll.ist+s.beihilfe.ist+s.zusatz.ist+s.pflege.ist+s.bkv.ist+s.reise.ist;

      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td><span class="partnerDot" style="background:${partnerColor(p.key)}"></span>
            <span style="margin-left:8px;font-weight:900;">${escapeHTML(p.name)}</span></td>
        <td>${moneyFmt(s.voll.ziel)}</td><td>${moneyFmt(s.voll.ist)}</td>
        <td>${moneyFmt(s.beihilfe.ziel)}</td><td>${moneyFmt(s.beihilfe.ist)}</td>
        <td>${moneyFmt(s.zusatz.ziel)}</td><td>${moneyFmt(s.zusatz.ist)}</td>
        <td>${moneyFmt(s.pflege.ziel)}</td><td>${moneyFmt(s.pflege.ist)}</td>
        <td>${moneyFmt(s.bkv.ziel)}</td><td>${moneyFmt(s.bkv.ist)}</td>
        <td>${moneyFmt(s.reise.ziel)}</td><td>${moneyFmt(s.reise.ist)}</td>
        <td><b>${moneyFmt(zSum)}</b></td><td><b>${moneyFmt(iSum)}</b></td>
      `;
      tb.appendChild(tr);
    });
  }

  // ========= Search =========
  function normalize(s){ return (s||"").toString().toLowerCase().trim(); }
  function buildSearchText(p, r){
    const parts = [];
    parts.push(p.name, r.rolle, r.partnerNummer, r.makNummer, r.datum);
    parts.push(r.vorname, r.nachname, r.name, r.firma, r.email, r.mobil, r.telefon, r.strasse, r.plz, r.ort, r.land);
    parts.push(r.freiesFeld);
    (r.kontakte||[]).forEach(k=>parts.push(k.datum,k.anlass,k.notiz,k.followUpDatum,k.followUpThema,(k.followUpErledigt?"erledigt":"offen")));
    return normalize(parts.filter(Boolean).join(" | "));
  }

  function showResults(){
    const q = normalize($("q").value);
    const tb = $("resultsTbody");
    tb.innerHTML = "";
    const hits = [];

    PARTNERS.forEach(p=>{
      const ps = getPartnerState(p.key);
      ps.records.forEach((r, idx)=>{
        const txt = buildSearchText(p,r);
        if (!q || txt.includes(q)) hits.push({p,r,idx});
      });
    });

    hits.slice(0,400).forEach(h=>{
      const tr=document.createElement("tr");
      const nameShown = ((h.r.vorname||"").trim()+" "+(h.r.nachname||"").trim()).trim() || h.r.name || "";
      tr.innerHTML = `
        <td>${escapeHTML(h.p.name)}</td>
        <td><a href="#" data-open="1">${escapeHTML(recordLabel(h.p,h.r,h.idx))}</a></td>
        <td>${escapeHTML(h.r.rolle||"")}</td>
        <td>${escapeHTML(h.p.hasMak ? (h.r.makNummer||"") : "")}</td>
        <td>${escapeHTML(h.r.partnerNummer||"")}</td>
        <td>${escapeHTML(nameShown)}</td>
        <td>${escapeHTML(h.r.firma||"")}</td>
        <td>${escapeHTML(h.r.email||"")}</td>
        <td>${escapeHTML([h.r.telefon,h.r.mobil].filter(Boolean).join(" / "))}</td>
        <td>${escapeHTML(h.r.ort||"")}</td>`;
      tr.querySelector('a[data-open="1"]').onclick = (e)=>{
        e.preventDefault();
        ACTIVE_PARTNER_KEY = h.p.key;
        document.body.setAttribute("data-partner", h.p.key);
        const ps = getPartnerState(h.p.key);
        ps.activeRecordId = h.r.id;
        saveDB(DB);
        $("resultsCard").classList.add("hidden");
        showPage("main");
        renderAll();
      };
      tb.appendChild(tr);
    });

    $("resultsCard").classList.remove("hidden");
  }

  // ========= Helpers =========
  async function copyToClipboard(text){
    try{ await navigator.clipboard.writeText(text || ""); }
    catch(e){
      const ta=document.createElement("textarea");
      ta.value=text||"";
      document.body.appendChild(ta);
      ta.select();
      document.execCommand("copy");
      document.body.removeChild(ta);
    }
  }

  function toast(msg, kind="ok"){
    setStatus(msg, kind==="ok"?"ok":kind==="warn"?"warn":"bad");
    setTimeout(()=>setStatus("bereit",""), 2000);
  }

  function addRecord(){
    const p = getActivePartner();
    const ps = getActivePartnerState();
    const r = baseRecord(p);
    ps.records.push(r);
    ps.activeRecordId = r.id;
    saveDB(DB);
    renderAll();
  }

  function deleteRecord(){
    const ps = getActivePartnerState();
    if (ps.records.length<=1){ alert("Mindestens ein Reiter muss bleiben."); return; }
    const r = getActiveRecord();
    if (!confirm("Reiter wirklich l√∂schen?")) return;
    ps.records = ps.records.filter(x=>x.id!==r.id);
    ps.activeRecordId = ps.records[0].id;
    saveDB(DB);
    renderAll();
  }

  function addCustomField(){
    const ps = getActivePartnerState();
    const label = prompt("Feldname (Label):");
    if (!label) return;
    const type = prompt('Typ: "text" | "textarea" | "checkbox"', "text");
    const t = (type||"text").toLowerCase().trim();
    const allowed = ["text","textarea","checkbox"];
    ps.customFields.push({ id: uid(), label: label.trim(), type: allowed.includes(t)?t:"text" });
    saveDB(DB);
    renderAll();
  }

  function deleteCustomField(){
    const ps = getActivePartnerState();
    if (!ps.customFields.length){ alert("Keine Zusatzfelder vorhanden."); return; }
    const names = ps.customFields.map((c,i)=>`${i+1}: ${c.label} (${c.type})`).join("\n");
    const pick = prompt("Welche Nummer l√∂schen?\n"+names, "1");
    const n = parseInt(pick,10);
    if (!Number.isFinite(n) || n<1 || n>ps.customFields.length) return;
    const cf = ps.customFields[n-1];
    if (!confirm(`Feld "${cf.label}" wirklich l√∂schen?`)) return;
    ps.customFields = ps.customFields.filter(x=>x.id!==cf.id);
    ps.records.forEach(r=>{ if (r.custom && cf.id in r.custom) delete r.custom[cf.id]; });
    saveDB(DB);
    renderAll();
  }

  // ========= Exports / Imports =========
  function downloadBlob(filename, blob){
    const a=document.createElement("a");
    a.href = URL.createObjectURL(blob);
    a.download = filename;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(a.href);
  }

  function exportFull(){
    downloadBlob("vertriebspartner_backup_full.json", new Blob([JSON.stringify(DB, null, 2)], {type:"application/json"}));
  }

  function exportDelta(){
    const day = todayISO();
    const delta = { app: APP_NAME, format: "VP_DELTA", version: DB.version, exportedAt: nowISO(), partners:{}, partnerGoals: DB.partnerGoals };
    PARTNERS.forEach(p=>{
      const ps = getPartnerState(p.key);
      const recs = ps.records.filter(r => (r.updatedAt||"").slice(0,10) === day);
      if (recs.length){
        delta.partners[p.key] = { key:p.key, customFields: ps.customFields, records: recs, activeRecordId: ps.activeRecordId };
      }
    });
    downloadBlob(`vertriebspartner_delta_${day}.json`, new Blob([JSON.stringify(delta, null, 2)], {type:"application/json"}));
  }

  function csvCell(v){
    const s = (v===null||v===undefined) ? "" : String(v);
    if (/[;"\n\r]/.test(s)) return `"${s.replace(/"/g,'""')}"`;
    return s;
  }

  function exportCSV(){
    const rows = [];
    rows.push([
      "partner","reiter","datum","rolle","partnerNummer","mak","favorit",
      "vorname","nachname","firma","email","mobil","telefon","strasse","plz","ort","land",
      "optin","onlineAbschluss",
      "voll_ziel","voll_ist","beihilfe_ziel","beihilfe_ist","zusatz_ziel","zusatz_ist",
      "pflege_ziel","pflege_ist","bkv_ziel","bkv_ist","reise_ziel","reise_ist",
      "kontakte_count"
    ].join(";"));

    PARTNERS.forEach(p=>{
      const ps = getPartnerState(p.key);
      ps.records.forEach((r, idx)=>{
        rows.push([
          p.name, recordLabel(p,r,idx), r.datum||"", r.rolle||"", r.partnerNummer||"", (p.hasMak?(r.makNummer||""):""),
          (r.favorit?"Ja":"Nein"),
          r.vorname||"", r.nachname||"", r.firma||"", r.email||"",
          r.mobil||"", r.telefon||"", r.strasse||"", r.plz||"", r.ort||"", r.land||"",
          (r.optin?"Ja":"Nein"), (r.onlineAbschluss?"Ja":"Nein"),
          r.prod?.voll?.ziel||"", r.prod?.voll?.ist||"",
          r.prod?.beihilfe?.ziel||"", r.prod?.beihilfe?.ist||"",
          r.prod?.zusatz?.ziel||"", r.prod?.zusatz?.ist||"",
          r.prod?.pflege?.ziel||"", r.prod?.pflege?.ist||"",
          r.prod?.bkv?.ziel||"", r.prod?.bkv?.ist||"",
          r.prod?.reise?.ziel||"", r.prod?.reise?.ist||"",
          String((r.kontakte||[]).length)
        ].map(csvCell).join(";"));
      });
    });

    downloadBlob("vertriebspartner_export.csv", new Blob([rows.join("\n")], {type:"text/csv;charset=utf-8"}));
  }

  function quickHash(str){
    let h = 2166136261;
    for (let i=0;i<str.length;i++){
      h ^= str.charCodeAt(i);
      h = Math.imul(h, 16777619);
    }
    return (h>>>0).toString(16);
  }

  function exportSafeFull(){
    const payloadStr = JSON.stringify(DB);
    const safe = {
      format: SAFE_FORMAT,
      app: APP_NAME,
      build: BUILD,
      createdAt: nowISO(),
      createdBy: sessionUserSafe(),
      payloadHash: quickHash(payloadStr),
      payload: DB
    };
    downloadBlob(`SAFE_full_${todayISO()}.json`, new Blob([JSON.stringify(safe, null, 2)], {type:"application/json"}));
  }

  function unwrapIfSafe(json){
    if (json && json.format === SAFE_FORMAT && json.payload){
      const s = JSON.stringify(json.payload);
      const h = quickHash(s);
      if (json.payloadHash && json.payloadHash !== h){
        throw new Error("SAFE-Datei besch√§digt/ver√§ndert (Hash stimmt nicht).");
      }
      return json.payload;
    }
    return json;
  }

  function mergeIncomingIntoDB(incoming){
    const incPartners = incoming.partners || {};
    // NEW: partnerGoals merge (simple overwrite if present)
    if (incoming.partnerGoals && typeof incoming.partnerGoals === "object"){
      DB.partnerGoals ||= {};
      PARTNERS.forEach(p=>{
        const ig = incoming.partnerGoals[p.key];
        if (!ig) return;
        DB.partnerGoals[p.key] ||= { ziel:"", erreicht:"" };
        if ("ziel" in ig) DB.partnerGoals[p.key].ziel = ig.ziel;
        if ("erreicht" in ig) DB.partnerGoals[p.key].erreicht = ig.erreicht;
      });
    }

    PARTNERS.forEach(p=>{
      const inc = incPartners[p.key];
      if (!inc) return;

      const ps = getPartnerState(p.key);

      const byId = new Map(ps.customFields.map(c=>[c.id,c]));
      (inc.customFields || []).forEach(c=>{ if (!byId.has(c.id)) { ps.customFields.push(c); byId.set(c.id,c); } });

      const localById = new Map(ps.records.map(r=>[r.id,r]));
      (inc.records || []).forEach(rIn=>{
        const rLocal = localById.get(rIn.id);
        if (!rLocal){
          ps.records.push(rIn);
          localById.set(rIn.id, rIn);
        } else {
          const tL = Date.parse(rLocal.updatedAt||"") || 0;
          const tI = Date.parse(rIn.updatedAt||"") || 0;
          if (tI >= tL) Object.assign(rLocal, rIn);
        }
      });

      ps.activeRecordId ||= (ps.records[0] && ps.records[0].id);
    });

    DB = ensureSchema(DB);
    saveDB(DB);
  }

  function replaceDB(incomingDB){
    DB = ensureSchema(incomingDB);
    saveDB(DB);
  }

  async function readFiles(fileList){
    const files = Array.from(fileList || []);
    const arr = [];
    for (const f of files){
      const text = await f.text();
      const json = safeJSONParse(text);
      arr.push({ name:f.name, json });
    }
    return arr;
  }

  async function importMerge(files){
    const arr = await readFiles(files);
    let countOk = 0;

    for (const f of arr){
      if (!f.json){ alert(`Ung√ºltiges JSON: ${f.name}`); continue; }
      let incoming;
      try{ incoming = unwrapIfSafe(f.json); }
      catch(e){ alert(`Import abgebrochen: ${f.name}\n${e.message}`); continue; }

      if (incoming && incoming.partners){
        mergeIncomingIntoDB(incoming);
        countOk++;
      } else {
        alert(`Datei nicht erkannt: ${f.name}`);
      }
    }

    toast(`Import/Merge: ${countOk} Datei(en)`, countOk? "ok":"warn");
    renderAll();
  }

  async function importReplace(files){
    if (!confirm("IMPORT (REPLACE): lokale DB wird komplett ersetzt. Fortfahren?")) return;
    const arr = await readFiles(files);
    if (!arr.length) return;

    const f = arr[0];
    if (!f.json) return alert("Ung√ºltiges JSON.");
    let incoming;
    try{ incoming = unwrapIfSafe(f.json); }
    catch(e){ return alert(`Import abgebrochen:\n${e.message}`); }

    if (incoming && incoming.partners){
      replaceDB(incoming);
      toast("Replace-Import erfolgreich", "ok");
      renderAll();
    } else {
      alert("Datei enth√§lt keine g√ºltige DB.");
    }
  }

  // ========= Bind UI =========
  function bindMainInputs(){
    $("rolle").oninput = () => { const r=getActiveRecord(); r.rolle=$("rolle").value; touch(r); renderRecordSelect(); };
    $("partnerNummer").oninput = () => { const r=getActiveRecord(); r.partnerNummer=$("partnerNummer").value; touch(r); };
    $("datum").onchange = () => { const r=getActiveRecord(); r.datum=$("datum").value; touch(r); renderRecordSelect(); renderFollowupsGlobal(); };
    $("mak").oninput = () => { const r=getActiveRecord(); r.makNummer=$("mak").value; touch(r); renderRecordSelect(); };

    $("vorname").oninput = () => { const r=getActiveRecord(); r.vorname=$("vorname").value; r.name=`${(r.vorname||"").trim()} ${(r.nachname||"").trim()}`.trim(); touch(r); renderRecordSelect(); };
    $("nachname").oninput = () => { const r=getActiveRecord(); r.nachname=$("nachname").value; r.name=`${(r.vorname||"").trim()} ${(r.nachname||"").trim()}`.trim(); touch(r); renderRecordSelect(); };

    $("firma").oninput = () => { const r=getActiveRecord(); r.firma=$("firma").value; touch(r); };
    $("email").oninput = () => { const r=getActiveRecord(); r.email=$("email").value; touch(r); };

    $("mobil").oninput = () => { const r=getActiveRecord(); r.mobil=$("mobil").value; touch(r); };
    $("telefon").oninput = () => { const r=getActiveRecord(); r.telefon=$("telefon").value; touch(r); };

    $("strasse").oninput = () => { const r=getActiveRecord(); r.strasse=$("strasse").value; touch(r); };
    $("plz").oninput = () => { const r=getActiveRecord(); r.plz=$("plz").value; touch(r); };
    $("ort").oninput = () => { const r=getActiveRecord(); r.ort=$("ort").value; touch(r); };
    $("land").oninput = () => { const r=getActiveRecord(); r.land=$("land").value; touch(r); };

    $("favorit").onchange = () => { const r=getActiveRecord(); r.favorit=!!$("favorit").checked; touch(r); renderRecordSelect(); };
    $("optin").onchange = () => { const r=getActiveRecord(); r.optin=!!$("optin").checked; touch(r); };
    $("online").onchange = () => { const r=getActiveRecord(); r.onlineAbschluss=!!$("online").checked; touch(r); };

    // Produktion
    const bindProd = (id, bucket, key) => {
      $(id).oninput = () => { const r=getActiveRecord(); r.prod[bucket][key] = $(id).value; touch(r); if (!isHidden("statsCard")) renderStats(); };
    };
    bindProd("pVollZiel","voll","ziel"); bindProd("pVollIst","voll","ist");
    bindProd("pBeihilfeZiel","beihilfe","ziel"); bindProd("pBeihilfeIst","beihilfe","ist");
    bindProd("pZusatzZiel","zusatz","ziel"); bindProd("pZusatzIst","zusatz","ist");
    bindProd("pPflegeZiel","pflege","ziel"); bindProd("pPflegeIst","pflege","ist");
    bindProd("pBkvZiel","bkv","ziel"); bindProd("pBkvIst","bkv","ist");
    bindProd("pReiseZiel","reise","ziel"); bindProd("pReiseIst","reise","ist");

    $("freiesFeld").oninput = () => { const r=getActiveRecord(); r.freiesFeld=$("freiesFeld").value; touch(r); };

    $("btnAddContact").onclick = () => {
      const r=getActiveRecord();
      r.kontakte.push({ id: uid(), datum: todayISO(), anlass:"", notiz:"", followUpDatum:"", followUpThema:"", followUpErledigt:false, createdAt: nowISO(), updatedAt: nowISO() });
      touch(r);
      renderContacts();
      renderFollowupsGlobal();
    };

    $("btnCopyAddress").onclick = async () => {
      const r=getActiveRecord();
      const txt = [r.firma, r.strasse, `${r.plz} ${r.ort}`.trim(), r.land].filter(Boolean).join("\n");
      await copyToClipboard(txt);
      toast("Adresse kopiert","ok");
    };
    $("btnCopyPhone").onclick = async () => {
      const r=getActiveRecord();
      const txt = [r.telefon, r.mobil].filter(Boolean).join(" / ");
      await copyToClipboard(txt);
      toast("Tel/Mobil kopiert","ok");
    };
    $("btnCall").onclick = () => {
      const r=getActiveRecord();
      const num = (r.telefon || r.mobil || "").replace(/\s+/g,"");
      if (!num) return toast("Keine Nummer vorhanden","warn");
      window.location.href = "tel:"+num;
    };
    $("btnMail").onclick = () => {
      const r=getActiveRecord();
      if (!r.email) return toast("Keine E-Mail vorhanden","warn");
      window.location.href = "mailto:"+encodeURIComponent(r.email);
    };
  }

  function isHidden(id){ return $(id).classList.contains("hidden"); }

  function bindAllInputs(){
    $("btnPrint").onclick = () => window.print();
    $("btnLogout").onclick = () => setSession(null);

    $("btnNewTab").onclick = () => addRecord();
    $("btnDeleteTab").onclick = () => deleteRecord();

    $("recordSelect").onchange = (e) => {
      const ps = getActivePartnerState();
      ps.activeRecordId = e.target.value;
      saveDB(DB);
      renderAll();
    };

    $("btnNewField").onclick = () => addCustomField();
    $("btnDeleteField").onclick = () => deleteCustomField();

    $("btnExportDelta").onclick = () => exportDelta();
    $("btnExportFull").onclick = () => exportFull();
    $("btnExportSafeFull").onclick = () => exportSafeFull();
    $("btnExportCSV").onclick = () => exportCSV();

    $("btnImportMerge").onclick = () => { $("fileImport").dataset.mode="merge"; $("fileImport").click(); };
    $("btnImportReplace").onclick = () => { $("fileImport").dataset.mode="replace"; $("fileImport").click(); };

    $("fileImport").onchange = async (e) => {
      const mode = $("fileImport").dataset.mode || "merge";
      if (mode === "replace") await importReplace(e.target.files);
      else await importMerge(e.target.files);
      e.target.value = "";
    };

    $("btnFind").onclick = () => showResults();
    $("btnCloseResults").onclick = () => $("resultsCard").classList.add("hidden");
    $("btnCloseResults2").onclick = () => $("resultsCard").classList.add("hidden");

    $("tabMain").onclick = () => showPage("main");
    $("tabStats").onclick = () => showPage("stats");
    $("tabFollowups").onclick = () => showPage("followups");
  }

  function showPage(which){
    const main = $("mainCard");
    const stats = $("statsCard");
    const follow = $("followupsCard");

    $("tabMain").classList.remove("active");
    $("tabStats").classList.remove("active");
    $("tabFollowups").classList.remove("active");
    main.classList.add("hidden");
    stats.classList.add("hidden");
    follow.classList.add("hidden");

    if (which==="stats"){
      $("tabStats").classList.add("active");
      stats.classList.remove("hidden");
      renderStats();
    } else if (which==="followups"){
      $("tabFollowups").classList.add("active");
      follow.classList.remove("hidden");
      initFollowupFiltersUI(); // NEW
      renderFollowupsGlobal();
    } else {
      $("tabMain").classList.add("active");
      main.classList.remove("hidden");
    }
  }

  // ========= Render all =========
  function renderAll(){
    const raw = localStorage.getItem(STORAGE_KEY);
    DB = ensureSchema(safeJSONParse(raw)) || ensureSchema(emptyDB());
    saveDB(DB);

    const sess = getSession();
    const loggedIn = !!sess;

    $("who").textContent = loggedIn ? `${sess.user} (${sess.role})` : "nicht eingeloggt";

    $("loginCard").classList.toggle("hidden", loggedIn);
    $("navCard").classList.toggle("hidden", !loggedIn);

    if (!loggedIn){
      $("mainCard").classList.add("hidden");
      $("statsCard").classList.add("hidden");
      $("followupsCard").classList.add("hidden");
      setStatus("bereit","");
      return;
    }

    setStatus("eingeloggt","ok");
    document.body.setAttribute("data-partner", ACTIVE_PARTNER_KEY);

    renderPartnerTabs();
    renderRecordSelect();
    renderForm();

    // keep current page selection (default: main)
    if ($("tabStats").classList.contains("active")) showPage("stats");
    else if ($("tabFollowups").classList.contains("active")) showPage("followups");
    else showPage("main");
  }

  // ========= Init =========
  initLoginUI();
  bindAllInputs();
  bindMainInputs();
  initFollowupFiltersUI(); // NEW (safe to call early)
  renderAll();
})();
</script>
</body>
</html>
