<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Vertriebspartner (Offline)</title>
  <style>
    :root{
      --bg:#eef4ff;
      --panel:#ffffff;
      --text:#0b1b33;
      --muted:#51627a;
      --line:rgba(11,27,51,.12);
      --shadow:0 10px 28px rgba(11,27,51,.10);
      --radius:18px;

      --pf-main:#1d4ed8;
      --pf-soft:rgba(29,78,216,.14);
      --pf-soft2:rgba(29,78,216,.08);

      --green:rgba(16,185,129,.18);
      --amber:rgba(245,158,11,.18);
      --red:rgba(244,63,94,.18);
    }

    body[data-partner="fonds_finanz"]{ --pf-main:#2563eb; --pf-soft:rgba(37,99,235,.14); --pf-soft2:rgba(37,99,235,.08); }
    body[data-partner="demv"]{        --pf-main:#059669; --pf-soft:rgba(5,150,105,.14);  --pf-soft2:rgba(5,150,105,.08); }
    body[data-partner="taures"]{      --pf-main:#7c3aed; --pf-soft:rgba(124,58,237,.14); --pf-soft2:rgba(124,58,237,.08); }
    body[data-partner="tvd"]{         --pf-main:#ea580c; --pf-soft:rgba(234,88,12,.14);  --pf-soft2:rgba(234,88,12,.08); }
    body[data-partner="wir_finanz"]{  --pf-main:#0f766e; --pf-soft:rgba(15,118,110,.14); --pf-soft2:rgba(15,118,110,.08); }

    *{box-sizing:border-box}
    body{
      margin:0;
      font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;
      color:var(--text);
      background:
        radial-gradient(1200px 800px at 15% 12%, var(--pf-soft), transparent 55%),
        radial-gradient(1200px 800px at 85% 35%, var(--pf-soft2), transparent 55%),
        linear-gradient(180deg,#f7faff,var(--bg));
    }

    header{
      position:sticky; top:0; z-index:20;
      background:rgba(255,255,255,.75);
      backdrop-filter: blur(10px);
      border-bottom:1px solid var(--line);
    }
    .topbar{
      display:flex; align-items:center; gap:12px;
      padding:14px 16px;
      max-width:1280px; margin:0 auto;
    }
    .brand{display:flex; flex-direction:column; gap:4px; margin-right:8px}
    .brand b{font-size:18px}
    .mini{font-size:12px; color:var(--muted)}
    .pill{
      display:inline-flex; align-items:center; gap:8px;
      padding:6px 10px; border-radius:999px;
      border:1px solid var(--line);
      background:rgba(255,255,255,.8);
      font-size:12px; color:var(--muted);
      white-space:nowrap;
    }
    .pill.ok{border-color:rgba(16,185,129,.30); background:rgba(16,185,129,.10); color:#065f46}
    .pill.warn{border-color:rgba(245,158,11,.35); background:rgba(245,158,11,.12); color:#92400e}
    .pill.bad{border-color:rgba(244,63,94,.35); background:rgba(244,63,94,.12); color:#9f1239}
    .spacer{flex:1}

    .actions{display:flex; flex-wrap:wrap; gap:8px; justify-content:flex-end}
    button{
      appearance:none; border:1px solid var(--line);
      background:rgba(255,255,255,.9);
      padding:9px 12px; border-radius:12px;
      font-weight:600; cursor:pointer;
      box-shadow:0 1px 0 rgba(0,0,0,.03);
    }
    button:hover{border-color:rgba(29,78,216,.35)}
    button.primary{background:var(--pf-main); color:white; border-color:transparent}
    button.danger{background:rgba(244,63,94,.10); border-color:rgba(244,63,94,.35); color:#9f1239}
    button.ghost{background:transparent}
    button.tab{
      padding:8px 12px; border-radius:999px; background:transparent;
    }
    button.tab.active{
      background:var(--pf-soft);
      border-color:transparent;
      color:var(--pf-main);
    }

    .wrap{
      max-width:1280px; margin:18px auto;
      padding:0 16px 26px;
      display:grid;
      grid-template-columns: 360px 1fr;
      gap:16px;
      align-items:start;
    }

    .card{
      background:rgba(255,255,255,.86);
      border:1px solid var(--line);
      border-radius:var(--radius);
      box-shadow:var(--shadow);
      padding:16px;
    }
    .h{font-size:18px; font-weight:800}
    .muted{color:var(--muted); font-size:13px}
    .divider{height:1px; background:var(--line); margin:14px 0}

    .partnerTabs{display:flex; gap:8px; flex-wrap:wrap; margin-top:10px}
    .partnerTabs button{padding:8px 12px; border-radius:999px; background:rgba(255,255,255,.85)}
    .partnerTabs button.active{background:var(--pf-soft); border-color:transparent; color:var(--pf-main)}

    .row{display:flex; gap:10px; flex-wrap:wrap}
    .field{display:flex; flex-direction:column; gap:6px; flex:1; min-width:160px}
    .field.w2{flex:0 0 calc(16.666% - 10px); min-width:160px}
    .field.w3{flex:0 0 calc(25% - 10px); min-width:180px}
    .field.w4{flex:0 0 calc(33.333% - 10px); min-width:180px}
    .field.w5{flex:0 0 calc(41.666% - 10px); min-width:180px}
    .field.w6{flex:0 0 calc(50% - 10px); min-width:220px}
    .field.w12{flex:0 0 100%}

    label{font-size:12px; color:var(--muted); font-weight:700}
    input, select, textarea{
      border:1px solid rgba(11,27,51,.16);
      border-radius:14px;
      padding:12px 12px;
      font-size:14px;
      background:rgba(255,255,255,.92);
      outline:none;
    }
    input:focus, select:focus, textarea:focus{
      border-color:rgba(29,78,216,.45);
      box-shadow:0 0 0 4px rgba(29,78,216,.12);
    }
    textarea{min-height:90px; resize:vertical}

    .stammBox{
      border:1px solid color-mix(in srgb, var(--pf-main) 28%, transparent);
      background: linear-gradient(180deg, var(--pf-soft2), rgba(255,255,255,.92));
      border-radius:16px;
      padding:14px;
    }
    .stammTitle{
      display:flex; align-items:center; justify-content:space-between; gap:10px;
      margin-bottom:12px;
    }
    .tag{
      display:inline-flex; align-items:center; gap:8px;
      padding:6px 10px; border-radius:999px;
      background:var(--pf-soft);
      border:1px solid color-mix(in srgb, var(--pf-main) 35%, transparent);
      color:var(--pf-main);
      font-size:12px;
      font-weight:800;
      letter-spacing:.03em;
      text-transform:uppercase;
    }
    .iconRow{display:flex; gap:8px; flex-wrap:wrap; margin-top:10px}
    .iconBtn{
      display:inline-flex; align-items:center; gap:8px;
      padding:8px 10px; border-radius:999px;
      border:1px solid var(--line);
      background:rgba(255,255,255,.85);
      font-weight:700;
      cursor:pointer;
      font-size:12px;
    }
    .iconBtn:hover{border-color:rgba(29,78,216,.35)}
    .iconBtn.primary{background:var(--pf-main); color:#fff; border-color:transparent}

    table{width:100%; border-collapse:separate; border-spacing:0}
    th, td{font-size:12px; padding:10px 10px; border-bottom:1px solid var(--line); text-align:left; vertical-align:top}
    th{color:var(--muted); font-weight:800; background:rgba(255,255,255,.65); position:sticky; top:0}
    .tblWrap{max-height:360px; overflow:auto; border:1px solid var(--line); border-radius:14px; background:rgba(255,255,255,.7)}

    .hidden{display:none !important}

    @media (max-width: 1020px){ .wrap{grid-template-columns:1fr} }
    @media print{
      header, .no-print{display:none !important}
      body{background:#fff}
      .wrap{grid-template-columns:1fr; max-width:100%; padding:0}
      .card{box-shadow:none}
    }
  </style>
</head>

<body data-partner="fonds_finanz">
<header class="no-print">
  <div class="topbar">
    <div class="brand">
      <b>Vertriebspartner (Offline)</b>
      <div class="mini"><span id="who">nicht eingeloggt</span></div>
    </div>
    <span class="pill" id="statusPill">bereit</span>

    <div style="display:flex; gap:8px; align-items:center; flex-wrap:wrap; margin-left:8px;">
      <button class="tab active" id="tabMain">Hauptansicht</button>
      <button class="tab" id="tabStats">Auswertung</button>
    </div>

    <div class="spacer"></div>

    <div class="actions">
      <span class="pill">localStorage ¬∑ offline</span>
      <button id="btnPrint">Drucken</button>
      <button id="btnNewField">Neue Felder erstellen</button>
      <button class="danger" id="btnDeleteField">Feld l√∂schen</button>

      <button id="btnExportDelta">Export (Delta heute)</button>
      <button id="btnExportFull">Export (Voll)</button>
      <button class="primary" id="btnExportSafeFull">SAFE Export (Voll)</button>
      <button id="btnExportCSV">CSV Export</button>

      <button id="btnImportMerge">Import / Merge</button>
      <button class="danger" id="btnImportReplace">Import (Replace)</button>
      <input id="fileImport" type="file" accept="application/json" multiple class="hidden">

      <button class="danger" id="btnLogout">Logout</button>
    </div>
  </div>
</header>

<div class="wrap">
  <aside class="card" id="loginCard">
    <div class="h">Login (offline)</div>
    <div class="muted" style="margin-top:6px;">
      Diese App speichert lokal im Browser. F√ºr t√§gliches Zusammenf√ºhren bitte Export/Import nutzen.
    </div>

    <div class="row" style="margin-top:12px;">
      <div class="field w6">
        <label>Benutzer</label>
        <input id="loginUser" list="userList" placeholder="Benutzer eingeben‚Ä¶" autocomplete="username">
        <datalist id="userList"></datalist>
      </div>
      <div class="field w6">
        <label>Passwort</label>
        <input id="loginPass" type="password" placeholder="Passwort" autocomplete="current-password">
      </div>
    </div>

    <div class="row" style="margin-top:12px;">
      <button class="primary" id="btnLogin" style="width:180px">Login</button>
      <button class="ghost" id="btnClearLocal" title="L√∂scht nur die lokalen Daten dieses Browsers">Lokale Daten l√∂schen</button>
      <span class="pill" id="loginHint">‚Äî</span>
    </div>

    <div class="divider"></div>

    <div class="mini">
      <div><b>Wichtig:</b> ‚ÄûLokale Daten l√∂schen‚Äú entfernt die komplette DB dieses Browsers.</div>
      <div>Restore danach: <b>Import (Replace)</b> mit einer Voll-Datei.</div>
    </div>
  </aside>

  <aside class="card hidden" id="navCard">
    <div class="h">Partner</div>
    <div class="partnerTabs" id="partnerTabs"></div>

    <div class="divider"></div>

    <div class="h">Reiter / Datensatz</div>
    <select id="recordSelect" style="margin-top:10px;"></select>

    <div class="row" style="margin-top:10px;">
      <button id="btnNewTab">+ Neuer Reiter</button>
      <button class="danger" id="btnDeleteTab">Reiter l√∂schen</button>
    </div>

    <div class="divider"></div>

    <div class="h">Suche</div>
    <input id="q" placeholder="Name / Firma / E-Mail / Rolle / MAK / Anlass ‚Ä¶">
    <div class="muted" style="margin-top:6px;">Suche innerhalb der lokal gespeicherten Daten.</div>

    <div class="row" style="margin-top:10px;">
      <button id="btnFind">Trefferliste</button>
      <button class="ghost" id="btnCloseResults">Schlie√üen</button>
    </div>

    <div class="divider"></div>

    <div class="mini">
      <div><b>Team-Workflow:</b></div>
      <ol style="margin:8px 0 0 18px;padding:0;">
        <li>Mitarbeiter: Export (Delta heute)</li>
        <li>Master: Import/Merge (alle Deltas)</li>
        <li>Master: SAFE Export (Voll) zur√ºck an Team</li>
      </ol>
    </div>
  </aside>

  <main class="card hidden" id="mainCard">
    <div style="display:flex; align-items:flex-start; gap:12px; justify-content:space-between;">
      <div>
        <div class="h">Datensatz</div>
        <div class="muted">Autosave: √Ñnderungen werden sofort lokal gespeichert.</div>
      </div>
      <div class="pill ok" id="autosavePill">ok</div>
    </div>

    <div class="row" style="margin-top:12px;">
      <div class="field w5">
        <label>Rolle (frei)</label>
        <input id="rolle" placeholder="z. B. RDPartner / DirektPartner / Account / ‚Ä¶">
      </div>

      <div class="field w3">
        <label>Partnernummer</label>
        <input id="partnerNummer" placeholder="Partnernummer">
      </div>

      <div class="field w2" id="makWrap">
        <label>MAK (nur Fonds/DEMV)</label>
        <input id="mak" placeholder="MAK-Nummer">
      </div>

      <div class="field w2">
        <label>Datum (Reiter)</label>
        <input id="datum" type="date">
      </div>
    </div>

    <div class="stammBox" style="margin-top:14px;">
      <div class="stammTitle">
        <div class="tag">Stammdaten</div>
        <div class="mini">Vorname ¬∑ Nachname ¬∑ Firma ¬∑ E-Mail ¬∑ Tel/Mobil ¬∑ Adresse</div>
      </div>

      <div class="row">
        <div class="field w6"><label>Vorname</label><input id="vorname" placeholder="Vorname"></div>
        <div class="field w6"><label>Nachname</label><input id="nachname" placeholder="Nachname"></div>
      </div>

      <div class="row" style="margin-top:10px;">
        <div class="field w6"><label>Firma</label><input id="firma" placeholder="Unternehmen / Einheit"></div>
        <div class="field w6"><label>E-Mail</label><input id="email" placeholder="name@firma.de"></div>
      </div>

      <div class="row" style="margin-top:10px;">
        <div class="field w6"><label>Mobil</label><input id="mobil" type="tel" placeholder="+49 ‚Ä¶"></div>
        <div class="field w6"><label>Telefon</label><input id="telefon" type="tel" placeholder="z. B. 0711 ‚Ä¶"></div>
      </div>

      <div class="row" style="margin-top:10px;">
        <div class="field w6"><label>Stra√üe</label><input id="strasse" placeholder="Stra√üe + Nr."></div>
        <div class="field w2"><label>PLZ</label><input id="plz" placeholder="12345"></div>
        <div class="field w4"><label>Ort</label><input id="ort" placeholder="Ort"></div>
        <div class="field w2"><label>Land</label><input id="land" placeholder="DE"></div>
      </div>

      <div class="row" style="margin-top:10px;">
        <div class="field w4">
          <label>Favorit</label>
          <div style="display:flex; align-items:center; gap:10px;">
            <input id="favorit" type="checkbox" style="width:auto; transform:scale(1.2);">
            <span class="muted">‚òÖ im Reiter</span>
          </div>
        </div>
        <div class="field w4">
          <label>Optin</label>
          <div style="display:flex; align-items:center; gap:10px;">
            <input id="optin" type="checkbox" style="width:auto; transform:scale(1.2);">
            <span class="muted">Einwilligung liegt vor</span>
          </div>
        </div>
        <div class="field w4">
          <label>Online Abschluss</label>
          <div style="display:flex; align-items:center; gap:10px;">
            <input id="online" type="checkbox" style="width:auto; transform:scale(1.2);">
            <span class="muted">online Abschluss</span>
          </div>
        </div>
      </div>

      <div class="iconRow">
        <button class="iconBtn" id="btnCopyAddress">üìç Adresse kopieren</button>
        <button class="iconBtn" id="btnCopyPhone">üìû Tel/Mobil kopieren</button>
        <button class="iconBtn" id="btnCall">üìû Anrufen</button>
        <button class="iconBtn primary" id="btnMail">‚úâÔ∏è E-Mail</button>
      </div>
    </div>

    <div class="divider"></div>

    <div class="h">Kontakt-Historie (inkl. Wiedervorlage)</div>
    <div class="muted" style="margin-top:6px;">
      Jeder Kontakt enth√§lt optional eine Wiedervorlage (Datum + Thema) und ‚Äûerledigt‚Äú.
    </div>
    <div id="contactsWrap" style="margin-top:12px;"></div>

    <div class="row" style="margin-top:10px;">
      <button id="btnAddContact">+ Kontakt hinzuf√ºgen</button>
    </div>

    <div class="divider"></div>

    <div class="h">Freies Feld</div>
    <textarea id="freiesFeld" placeholder="Notizen ‚Ä¶" style="margin-top:10px;"></textarea>

    <div class="divider"></div>

    <div class="h">Zusatzfelder (Custom)</div>
    <div class="muted" style="margin-top:6px;">Partnerbezogene Zusatzfelder (√ºber ‚ÄûNeue Felder erstellen‚Äú).</div>
    <div id="customFieldsWrap" style="margin-top:12px;"></div>
  </main>

  <main class="card hidden" id="statsCard">
    <div class="h">Auswertung</div>
    <div class="muted" style="margin-top:6px;">
      Globale Wiedervorlagen-√úbersicht √ºber alle Partner.
    </div>

    <div class="divider"></div>

    <div class="h">Offene Wiedervorlagen (global)</div>
    <div class="tblWrap" style="margin-top:12px;">
      <table>
        <thead>
        <tr>
          <th>F√§llig</th><th>Partner</th><th>Reiter</th><th>Kontakt</th><th>Anlass</th><th>Thema</th><th>Notiz</th>
        </tr>
        </thead>
        <tbody id="followupsTbody"></tbody>
      </table>
    </div>
  </main>

  <section class="card hidden" id="resultsCard" style="grid-column: 1 / -1;">
    <div style="display:flex; align-items:center; justify-content:space-between; gap:10px;">
      <div>
        <div class="h">Trefferliste</div>
        <div class="muted">Klicke einen Treffer, um den Datensatz zu √∂ffnen.</div>
      </div>
      <button class="ghost" id="btnCloseResults2">Schlie√üen</button>
    </div>
    <div class="tblWrap" style="margin-top:12px; max-height:420px;">
      <table>
        <thead>
        <tr>
          <th>Partner</th><th>Reiter</th><th>Rolle</th><th>MAK</th><th>Partnernr</th><th>Name</th><th>Firma</th><th>E-Mail</th><th>Tel/Mobil</th><th>Ort</th>
        </tr>
        </thead>
        <tbody id="resultsTbody"></tbody>
      </table>
    </div>
  </section>
</div>

<script>
(() => {
  // ========= Config =========
  const APP_NAME = "Vertriebspartner Offline";
  const APP_FORMAT = "VP_SAFE_EXPORT_V1";
  const APP_BUILD = "2026-01-16-importfix";

  const PARTNERS = [
    { key:"fonds_finanz", name:"Fonds Finanz", hasMak:true },
    { key:"demv",        name:"DEMV",        hasMak:true },
    { key:"taures",      name:"Taures",      hasMak:false },
    { key:"tvd",         name:"TVD",         hasMak:false },
    { key:"wir_finanz",  name:"WIR-Finanz",  hasMak:false },
  ];

  // IMPORTANT: Stable storage keys (do not change later)
  const STORAGE_KEY = "vp_offline_db_v3";
  const SESSION_KEY = "vp_offline_session_v3";
  const USERS_KEY   = "vp_offline_users_v3";

  const $ = (id) => document.getElementById(id);

  function todayISO(){ return new Date().toISOString().slice(0,10); }
  function nowISO(){ return new Date().toISOString(); }
  function uid(){ return Math.random().toString(36).slice(2,10)+"-"+Date.now().toString(36); }

  function safeJSONParse(s){ try{ return JSON.parse(s); }catch(e){ return null; } }

  function setStatus(text, kind=""){
    const p = $("statusPill");
    p.textContent = text;
    p.className = "pill " + (kind || "");
  }

  // ========= Users / Session =========
  function loadUsers(){
    const raw = localStorage.getItem(USERS_KEY);
    const u = safeJSONParse(raw);
    if (u && Array.isArray(u.list)) return u;

    const seed = {
      list: [
        { user:"master", pass:"master123", role:"master123" },
        { user:"user1", pass:"user1", role:"staff" },
        { user:"user2", pass:"user2", role:"staff" },
      ],
      updatedAt: nowISO()
    };
    localStorage.setItem(USERS_KEY, JSON.stringify(seed));
    return seed;
  }

  function saveUsers(u){
    u.updatedAt = nowISO();
    localStorage.setItem(USERS_KEY, JSON.stringify(u));
  }

  function getSession(){
    const raw = localStorage.getItem(SESSION_KEY);
    return raw ? safeJSONParse(raw) : null;
  }

  function setSession(sess){
    if (!sess) localStorage.removeItem(SESSION_KEY);
    else localStorage.setItem(SESSION_KEY, JSON.stringify(sess));
    renderAll();
  }

  function sessionUserSafe(){
    const s = getSession();
    return (s && s.user) ? s.user : "unknown";
  }

  function initLoginUI(){
    const u = loadUsers();
    const dl = $("userList");
    dl.innerHTML = "";
    u.list.forEach(x => {
      const opt = document.createElement("option");
      opt.value = x.user;
      dl.appendChild(opt);
    });

    $("btnLogin").onclick = () => {
      const user = ($("loginUser").value || "").trim();
      const pass = ($("loginPass").value || "").trim();
      if (!user || !pass){
        $("loginHint").textContent = "Bitte Benutzer + Passwort eingeben";
        $("loginHint").className = "pill warn";
        return;
      }

      const users = loadUsers();
      const found = users.list.find(x => x.user === user);

      if (found){
        if (found.pass !== pass){
          $("loginHint").textContent = "Login fehlgeschlagen";
          $("loginHint").className = "pill bad";
          return;
        }
        setSession({ user: found.user, role: found.role, loginAt: nowISO() });
        $("loginHint").textContent = "OK";
        $("loginHint").className = "pill ok";
      } else {
        users.list.push({ user, pass, role:"staff" });
        saveUsers(users);
        initLoginUI();
        setSession({ user, role:"staff", loginAt: nowISO() });
        $("loginHint").textContent = "Neuer Benutzer angelegt";
        $("loginHint").className = "pill ok";
      }
    };

    $("btnClearLocal").onclick = () => {
      if (!confirm("Wirklich alle lokalen Daten (DB + Session) in diesem Browser l√∂schen?")) return;
      localStorage.removeItem(STORAGE_KEY);
      localStorage.removeItem(SESSION_KEY);
      renderAll();
    };
  }

  // ========= DB Model =========
  function emptyDB(){
    const partners = {};
    PARTNERS.forEach(p => {
      partners[p.key] = {
        key: p.key,
        customFields: [],
        records: [],
        activeRecordId: null
      };
      const r = baseRecord(p);
      partners[p.key].records.push(r);
      partners[p.key].activeRecordId = r.id;
    });
    return {
      app: APP_NAME,
      format: "VP_DB",
      version: 3,
      createdAt: nowISO(),
      updatedAt: nowISO(),
      partners
    };
  }

  function baseRecord(partner){
    return {
      id: uid(),
      createdAt: nowISO(),
      updatedAt: nowISO(),
      updatedBy: sessionUserSafe(),
      partnerKey: partner.key,

      datum: todayISO(),
      rolle: "",
      partnerNummer: "",
      makNummer: partner.hasMak ? "" : undefined,

      favorit: false,
      vorname: "",
      nachname: "",
      name: "",
      firma: "",
      email: "",
      mobil: "",
      telefon: "",
      strasse: "",
      plz: "",
      ort: "",
      land: "DE",

      optin: false,
      onlineAbschluss: false,

      // yearly manual (kept for future pages)
      gesamtZiel:"", gesamtIst:"", vollZiel:"", vollIst:"",
      beihilfeZiel:"", beihilfeIst:"", zusatzZiel:"", zusatzIst:"",
      pflegeZiel:"", pflegeIst:"", bkvZiel:"", bkvIst:"",
      reiseZiel:"", reiseIst:"",

      kontakte: [
        { id: uid(), datum: todayISO(), anlass:"", notiz:"", followUpDatum:"", followUpThema:"", followUpErledigt:false, createdAt: nowISO(), updatedAt: nowISO() }
      ],

      freiesFeld: "",
      custom: {}
    };
  }

  // ---- schema ensure WITHOUT reloading localStorage (IMPORT FIX)
  function ensureSchema(db){
    if (!db || !db.partners) db = emptyDB();

    PARTNERS.forEach(p => {
      if (!db.partners[p.key]) db.partners[p.key] = { key:p.key, customFields:[], records:[], activeRecordId:null };
      const ps = db.partners[p.key];

      ps.customFields ||= [];
      ps.records ||= [];

      if (ps.records.length === 0){
        const r = baseRecord(p);
        ps.records.push(r);
        ps.activeRecordId = r.id;
      }

      ps.activeRecordId ||= (ps.records[0] && ps.records[0].id);

      ps.records.forEach(r => {
        r.custom ||= {};
        r.updatedAt ||= r.createdAt || nowISO();
        r.createdAt ||= r.updatedAt || nowISO();
        r.updatedBy ||= "unknown";

        r.datum ||= todayISO();
        r.rolle ||= "";
        r.partnerNummer ||= "";
        r.makNummer ??= (p.hasMak ? "" : undefined);

        r.vorname ||= "";
        r.nachname ||= "";
        r.name ||= "";
        r.favorit ??= false;

        r.firma ||= "";
        r.email ||= "";
        r.mobil ||= "";
        r.telefon ||= "";
        r.strasse ||= "";
        r.plz ||= "";
        r.ort ||= "";
        r.land ||= "DE";

        r.optin ??= false;
        r.onlineAbschluss ??= false;

        r.gesamtZiel ??= ""; r.gesamtIst ??= "";
        r.vollZiel ??= ""; r.vollIst ??= "";
        r.beihilfeZiel ??= ""; r.beihilfeIst ??= "";
        r.zusatzZiel ??= ""; r.zusatzIst ??= "";
        r.pflegeZiel ??= ""; r.pflegeIst ??= "";
        r.bkvZiel ??= ""; r.bkvIst ??= "";
        r.reiseZiel ??= ""; r.reiseIst ??= "";

        if (!Array.isArray(r.kontakte)) r.kontakte = [];
        if (r.kontakte.length === 0){
          r.kontakte.push({ id: uid(), datum: todayISO(), anlass:"", notiz:"", followUpDatum:"", followUpThema:"", followUpErledigt:false, createdAt: nowISO(), updatedAt: nowISO() });
        }
        r.kontakte.forEach(k => {
          k.id ||= uid();
          k.datum ||= "";
          k.anlass ||= "";
          k.notiz ||= "";
          k.followUpDatum ||= "";
          k.followUpThema ||= "";
          k.followUpErledigt ??= false;
          k.createdAt ||= nowISO();
          k.updatedAt ||= nowISO();
        });

        const full = `${(r.vorname||"").trim()} ${(r.nachname||"").trim()}`.trim();
        if (full) r.name = full;
      });
    });

    db.updatedAt = nowISO();
    return db;
  }

  function loadDB(){
    const raw = localStorage.getItem(STORAGE_KEY);
    const parsed = raw ? safeJSONParse(raw) : null;
    DB = ensureSchema(parsed);
    saveDB(DB);
    return DB;
  }

  function saveDB(db){
    db.updatedAt = nowISO();
    localStorage.setItem(STORAGE_KEY, JSON.stringify(db));
  }

  let DB = loadDB();
  let ACTIVE_PARTNER_KEY = PARTNERS[0].key;

  function getActivePartner(){ return PARTNERS.find(p => p.key === ACTIVE_PARTNER_KEY) || PARTNERS[0]; }
  function getPartnerState(key){ return DB.partners[key]; }
  function getActivePartnerState(){ return getPartnerState(ACTIVE_PARTNER_KEY); }
  function getActiveRecord(){
    const ps = getActivePartnerState();
    return ps.records.find(r => r.id === ps.activeRecordId) || ps.records[0];
  }

  function touch(rec){
    rec.updatedAt = nowISO();
    rec.updatedBy = sessionUserSafe();
    saveDB(DB);
    $("autosavePill").textContent = "ok";
    $("autosavePill").className = "pill ok";
  }

  // ========= UI =========
  function recordLabel(p, r, idx){
    const role = ((r.rolle || "").trim()) || "ohne Rolle";
    const fn = ((r.vorname||"").trim() + " " + (r.nachname||"").trim()).trim();
    const namePart = fn ? ` ¬∑ ${fn}` : "";
    const fav = r.favorit ? " ‚òÖ" : "";
    const mak = p.hasMak && (r.makNummer || "").trim() ? ` ¬∑ MAK ${r.makNummer.trim()}` : "";
    return `Reiter ${idx+1}${namePart} ¬∑ ${role}${mak}${fav}`;
  }

  function renderPartnerTabs(){
    const wrap = $("partnerTabs");
    wrap.innerHTML = "";
    PARTNERS.forEach(p => {
      const b = document.createElement("button");
      b.textContent = p.name;
      b.className = (p.key === ACTIVE_PARTNER_KEY) ? "active" : "";
      b.onclick = () => {
        ACTIVE_PARTNER_KEY = p.key;
        document.body.setAttribute("data-partner", p.key);
        renderAll();
      };
      wrap.appendChild(b);
    });
  }

  function renderRecordSelect(){
    const p = getActivePartner();
    const ps = getActivePartnerState();
    const sel = $("recordSelect");
    sel.innerHTML = "";
    ps.records.forEach((r, idx) => {
      const opt = document.createElement("option");
      opt.value = r.id;
      opt.textContent = recordLabel(p, r, idx);
      if (r.id === ps.activeRecordId) opt.selected = true;
      sel.appendChild(opt);
    });
  }

  function setFieldValue(id, value){
    const el = $(id);
    if (!el) return;
    el.value = value ?? "";
  }

  function renderForm(){
    const p = getActivePartner();
    const r = getActiveRecord();

    $("makWrap").style.display = p.hasMak ? "" : "none";

    setFieldValue("rolle", r.rolle);
    setFieldValue("partnerNummer", r.partnerNummer);
    setFieldValue("datum", r.datum || todayISO());
    if (p.hasMak) setFieldValue("mak", r.makNummer ?? "");

    setFieldValue("vorname", r.vorname);
    setFieldValue("nachname", r.nachname);
    setFieldValue("firma", r.firma);
    setFieldValue("email", r.email);
    setFieldValue("mobil", r.mobil);
    setFieldValue("telefon", r.telefon);
    setFieldValue("strasse", r.strasse);
    setFieldValue("plz", r.plz);
    setFieldValue("ort", r.ort);
    setFieldValue("land", r.land || "DE");

    $("favorit").checked = !!r.favorit;
    $("optin").checked = !!r.optin;
    $("online").checked = !!r.onlineAbschluss;

    $("freiesFeld").value = r.freiesFeld || "";

    renderContacts();
    renderCustomFields();
  }

  function renderContacts(){
    const r = getActiveRecord();
    const wrap = $("contactsWrap");
    wrap.innerHTML = "";

    r.kontakte.forEach((k, idx) => {
      const box = document.createElement("div");
      box.className = "card";
      box.style.padding = "12px";
      box.style.marginBottom = "10px";

      const head = document.createElement("div");
      head.style.display = "flex";
      head.style.justifyContent = "space-between";
      head.style.alignItems = "center";
      head.style.gap = "10px";
      head.innerHTML = `<div style="font-weight:900;">Kontakt ${idx+1}</div>
                        <div class="pill ${k.followUpDatum && !k.followUpErledigt ? "warn" : ""}">
                          ${k.followUpDatum && !k.followUpErledigt ? "Wiedervorlage offen" : "‚Äî"}
                        </div>`;
      box.appendChild(head);

      const row1 = document.createElement("div");
      row1.className = "row";
      row1.style.marginTop = "10px";
      row1.innerHTML = `
        <div class="field w3"><label>Kontakt-Datum</label><input type="date" data-k="${k.id}" data-f="datum"></div>
        <div class="field w3"><label>Anlass</label><input data-k="${k.id}" data-f="anlass" placeholder="Anlass"></div>
        <div class="field w6"><label>Notiz</label><input data-k="${k.id}" data-f="notiz" placeholder="Notiz"></div>
      `;
      box.appendChild(row1);

      const row2 = document.createElement("div");
      row2.className = "row";
      row2.style.marginTop = "10px";
      row2.innerHTML = `
        <div class="field w3"><label>Wiedervorlage-Datum</label><input type="date" data-k="${k.id}" data-f="followUpDatum"></div>
        <div class="field w6"><label>Thema (Wiedervorlage)</label><input data-k="${k.id}" data-f="followUpThema" placeholder="Thema / Beschreibungsfeld"></div>
        <div class="field w3"><label>Erledigt</label>
          <div style="display:flex; align-items:center; gap:10px; padding:10px 12px; border:1px solid rgba(11,27,51,.16); border-radius:14px; background:rgba(255,255,255,.92);">
            <input type="checkbox" data-k="${k.id}" data-f="followUpErledigt" style="width:auto; transform:scale(1.2);">
            <span class="muted">Wiedervorlage erledigt</span>
          </div>
        </div>
      `;
      box.appendChild(row2);

      const row3 = document.createElement("div");
      row3.className = "row";
      row3.style.marginTop = "10px";
      row3.innerHTML = `<button class="danger" data-del-k="${k.id}">Kontakt l√∂schen</button>`;
      box.appendChild(row3);

      wrap.appendChild(box);

      box.querySelectorAll("input[data-k]").forEach(inp => {
        const fid = inp.getAttribute("data-f");
        if (inp.type === "checkbox") inp.checked = !!k[fid];
        else inp.value = k[fid] || "";
      });

      box.querySelectorAll("input[data-k]").forEach(inp => {
        inp.oninput = () => {
          const rid = inp.getAttribute("data-k");
          const fid = inp.getAttribute("data-f");
          const kk = r.kontakte.find(x => x.id === rid);
          if (!kk) return;
          if (inp.type === "checkbox") kk[fid] = !!inp.checked;
          else kk[fid] = inp.value;
          kk.updatedAt = nowISO();
          touch(r);
          renderFollowupsGlobal();
        };
        inp.onchange = inp.oninput;
      });

      box.querySelectorAll("button[data-del-k]").forEach(btn => {
        btn.onclick = () => {
          if (!confirm("Kontakt wirklich l√∂schen?")) return;
          r.kontakte = r.kontakte.filter(x => x.id !== btn.getAttribute("data-del-k"));
          if (r.kontakte.length === 0){
            r.kontakte.push({ id: uid(), datum: todayISO(), anlass:"", notiz:"", followUpDatum:"", followUpThema:"", followUpErledigt:false, createdAt: nowISO(), updatedAt: nowISO() });
          }
          touch(r);
          renderForm();
          renderFollowupsGlobal();
        };
      });
    });
  }

  function renderCustomFields(){
    const ps = getActivePartnerState();
    const r = getActiveRecord();
    const wrap = $("customFieldsWrap");
    wrap.innerHTML = "";

    if (!ps.customFields.length){
      wrap.innerHTML = `<div class="muted">Keine Zusatzfelder f√ºr diesen Partner angelegt.</div>`;
      return;
    }

    const row = document.createElement("div");
    row.className = "row";

    ps.customFields.forEach(cf => {
      const f = document.createElement("div");
      f.className = "field w6";
      f.innerHTML = `<label>${escapeHTML(cf.label)}</label>`;
      const id = "cf_"+cf.id;

      if (cf.type === "checkbox"){
        const container = document.createElement("div");
        container.style.display="flex";
        container.style.alignItems="center";
        container.style.gap="10px";
        container.style.padding="10px 12px";
        container.style.border="1px solid rgba(11,27,51,.16)";
        container.style.borderRadius="14px";
        container.style.background="rgba(255,255,255,.92)";
        container.innerHTML = `<input type="checkbox" id="${id}" style="width:auto; transform:scale(1.2);">
                               <span class="muted">Ja / Nein</span>`;
        f.appendChild(container);
        const el = container.querySelector("input");
        el.checked = !!r.custom[cf.id];
        el.onchange = () => { r.custom[cf.id] = !!el.checked; touch(r); };
      } else if (cf.type === "textarea"){
        const el = document.createElement("textarea");
        el.id = id;
        el.value = r.custom[cf.id] || "";
        el.oninput = () => { r.custom[cf.id] = el.value; touch(r); };
        f.appendChild(el);
      } else {
        const el = document.createElement("input");
        el.id = id;
        el.value = r.custom[cf.id] || "";
        el.oninput = () => { r.custom[cf.id] = el.value; touch(r); };
        f.appendChild(el);
      }

      row.appendChild(f);
    });

    wrap.appendChild(row);
  }

  function escapeHTML(s){
    return (s||"").replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c]));
  }

  // ========= Search =========
  function normalize(s){ return (s||"").toString().toLowerCase().trim(); }

  function buildSearchText(p, r){
    const parts = [];
    parts.push(p.name, r.rolle, r.partnerNummer, r.makNummer, r.datum);
    parts.push(r.vorname, r.nachname, r.name, r.firma, r.email, r.mobil, r.telefon, r.strasse, r.plz, r.ort, r.land);
    parts.push(r.freiesFeld);
    (r.kontakte || []).forEach(k => parts.push(k.datum, k.anlass, k.notiz, k.followUpDatum, k.followUpThema, k.followUpErledigt ? "erledigt" : "offen"));
    return normalize(parts.filter(Boolean).join(" | "));
  }

  function showResults(){
    const q = normalize($("q").value);
    const tb = $("resultsTbody");
    tb.innerHTML = "";

    const hits = [];
    PARTNERS.forEach(p => {
      const ps = getPartnerState(p.key);
      ps.records.forEach((r, idx) => {
        const txt = buildSearchText(p, r);
        if (!q || txt.includes(q)) hits.push({ p, r, idx });
      });
    });

    hits.slice(0, 400).forEach(h => {
      const tr = document.createElement("tr");
      const nameShown = ((h.r.vorname||"").trim()+" "+(h.r.nachname||"").trim()).trim() || h.r.name || "";
      tr.innerHTML = `
        <td>${escapeHTML(h.p.name)}</td>
        <td><a href="#" data-open="1">${escapeHTML(recordLabel(h.p, h.r, h.idx))}</a></td>
        <td>${escapeHTML(h.r.rolle||"")}</td>
        <td>${escapeHTML(h.p.hasMak ? (h.r.makNummer||"") : "")}</td>
        <td>${escapeHTML(h.r.partnerNummer||"")}</td>
        <td>${escapeHTML(nameShown)}</td>
        <td>${escapeHTML(h.r.firma||"")}</td>
        <td>${escapeHTML(h.r.email||"")}</td>
        <td>${escapeHTML([h.r.telefon,h.r.mobil].filter(Boolean).join(" / "))}</td>
        <td>${escapeHTML(h.r.ort||"")}</td>
      `;
      tr.querySelector('a[data-open="1"]').onclick = (e) => {
        e.preventDefault();
        ACTIVE_PARTNER_KEY = h.p.key;
        document.body.setAttribute("data-partner", h.p.key);
        const ps = getPartnerState(h.p.key);
        ps.activeRecordId = h.r.id;
        saveDB(DB);
        $("resultsCard").classList.add("hidden");
        showPage("main");
        renderAll();
      };
      tb.appendChild(tr);
    });

    $("resultsCard").classList.remove("hidden");
  }

  // ========= Global Followups =========
  function parseDateISO(s){
    if (!s) return null;
    const t = Date.parse(s);
    return Number.isFinite(t) ? t : null;
  }

  function renderFollowupsGlobal(){
    const tb = $("followupsTbody");
    tb.innerHTML = "";

    const items = [];
    PARTNERS.forEach(p => {
      const ps = getPartnerState(p.key);
      ps.records.forEach((r, ridx) => {
        (r.kontakte || []).forEach((k, kidx) => {
          if (k.followUpDatum && !k.followUpErledigt){
            items.push({
              due: k.followUpDatum,
              dueT: parseDateISO(k.followUpDatum) || 9e15,
              partner: p,
              record: r,
              ridx,
              k,
              kidx
            });
          }
        });
      });
    });

    items.sort((a,b) => a.dueT - b.dueT);

    if (!items.length){
      const tr = document.createElement("tr");
      tr.innerHTML = `<td colspan="7" class="muted">Keine offenen Wiedervorlagen.</td>`;
      tb.appendChild(tr);
      return;
    }

    items.slice(0, 500).forEach(it => {
      const nameShown = ((it.record.vorname||"").trim()+" "+(it.record.nachname||"").trim()).trim() || it.record.name || "";
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td><b>${escapeHTML(it.due)}</b></td>
        <td>${escapeHTML(it.partner.name)}</td>
        <td><a href="#" data-open="1">${escapeHTML(recordLabel(it.partner, it.record, it.ridx))}</a></td>
        <td>Kontakt ${it.kidx+1}${nameShown ? " ¬∑ "+escapeHTML(nameShown) : ""}</td>
        <td>${escapeHTML(it.k.anlass||"")}</td>
        <td>${escapeHTML(it.k.followUpThema||"")}</td>
        <td>${escapeHTML(it.k.notiz||"")}</td>
      `;
      tr.querySelector('a[data-open="1"]').onclick = (e) => {
        e.preventDefault();
        ACTIVE_PARTNER_KEY = it.partner.key;
        document.body.setAttribute("data-partner", it.partner.key);
        const ps = getPartnerState(it.partner.key);
        ps.activeRecordId = it.record.id;
        saveDB(DB);
        showPage("main");
        renderAll();
      };
      tb.appendChild(tr);
    });
  }

  // ========= Helpers =========
  async function copyToClipboard(text){
    try{ await navigator.clipboard.writeText(text || ""); }
    catch(e){
      const ta = document.createElement("textarea");
      ta.value = text || "";
      document.body.appendChild(ta);
      ta.select();
      document.execCommand("copy");
      document.body.removeChild(ta);
    }
  }

  function toast(msg, kind="ok"){
    setStatus(msg, kind==="ok"?"ok":kind==="warn"?"warn":"bad");
    setTimeout(()=>setStatus("bereit",""), 2000);
  }

  // ========= Bind main inputs =========
  function bindMainInputs(){
    $("rolle").oninput = () => { const r=getActiveRecord(); r.rolle=$("rolle").value; touch(r); renderRecordSelect(); };
    $("partnerNummer").oninput = () => { const r=getActiveRecord(); r.partnerNummer=$("partnerNummer").value; touch(r); };
    $("datum").onchange = () => { const r=getActiveRecord(); r.datum=$("datum").value; touch(r); renderRecordSelect(); renderFollowupsGlobal(); };
    $("mak").oninput = () => { const r=getActiveRecord(); r.makNummer=$("mak").value; touch(r); renderRecordSelect(); };

    $("vorname").oninput = () => { const r=getActiveRecord(); r.vorname=$("vorname").value; r.name=`${(r.vorname||"").trim()} ${(r.nachname||"").trim()}`.trim(); touch(r); renderRecordSelect(); };
    $("nachname").oninput = () => { const r=getActiveRecord(); r.nachname=$("nachname").value; r.name=`${(r.vorname||"").trim()} ${(r.nachname||"").trim()}`.trim(); touch(r); renderRecordSelect(); };

    $("firma").oninput = () => { const r=getActiveRecord(); r.firma=$("firma").value; touch(r); };
    $("email").oninput = () => { const r=getActiveRecord(); r.email=$("email").value; touch(r); };
    $("mobil").oninput = () => { const r=getActiveRecord(); r.mobil=$("mobil").value; touch(r); };
    $("telefon").oninput = () => { const r=getActiveRecord(); r.telefon=$("telefon").value; touch(r); };
    $("strasse").oninput = () => { const r=getActiveRecord(); r.strasse=$("strasse").value; touch(r); };
    $("plz").oninput = () => { const r=getActiveRecord(); r.plz=$("plz").value; touch(r); };
    $("ort").oninput = () => { const r=getActiveRecord(); r.ort=$("ort").value; touch(r); };
    $("land").oninput = () => { const r=getActiveRecord(); r.land=$("land").value; touch(r); };

    $("favorit").onchange = () => { const r=getActiveRecord(); r.favorit=!!$("favorit").checked; touch(r); renderRecordSelect(); };
    $("optin").onchange = () => { const r=getActiveRecord(); r.optin=!!$("optin").checked; touch(r); };
    $("online").onchange = () => { const r=getActiveRecord(); r.onlineAbschluss=!!$("online").checked; touch(r); };

    $("freiesFeld").oninput = () => { const r=getActiveRecord(); r.freiesFeld=$("freiesFeld").value; touch(r); };

    $("btnAddContact").onclick = () => {
      const r=getActiveRecord();
      r.kontakte.push({ id: uid(), datum: todayISO(), anlass:"", notiz:"", followUpDatum:"", followUpThema:"", followUpErledigt:false, createdAt: nowISO(), updatedAt: nowISO() });
      touch(r);
      renderContacts();
      renderFollowupsGlobal();
    };

    $("btnCopyAddress").onclick = async () => {
      const r=getActiveRecord();
      const txt = [r.firma, r.strasse, `${r.plz} ${r.ort}`.trim(), r.land].filter(Boolean).join("\n");
      await copyToClipboard(txt);
      toast("Adresse kopiert");
    };
    $("btnCopyPhone").onclick = async () => {
      const r=getActiveRecord();
      const txt = [r.telefon, r.mobil].filter(Boolean).join(" / ");
      await copyToClipboard(txt);
      toast("Tel/Mobil kopiert");
    };
    $("btnCall").onclick = () => {
      const r=getActiveRecord();
      const num = (r.telefon || r.mobil || "").replace(/\s+/g,"");
      if (!num) return toast("Keine Nummer vorhanden", "warn");
      window.location.href = "tel:"+num;
    };
    $("btnMail").onclick = () => {
      const r=getActiveRecord();
      if (!r.email) return toast("Keine E-Mail vorhanden", "warn");
      window.location.href = "mailto:"+encodeURIComponent(r.email);
    };
  }

  // ========= Records CRUD =========
  function addRecord(){
    const p = getActivePartner();
    const ps = getActivePartnerState();
    const r = baseRecord(p);
    ps.records.push(r);
    ps.activeRecordId = r.id;
    saveDB(DB);
    renderAll();
  }

  function deleteRecord(){
    const ps = getActivePartnerState();
    if (ps.records.length <= 1){
      alert("Mindestens ein Reiter muss bestehen bleiben.");
      return;
    }
    const r = getActiveRecord();
    if (!confirm("Reiter wirklich l√∂schen?")) return;
    ps.records = ps.records.filter(x => x.id !== r.id);
    ps.activeRecordId = ps.records[0].id;
    saveDB(DB);
    renderAll();
  }

  // ========= Custom fields =========
  function addCustomField(){
    const ps = getActivePartnerState();
    const label = prompt("Feldname (Label):");
    if (!label) return;
    const type = prompt('Typ: "text" | "textarea" | "checkbox"', "text");
    const t = (type||"text").toLowerCase().trim();
    const allowed = ["text","textarea","checkbox"];
    const finalType = allowed.includes(t) ? t : "text";
    ps.customFields.push({ id: uid(), label: label.trim(), type: finalType });
    saveDB(DB);
    renderAll();
  }

  function deleteCustomField(){
    const ps = getActivePartnerState();
    if (!ps.customFields.length){
      alert("Keine Zusatzfelder vorhanden.");
      return;
    }
    const names = ps.customFields.map((c,i)=>`${i+1}: ${c.label} (${c.type})`).join("\n");
    const pick = prompt("Welche Nummer l√∂schen?\n"+names, "1");
    const n = parseInt(pick,10);
    if (!Number.isFinite(n) || n<1 || n>ps.customFields.length) return;
    const cf = ps.customFields[n-1];
    if (!confirm(`Feld "${cf.label}" wirklich l√∂schen? Werte in Datens√§tzen gehen verloren.`)) return;

    ps.customFields = ps.customFields.filter(x => x.id !== cf.id);
    ps.records.forEach(r => { if (r.custom && cf.id in r.custom) delete r.custom[cf.id]; });
    saveDB(DB);
    renderAll();
  }

  // ========= CSV Export =========
  function csvCell(v){
    const s = (v===null||v===undefined) ? "" : String(v);
    if (/[;"\n\r]/.test(s)) return `"${s.replace(/"/g,'""')}"`;
    return s;
  }

  function downloadBlob(filename, blob){
    const a = document.createElement("a");
    a.href = URL.createObjectURL(blob);
    a.download = filename;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(a.href);
  }

  function exportCSV(){
    const rows = [];
    const header = [
      "partner","reiter","datum","rolle","partnerNummer","mak",
      "favorit","vorname","nachname","firma","email","mobil","telefon",
      "strasse","plz","ort","land","optin","onlineAbschluss",
      "kontakte_count","naechste_wiedervorlage"
    ];
    rows.push(header);

    PARTNERS.forEach(p=>{
      const ps = getPartnerState(p.key);
      ps.records.forEach((r, idx)=>{
        const next = (r.kontakte||[])
          .filter(k=>k.followUpDatum && !k.followUpErledigt)
          .map(k=>k.followUpDatum)
          .sort()[0] || "";
        const line = [
          p.name,
          recordLabel(p,r,idx),
          r.datum||"",
          r.rolle||"",
          r.partnerNummer||"",
          p.hasMak ? (r.makNummer||"") : "",
          r.favorit ? "Ja":"Nein",
          r.vorname||"",
          r.nachname||"",
          r.firma||"",
          r.email||"",
          r.mobil||"",
          r.telefon||"",
          r.strasse||"",
          r.plz||"",
          r.ort||"",
          r.land||"",
          r.optin ? "Ja":"Nein",
          r.onlineAbschluss ? "Ja":"Nein",
          String((r.kontakte||[]).length),
          next
        ];
        rows.push(line);
      });
    });

    const csv = rows.map(r=>r.map(csvCell).join(";")).join("\n");
    const blob = new Blob([csv], {type:"text/csv;charset=utf-8"});
    downloadBlob("vertriebspartner_export.csv", blob);
  }

  // ========= Exports (Delta / Full / SAFE Full) =========
  function exportFull(){
    const blob = new Blob([JSON.stringify(DB, null, 2)], {type:"application/json"});
    downloadBlob("vertriebspartner_backup_full.json", blob);
  }

  function exportDelta(){
    const day = todayISO();
    const delta = { app: APP_NAME, format: "VP_DELTA", version: DB.version, exportedAt: nowISO(), kind:"delta", partners:{} };

    PARTNERS.forEach(p=>{
      const ps = getPartnerState(p.key);
      const recs = ps.records.filter(r => (r.updatedAt||"").slice(0,10) === day);
      if (recs.length){
        delta.partners[p.key] = {
          key: p.key,
          customFields: ps.customFields,
          records: recs,
          activeRecordId: ps.activeRecordId
        };
      }
    });

    const blob = new Blob([JSON.stringify(delta, null, 2)], {type:"application/json"});
    downloadBlob(`vertriebspartner_delta_${day}.json`, blob);
  }

  // simple hash (not crypto) to detect "wrong file" / corruption
  function quickHash(str){
    let h = 2166136261;
    for (let i=0;i<str.length;i++){
      h ^= str.charCodeAt(i);
      h = Math.imul(h, 16777619);
    }
    return (h>>>0).toString(16);
  }

  function exportSafeFull(){
    const payload = DB;
    const payloadStr = JSON.stringify(payload);
    const safe = {
      format: APP_FORMAT,
      app: APP_NAME,
      build: APP_BUILD,
      createdAt: nowISO(),
      createdBy: sessionUserSafe(),
      storageKey: STORAGE_KEY,
      payloadHash: quickHash(payloadStr),
      payload
    };
    const blob = new Blob([JSON.stringify(safe, null, 2)], {type:"application/json"});
    downloadBlob(`SAFE_full_${todayISO()}.json`, blob);
  }

  // ========= IMPORT (FIXED) =========
  async function readFiles(fileList){
    const files = Array.from(fileList || []);
    const arr = [];
    for (const f of files){
      const text = await f.text();
      const json = safeJSONParse(text);
      arr.push({ name:f.name, text, json });
    }
    return arr;
  }

  function unwrapIfSafe(json){
    if (json && json.format === APP_FORMAT && json.payload){
      // verify hash
      const str = JSON.stringify(json.payload);
      const h = quickHash(str);
      if (json.payloadHash && json.payloadHash !== h){
        throw new Error("SAFE-Datei besch√§digt oder ver√§ndert (Hash stimmt nicht).");
      }
      return json.payload;
    }
    return json;
  }

  function mergeIncomingIntoDB(incoming){
    // incoming can be full DB or delta with partners subset
    const incPartners = incoming.partners || {};
    PARTNERS.forEach(p=>{
      const inc = incPartners[p.key];
      if (!inc) return;

      const ps = getPartnerState(p.key);

      // custom fields merge
      const byId = new Map(ps.customFields.map(c=>[c.id,c]));
      (inc.customFields || []).forEach(c=>{
        if (!byId.has(c.id)) { ps.customFields.push(c); byId.set(c.id,c); }
      });

      // records merge by id + updatedAt
      const localById = new Map(ps.records.map(r=>[r.id,r]));
      (inc.records || []).forEach(rIn=>{
        const rLocal = localById.get(rIn.id);
        if (!rLocal){
          ps.records.push(rIn);
          localById.set(rIn.id, rIn);
        } else {
          const tL = Date.parse(rLocal.updatedAt||"") || 0;
          const tI = Date.parse(rIn.updatedAt||"") || 0;
          if (tI >= tL) Object.assign(rLocal, rIn);
        }
      });

      ps.activeRecordId ||= (ps.records[0] && ps.records[0].id);
    });

    DB = ensureSchema(DB);
    saveDB(DB);
  }

  function replaceDB(incomingDB){
    DB = ensureSchema(incomingDB);
    saveDB(DB);
  }

  async function importMerge(files){
    const arr = await readFiles(files);
    for (const f of arr){
      if (!f.json) { alert(`Ung√ºltiges JSON: ${f.name}`); continue; }
      let incoming;
      try{
        incoming = unwrapIfSafe(f.json);
      }catch(e){
        alert(`Import abgebrochen: ${f.name}\n${e.message}`);
        continue;
      }

      // detect types
      if (incoming && incoming.format === "VP_DB" && incoming.partners){
        // full DB
        mergeIncomingIntoDB(incoming);
      } else if (incoming && incoming.format === "VP_DELTA" && incoming.partners){
        // delta
        mergeIncomingIntoDB(incoming);
      } else if (incoming && incoming.partners){
        // older full backup (v2)
        mergeIncomingIntoDB(incoming);
      } else {
        alert(`Datei nicht erkannt: ${f.name}`);
      }
    }
    toast("Import/Merge erledigt", "ok");
    renderAll();
  }

  async function importReplace(files){
    if (!confirm("IMPORT (REPLACE): Dadurch wird deine lokale Datenbank komplett durch die Datei ersetzt. Fortfahren?")) return;

    const arr = await readFiles(files);
    if (!arr.length) return;

    // take first file only
    const f = arr[0];
    if (!f.json) return alert("Ung√ºltiges JSON.");

    let incoming;
    try{
      incoming = unwrapIfSafe(f.json);
    }catch(e){
      return alert(`Import abgebrochen:\n${e.message}`);
    }

    if (incoming && incoming.partners){
      replaceDB(incoming);
      toast("Replace-Import erfolgreich", "ok");
      renderAll();
    } else {
      alert("Datei enth√§lt keine g√ºltige DB.");
    }
  }

  // ========= Bind global actions =========
  function bindAllInputs(){
    $("btnPrint").onclick = () => window.print();
    $("btnLogout").onclick = () => setSession(null);

    $("btnNewTab").onclick = () => addRecord();
    $("btnDeleteTab").onclick = () => deleteRecord();

    $("recordSelect").onchange = (e) => {
      const ps = getActivePartnerState();
      ps.activeRecordId = e.target.value;
      saveDB(DB);
      renderAll();
    };

    $("btnNewField").onclick = () => addCustomField();
    $("btnDeleteField").onclick = () => deleteCustomField();

    $("btnExportDelta").onclick = () => exportDelta();
    $("btnExportFull").onclick = () => exportFull();
    $("btnExportSafeFull").onclick = () => exportSafeFull();
    $("btnExportCSV").onclick = () => exportCSV();

    $("btnImportMerge").onclick = () => { $("fileImport").dataset.mode = "merge"; $("fileImport").click(); };
    $("btnImportReplace").onclick = () => { $("fileImport").dataset.mode = "replace"; $("fileImport").click(); };

    $("fileImport").onchange = async (e) => {
      const mode = $("fileImport").dataset.mode || "merge";
      const files = e.target.files;
      if (mode === "replace") await importReplace(files);
      else await importMerge(files);
      e.target.value = "";
    };

    $("btnFind").onclick = () => showResults();
    $("btnCloseResults").onclick = () => $("resultsCard").classList.add("hidden");
    $("btnCloseResults2").onclick = () => $("resultsCard").classList.add("hidden");

    $("tabMain").onclick = () => showPage("main");
    $("tabStats").onclick = () => showPage("stats");
  }

  // ========= Pages =========
  function showPage(which){
    const main = $("mainCard");
    const stats = $("statsCard");
    if (which === "stats"){
      $("tabMain").classList.remove("active");
      $("tabStats").classList.add("active");
      main.classList.add("hidden");
      stats.classList.remove("hidden");
      renderFollowupsGlobal();
    } else {
      $("tabStats").classList.remove("active");
      $("tabMain").classList.add("active");
      stats.classList.add("hidden");
      main.classList.remove("hidden");
    }
  }

  function renderAll(){
    DB = loadDB();

    const sess = getSession();
    const loggedIn = !!sess;
    $("who").textContent = loggedIn ? `${sess.user} (${sess.role})` : "nicht eingeloggt";

    $("loginCard").classList.toggle("hidden", loggedIn);
    $("navCard").classList.toggle("hidden", !loggedIn);
    $("mainCard").classList.toggle("hidden", !loggedIn);

    $("statsCard").classList.add("hidden");
    $("tabMain").classList.add("active");
    $("tabStats").classList.remove("active");

    if (!loggedIn){ setStatus("bereit", ""); return; }

    setStatus("eingeloggt", "ok");
    document.body.setAttribute("data-partner", ACTIVE_PARTNER_KEY);

    renderPartnerTabs();
    renderRecordSelect();
    renderForm();
    renderFollowupsGlobal();
  }

  // ========= Init =========
  initLoginUI();
  bindAllInputs();
  bindMainInputs();
  renderAll();
})();
</script>
</body>
</html>
